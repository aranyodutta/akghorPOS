<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>AK Ghor POS — Tablet Display</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+Bengali:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    :root {
      --brand: #b1000d;
      --ink: #333333;
      --muted: #6b6b6f;
      --panel: #f5f5f7;
      --card: #ffffff;
      --shadow: 0 18px 40px rgba(31, 41, 55, 0.12);
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: var(--panel);
      color: var(--ink);
      font-family: 'Roboto', 'Noto Sans Bengali', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      position: relative;
    }

    .page {
      position: relative;
      display: flex;
      flex-direction: row;
      gap: 16px;
      height: 100vh;
      width: 100vw;
      padding: calc(16px + env(safe-area-inset-top)) calc(24px + env(safe-area-inset-right)) calc(24px + env(safe-area-inset-bottom)) calc(24px + env(safe-area-inset-left));
    }

    .card {
      background: var(--card);
      border-radius: 28px;
      box-shadow: var(--shadow);
      padding: clamp(20px, 3vw, 36px);
      display: flex;
      flex-direction: column;
      min-height: 0;
      height: 100%;
    }

    .order-card {
      flex: 6;
    }

    .payment-card {
      flex: 4;
      align-items: center;
      text-align: center;
      gap: clamp(16px, 2vw, 24px);
    }

    .order-header {
      display: flex;
      flex-direction: column;
    }

    .order-header h2 {
      margin: 0;
      font-size: clamp(2rem, 4vw, 3rem);
      color: var(--brand);
      font-weight: 700;
    }

    .last-update {
      margin-top: clamp(6px, 1vw, 10px);
      font-size: clamp(0.85rem, 1.2vw, 1rem);
      color: var(--muted);
    }

    .order-meta {
      margin-top: clamp(12px, 1.6vw, 18px);
      font-size: clamp(1.1rem, 2vw, 1.6rem);
      font-weight: 500;
      min-height: 1.5em;
    }

    .order-items {
      margin-top: clamp(18px, 2vw, 24px);
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      display: flex;
      flex-direction: column;
      gap: clamp(12px, 1.8vw, 18px);
      padding-right: 6px;
    }

    .order-item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
    }

    .item-info {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .item-name {
      font-size: clamp(1.2rem, 2.3vw, 1.8rem);
      font-weight: 600;
    }

    .item-meta {
      font-size: clamp(1rem, 1.7vw, 1.3rem);
      color: var(--muted);
    }

    .item-total {
      font-size: clamp(1.2rem, 2vw, 1.6rem);
      font-weight: 600;
    }

    .order-totals {
      margin-top: clamp(18px, 2vw, 24px);
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: clamp(1.1rem, 1.8vw, 1.4rem);
    }

    .order-totals .row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 24px;
    }

    .order-totals .label {
      color: var(--muted);
    }

    .order-totals .grand {
      font-weight: 700;
      font-size: clamp(1.3rem, 2.2vw, 1.8rem);
      color: var(--brand);
    }

    .payment-header {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .payment-logo {
      width: clamp(140px, 18vw, 220px);
      height: auto;
      display: none;
    }

    .payment-mode-label {
      font-size: clamp(1.8rem, 3.2vw, 2.6rem);
      font-weight: 700;
      letter-spacing: 0.08em;
      display: none;
    }

    .payment-amount {
      width: 100%;
      font-size: clamp(2.4rem, 6vw, 4.6rem);
      font-weight: 700;
      color: var(--brand);
      margin-top: clamp(12px, 2vw, 18px);
    }

    .payment-memo {
      font-size: clamp(1rem, 1.7vw, 1.3rem);
      color: var(--muted);
    }

    .qr-area {
      position: relative;
      width: min(70%, 320px);
      aspect-ratio: 1 / 1;
      margin: clamp(12px, 2vw, 18px) auto;
      border-radius: 20px;
      background: #f0f0f2;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .qr-area img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
    }

    .qr-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      font-size: clamp(1rem, 1.6vw, 1.3rem);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .payment-breakdown {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: clamp(1.05rem, 1.8vw, 1.35rem);
    }

    .payment-breakdown .row {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      width: 100%;
    }

    .payment-breakdown .label {
      color: var(--muted);
    }

    .payment-breakdown .grand {
      font-weight: 700;
      color: var(--brand);
    }

    .idle-state {
      position: absolute;
      inset: calc(16px + env(safe-area-inset-top)) calc(24px + env(safe-area-inset-right)) calc(24px + env(safe-area-inset-bottom)) calc(24px + env(safe-area-inset-left));
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 24px;
      text-align: center;
      background: var(--panel);
      border-radius: 32px;
      font-size: clamp(1.4rem, 2.4vw, 2rem);
      color: var(--muted);
    }

    body.idle .idle-state {
      display: flex;
    }

    body.idle .order-card,
    body.idle .payment-card {
      display: none;
    }

    .idle-title {
      font-size: clamp(2rem, 4vw, 3rem);
      font-weight: 600;
      color: var(--brand);
    }

    .idle-subtitle {
      font-size: clamp(1.2rem, 2vw, 1.6rem);
      color: var(--muted);
    }

    .fullscreen-button {
      position: absolute;
      left: calc(24px + env(safe-area-inset-left));
      bottom: calc(24px + env(safe-area-inset-bottom));
      padding: 12px 18px;
      border-radius: 999px;
      border: none;
      background: rgba(255, 255, 255, 0.85);
      color: var(--ink);
      font-size: clamp(0.95rem, 1.6vw, 1.2rem);
      font-weight: 500;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.18);
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .fullscreen-button:hover {
      background: rgba(255, 255, 255, 0.95);
      transform: translateY(-2px);
    }

    .fullscreen-button.hidden {
      display: none;
    }

    .branding {
      position: absolute;
      right: calc(24px + env(safe-area-inset-right));
      bottom: calc(24px + env(safe-area-inset-bottom));
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: clamp(0.9rem, 1.4vw, 1.1rem);
      color: var(--muted);
    }

    .branding img {
      height: clamp(18px, 2.2vw, 26px);
      width: auto;
    }

    @media (max-width: 1080px) {
      .page {
        gap: 12px;
        padding: calc(12px + env(safe-area-inset-top)) calc(16px + env(safe-area-inset-right)) calc(18px + env(safe-area-inset-bottom)) calc(16px + env(safe-area-inset-left));
      }

      .card {
        border-radius: 22px;
      }

      .fullscreen-button,
      .branding {
        bottom: calc(16px + env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body class="idle">
  <div class="page" role="main">
    <div class="card order-card" aria-live="polite">
      <div class="order-header">
        <h2>Current Order</h2>
        <div class="last-update" id="last-update">Last update: —</div>
        <div class="order-meta" id="order-meta">Waiting for next order</div>
      </div>
      <div class="order-items" id="order-items" aria-label="Order items"></div>
      <div class="order-totals" id="order-totals"></div>
    </div>

    <div class="card payment-card" aria-live="polite">
      <div class="payment-header">
        <img id="payment-logo" class="payment-logo" src="https://i.postimg.cc/v4407Z6z/Zelle-payment-service-Logo-wine-1.png" alt="Zelle payment logo" />
        <div id="payment-mode" class="payment-mode-label">CASH</div>
      </div>
      <div class="payment-amount" id="payment-amount">$0.00</div>
      <div class="payment-memo" id="payment-memo">Memo: —</div>
      <div class="qr-area" id="qr-area">
        <img id="qr-image" alt="Payment QR code" />
        <div class="qr-placeholder" id="qr-placeholder">QR</div>
      </div>
      <div class="payment-breakdown" id="payment-breakdown"></div>
    </div>

    <div class="idle-state" aria-live="polite">
      <div class="idle-title">AK Ghor POS Display</div>
      <div class="idle-subtitle">Waiting for the next order…</div>
    </div>

    <button type="button" class="fullscreen-button" id="fullscreen-btn">Enter Full Screen</button>
    <div class="branding">
      <span>Powered by</span>
      <img src="https://i.postimg.cc/mhHz9cjj/SMALL-sm-logo-black-TEXT.png" alt="Stratford Meridian wordmark" />
    </div>
  </div>

  <script>
    (function () {
      const firebaseConfig = {
        apiKey: "AIzaSyDHoasqENlnp0zSAsz-3HfMkx4tgG-oZhA",
        authDomain: "akghorpos.firebaseapp.com",
        databaseURL: "https://akghorpos-default-rtdb.firebaseio.com",
        projectId: "akghorpos",
        storageBucket: "akghorpos.appspot.com",
        messagingSenderId: "791887148716",
        appId: "1:791887148716:web:5c8fb06053dcd6e5799109",
        measurementId: "G-7DE60HHEK8"
      };

      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const db = firebase.database();

      const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
      const orderMetaEl = document.getElementById('order-meta');
      const itemsEl = document.getElementById('order-items');
      const totalsEl = document.getElementById('order-totals');
      const paymentLogoEl = document.getElementById('payment-logo');
      const paymentModeEl = document.getElementById('payment-mode');
      const paymentAmountEl = document.getElementById('payment-amount');
      const paymentMemoEl = document.getElementById('payment-memo');
      const paymentBreakdownEl = document.getElementById('payment-breakdown');
      const qrAreaEl = document.getElementById('qr-area');
      const qrImageEl = document.getElementById('qr-image');
      const qrPlaceholderEl = document.getElementById('qr-placeholder');
      const lastUpdateEl = document.getElementById('last-update');

      function formatCents(value) {
        if (typeof value !== 'number') {
          return formatter.format(0);
        }
        return formatter.format(value / 100);
      }

      function formatTime(date) {
        if (!date) {
          return 'Last update: —';
        }
        const options = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
        return 'Last update: ' + new Intl.DateTimeFormat('en-US', options).format(date);
      }

      function resetPaymentView() {
        paymentLogoEl.style.display = 'none';
        paymentModeEl.style.display = 'none';
        paymentAmountEl.textContent = formatter.format(0);
        paymentMemoEl.textContent = 'Memo: —';
        paymentMemoEl.style.display = 'none';
        qrImageEl.removeAttribute('src');
        qrImageEl.style.display = 'none';
        qrPlaceholderEl.textContent = 'QR';
        qrPlaceholderEl.style.display = 'flex';
        qrAreaEl.style.display = 'flex';
        paymentBreakdownEl.innerHTML = '';
        paymentBreakdownEl.style.display = 'none';
      }

      function renderItems(items) {
        if (!Array.isArray(items) || items.length === 0) {
          itemsEl.innerHTML = '<div style="font-size: clamp(1.1rem, 1.9vw, 1.5rem); color: var(--muted);">No items in this order yet.</div>';
          return 0;
        }
        const fragment = document.createDocumentFragment();
        let computedSubtotal = 0;

        items.forEach(function (item) {
          const name = (item && item.name) ? String(item.name) : 'Item';
          const qty = Number(item && item.qty) || 0;
          const priceCents = Number(item && item.priceCents) || 0;
          const lineCents = qty * priceCents;
          computedSubtotal += lineCents;

          const wrapper = document.createElement('div');
          wrapper.className = 'order-item';

          const info = document.createElement('div');
          info.className = 'item-info';

          const nameEl = document.createElement('div');
          nameEl.className = 'item-name';
          nameEl.textContent = name;

          const metaEl = document.createElement('div');
          metaEl.className = 'item-meta';
          const unit = priceCents ? formatCents(priceCents) : formatter.format(0);
          metaEl.textContent = qty ? qty + ' × ' + unit : unit;

          info.appendChild(nameEl);
          info.appendChild(metaEl);

          const totalEl = document.createElement('div');
          totalEl.className = 'item-total';
          totalEl.textContent = formatCents(lineCents);

          wrapper.appendChild(info);
          wrapper.appendChild(totalEl);
          fragment.appendChild(wrapper);
        });

        itemsEl.innerHTML = '';
        itemsEl.appendChild(fragment);
        return computedSubtotal;
      }

      function renderTotals(totals, fallbackSubtotal, mode) {
        totalsEl.innerHTML = '';
        if (!totals && fallbackSubtotal === 0) {
          return;
        }

        const subtotalCents = (totals && typeof totals.subtotalCents === 'number') ? totals.subtotalCents : fallbackSubtotal;
        const feeCents = (mode === 'zelle' && totals && typeof totals.zelleFeeCents === 'number') ? totals.zelleFeeCents : 0;
        const totalCents = (totals && typeof totals.totalCents === 'number') ? totals.totalCents : (subtotalCents + feeCents);

        const rows = [];
        if (mode === 'zelle' && feeCents > 0) {
          rows.push({ label: 'Subtotal', value: formatCents(subtotalCents), highlight: false });
          rows.push({ label: 'Zelle Fee', value: formatCents(feeCents), highlight: false });
          rows.push({ label: 'Total', value: formatCents(totalCents), highlight: true });
        } else {
          rows.push({ label: 'Total', value: formatCents(totalCents), highlight: true });
        }

        rows.forEach(function (row) {
          const wrapper = document.createElement('div');
          wrapper.className = 'row';

          const label = document.createElement('div');
          label.className = 'label' + (row.highlight ? ' grand' : '');
          label.textContent = row.label;

          const value = document.createElement('div');
          value.className = row.highlight ? 'grand' : '';
          value.textContent = row.value;

          wrapper.appendChild(label);
          wrapper.appendChild(value);
          totalsEl.appendChild(wrapper);
        });
      }

      function renderPaymentSection(data, totalCents) {
        const mode = (data && data.paymentMode) ? String(data.paymentMode).toLowerCase() : '';
        const orderNumber = (data && (data.orderNumber || data.orderNumber === 0)) ? data.orderNumber : '';

        resetPaymentView();
        paymentAmountEl.textContent = formatCents(totalCents);

        if (mode === 'zelle') {
          paymentLogoEl.style.display = 'block';
          paymentModeEl.style.display = 'none';
          paymentMemoEl.style.display = 'block';
          paymentMemoEl.textContent = 'Memo: ' + (orderNumber !== '' ? orderNumber : '—');
          qrAreaEl.style.display = 'flex';

          const zelleInfo = data && data.zelle ? data.zelle : null;
          const accountCode = zelleInfo && zelleInfo.accountCode ? String(zelleInfo.accountCode) : '';
          const qrUrl = zelleInfo && zelleInfo.qrUrl ? String(zelleInfo.qrUrl) : '';

          if (qrUrl) {
            qrImageEl.src = qrUrl;
            qrImageEl.alt = accountCode ? 'Zelle QR code for account ' + accountCode : 'Zelle QR code';
            qrImageEl.style.display = 'block';
            qrPlaceholderEl.style.display = 'none';
          } else {
            qrPlaceholderEl.textContent = accountCode ? accountCode : 'QR unavailable';
            qrPlaceholderEl.style.display = 'flex';
            qrImageEl.style.display = 'none';
            if (qrImageEl.hasAttribute('src')) {
              qrImageEl.removeAttribute('src');
            }
          }

          const totals = data && data.totals ? data.totals : null;
          const feeCents = totals && typeof totals.zelleFeeCents === 'number' ? totals.zelleFeeCents : 0;
          const subtotalCents = totals && typeof totals.subtotalCents === 'number' ? totals.subtotalCents : null;
          const derivedSubtotal = subtotalCents !== null ? subtotalCents : Math.max(totalCents - feeCents, 0);

          paymentBreakdownEl.innerHTML = '';
          if (feeCents > 0) {
            paymentBreakdownEl.style.display = 'flex';
            const rows = [
              { label: 'Subtotal', value: formatCents(derivedSubtotal), highlight: false },
              { label: 'Zelle Fee', value: formatCents(feeCents), highlight: false },
              { label: 'Total', value: formatCents(totalCents), highlight: true }
            ];

            rows.forEach(function (row) {
              const wrapper = document.createElement('div');
              wrapper.className = 'row';

              const label = document.createElement('div');
              label.className = 'label' + (row.highlight ? ' grand' : '');
              label.textContent = row.label;

              const value = document.createElement('div');
              value.className = row.highlight ? 'grand' : '';
              value.textContent = row.value;

              wrapper.appendChild(label);
              wrapper.appendChild(value);
              paymentBreakdownEl.appendChild(wrapper);
            });
          } else {
            paymentBreakdownEl.style.display = 'none';
          }
        } else {
          paymentLogoEl.style.display = 'none';
          paymentModeEl.style.display = 'block';
          paymentModeEl.textContent = 'CASH';
          paymentMemoEl.style.display = 'none';
          qrAreaEl.style.display = 'none';
          qrPlaceholderEl.textContent = '';
          qrPlaceholderEl.style.display = 'none';
          qrImageEl.style.display = 'none';
          if (qrImageEl.hasAttribute('src')) {
            qrImageEl.removeAttribute('src');
          }
          paymentBreakdownEl.innerHTML = '';
          paymentBreakdownEl.style.display = 'none';
        }
      }

      function updateOrder(data) {
        const hasOrder = data && (data.orderNumber !== undefined || (Array.isArray(data.items) && data.items.length > 0));
        document.body.classList.toggle('idle', !hasOrder);
        document.body.classList.toggle('has-order', !!hasOrder);

        if (!hasOrder) {
          itemsEl.innerHTML = '';
          totalsEl.innerHTML = '';
          orderMetaEl.textContent = 'Waiting for next order';
          lastUpdateEl.textContent = formatTime(null);
          resetPaymentView();
          return;
        }

        const orderNumber = data.orderNumber !== undefined && data.orderNumber !== null ? data.orderNumber : '';
        const customerName = data.name ? String(data.name) : '';
        let meta = '';
        if (orderNumber !== '') {
          meta = 'Order #' + orderNumber;
        }
        if (customerName) {
          meta = meta ? meta + ' — ' + customerName : customerName;
        }
        orderMetaEl.textContent = meta || 'Order details';

        const subtotalFromItems = renderItems(Array.isArray(data.items) ? data.items : []);
        renderTotals(data.totals || null, subtotalFromItems, String(data.paymentMode || '').toLowerCase());

        let totalCents = 0;
        if (data.totals && typeof data.totals.totalCents === 'number') {
          totalCents = data.totals.totalCents;
        } else if (data.totals && typeof data.totals.subtotalCents === 'number') {
          const fee = data.totals && typeof data.totals.zelleFeeCents === 'number' ? data.totals.zelleFeeCents : 0;
          totalCents = data.totals.subtotalCents + fee;
        } else {
          totalCents = subtotalFromItems;
        }

        renderPaymentSection(data, totalCents);
      }

      function handleSnapshot(snapshot) {
        const value = snapshot.val();
        updateOrder(value);
        lastUpdateEl.textContent = formatTime(new Date());
      }

      const displayRef = db.ref('display');
      displayRef.on('value', handleSnapshot, function (error) {
        console.error('Unable to load display data', error);
      });

      const fullscreenButton = document.getElementById('fullscreen-btn');
      function isFullscreen() {
        return document.fullscreenElement || document.webkitFullscreenElement;
      }

      function updateFullscreenButton() {
        fullscreenButton.classList.toggle('hidden', !!isFullscreen());
      }

      fullscreenButton.addEventListener('click', function () {
        const root = document.documentElement;
        if (root.requestFullscreen) {
          root.requestFullscreen();
        } else if (root.webkitRequestFullscreen) {
          root.webkitRequestFullscreen();
        }
      });

      document.addEventListener('fullscreenchange', updateFullscreenButton);
      document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
      updateFullscreenButton();
    })();
  </script>
</body>
</html>
