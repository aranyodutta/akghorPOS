<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AK Ghor POS System — 2025</title>

  <!-- Firebase SDK v8 (compatible with your current project) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+Bengali:400,700|Roboto:400,700&display=swap" rel="stylesheet">

  <style>
    /* ========== Base Styles ========== */
    :root{
      --brand:#b8100d;
      --brand-dark:#a50e0c;
      --ink:#333;
      --bg:#ffffff;
      --panel:#f7f7f7;
      --muted:#f0f0f0;
      --ok:#17803d;
      --warn:#b26a00;
      --danger:#b8100d;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Roboto',sans-serif;
      background-color:var(--bg);
      margin:0;
      color:var(--ink);
    }
    .hide{display:none !important;}

    /* Top bar */
    .top-section{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 20px;
      background-color:var(--brand);
      color:#fff;
      gap:16px;
      flex-wrap:wrap;
    }
    .search{min-width:220px;flex:1 1 260px;max-width:420px}
    .search input{
      width:100%;
      padding:8px 10px;
      border-radius:6px;
      border:none;
      font-size:16px;
    }
    .day-switch{
      display:flex; gap:8px; align-items:center;
    }
    .day-switch button{
      padding:8px 12px;
      border:none; border-radius:6px; cursor:pointer;
      font-weight:bold;
      background:#fff2; color:#fff;
    }
    .day-switch button.active{ background:#fff; color:var(--brand); }

    .ticket-section{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    .ticket{display:flex;align-items:center;gap:6px}
    .ticket-label{
      background:#eee;color:#333;padding:6px 10px;border-radius:6px;font-weight:bold;font-size:14px;text-transform:capitalize
    }
    .ticket-label[data-color="purple"],
    .ticket-label.ticket-purple{background:#6f42c1;color:#fff}
    .ticket-label[data-color="red"],
    .ticket-label.ticket-red{background:#d6336c;color:#fff}
    .ticket-label[data-color="green"],
    .ticket-label.ticket-green{background:#2f9e44;color:#fff}
    .ticket-label[data-color="blue"],
    .ticket-label.ticket-blue{background:#1c7ed6;color:#fff}
    .ticket-label[data-color="yellow"]{background:#f4d03f;color:#6b4f00}
    .ticket-label[data-color="orange"]{background:#f39c12;color:#fff}
    .ticket-label[data-color="teal"]{background:#17a2b8;color:#fff}
    .ticket-label[data-color="pink"]{background:#e83e8c;color:#fff}
    .ticket-count{font-size:16px;color:#fff}

    /* Layout */
    .container{display:flex}
    .item-grid{
      flex:1;padding:20px;display:flex;flex-wrap:wrap;gap:12px;
      justify-content:flex-start;background:#f9f9f9;min-height:calc(100vh - 140px);
    }
    .menu-empty{width:100%;padding:60px 20px;text-align:center;color:#777;font-size:18px;display:flex;flex-direction:column;gap:14px;align-items:center;justify-content:center}
    .menu-empty button{padding:10px 16px;border:none;border-radius:8px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
    .menu-empty button:hover{background:var(--brand-dark)}
    .order-summary{
      width:360px;background:var(--panel);padding:20px;border-left:1px solid #ddd;position:relative;
    }
    .order-summary h2{margin:0 0 12px;font-size:22px}
    .order-item{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:10px;padding:8px 0;border-bottom:1px solid #e9e9e9
    }
    .order-item .delete-item{
      background:transparent;border:none;color:var(--danger);font-size:18px;cursor:pointer;padding:0 5px;
    }
    .total-amount{
      font-size:32px;font-weight:bold;color:var(--brand);margin-top:12px;text-align:center;
      display:flex;align-items:center;justify-content:center;gap:10px
    }
    .edit-total-icon{cursor:pointer;font-size:18px;color:#333}

    .payment-buttons{display:flex;gap:10px;margin-top:18px}
    .payment-buttons.cash-only{justify-content:center}
    .payment-buttons.cash-only .payment-button{flex:1}
    .payment-button{
      flex:1;padding:14px;background:var(--brand);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-size:18px
    }
    .payment-button:hover{background:var(--brand-dark)}
    .payment-button:disabled,
    .payment-button.is-disabled{
      opacity:.5;
      cursor:not-allowed;
      filter:grayscale(.35);
      background:var(--brand);
    }
    .payment-status-row{
      margin-top:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .payment-status-chip{
      background:rgba(184,16,13,.12);
      color:var(--brand);
      padding:6px 14px;
      border-radius:999px;
      font-weight:600;
      font-size:14px;
    }
    .payment-change-link{
      background:none;
      border:none;
      color:var(--brand);
      font-size:14px;
      font-weight:600;
      text-decoration:underline;
      cursor:pointer;
      padding:0;
    }
    .payment-change-link:disabled{
      color:#9ca3af;
      cursor:default;
      text-decoration:none;
    }
    .next-button{
      margin-top:14px;padding:14px;background:#333;color:#fff;cursor:pointer;border:none;border-radius:6px;
      text-align:center;width:100%;font-size:18px;font-weight:bold
    }
    .next-button:hover{background:#555}

    /* Item cards */
    .item-box{
      background:#fff;padding:10px;width:160px;border:1px solid #ddd;text-align:center;cursor:pointer;border-radius:8px;
      transition:transform .1s ease, background-color .2s; box-shadow:0 2px 5px rgba(0,0,0,.06);
      display:flex;flex-direction:column;align-items:center;position:relative
    }
    .item-box:hover{background:#f7f7f7; transform:translateY(-2px)}
    .item-box strong{font-size:14px;color:#333}
    .item-box .price{font-size:14px;color:var(--brand);font-weight:bold;margin-top:2px}
    .item-box img{max-width:100%;height:auto;margin-top:6px;flex-grow:1;object-fit:contain}
    .inline-inventory-bar{width:100%;margin-top:6px}
    .inline-inventory-track{height:6px;border-radius:999px;background:rgba(0,0,0,.08);overflow:hidden;position:relative}
    .inline-inventory-fill{height:100%;background:var(--brand);transition:width .2s ease;min-width:0}
    .inventory-chip{display:none;margin-top:6px;padding:4px 8px;border-radius:999px;background:#f3f4f6;color:#555;font-size:11px;font-weight:600}
    .inventory-tooltip{
      position:absolute;bottom:100%;left:50%;transform:translate(-50%,-10px);
      background:rgba(17,24,39,.92);color:#fff;padding:6px 10px;border-radius:6px;font-size:11px;white-space:nowrap;
      pointer-events:none;box-shadow:0 10px 25px rgba(0,0,0,.18);z-index:10;opacity:0;animation:inventoryTooltipFade .18s ease forwards
    }
    .inventory-tooltip::after{
      content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);
      border-width:6px;border-style:solid;border-color:rgba(17,24,39,.92) transparent transparent transparent
    }
    @keyframes inventoryTooltipFade{from{opacity:0;transform:translate(-50%,0);}to{opacity:1;transform:translate(-50%,-10px);}}
    .item-actions{display:flex;gap:6px;margin-top:8px}
    .edit-price-btn{
      padding:6px 8px;font-size:12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:4px
    }
    .edit-price-btn:hover{background:#f1f5f9}
    .oos-btn{
      padding:6px 8px;font-size:12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer
    }
    .modal-actions{display:flex;justify-content:center;gap:12px;margin-top:18px}
    .modal-button{
      padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:16px
    }
    .modal-button.primary{background:var(--brand);color:#fff}
    .modal-button.primary:hover{background:var(--brand-dark)}
    .modal-button.secondary{background:#e5e7eb;color:#111}
    .modal-button.secondary:hover{background:#d1d5db}
    .modal-label{display:block;text-align:left;font-size:14px;font-weight:600;color:#333;margin-bottom:6px}
    .modal-reset{margin-top:12px;font-size:13px;color:var(--brand);background:none;border:none;cursor:pointer;text-decoration:underline}
    .modal-reset:hover{color:var(--brand-dark)}
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:rgba(17,24,39,.92);color:#fff;padding:10px 18px;border-radius:999px;font-size:14px;box-shadow:0 10px 25px rgba(0,0,0,.18);z-index:2000;opacity:0;pointer-events:none;transition:opacity .2s ease}
    .toast.show{opacity:1}
    .payment-toast{background:rgba(23,128,61,.92)}
    .payment-toast.error{background:rgba(184,16,13,.92)}
    .oos-tag{
      font-size:11px;color:#fff;background:#777;border-radius:6px;padding:2px 6px;margin-left:6px
    }
    .is-oos{opacity:.45; outline:2px dashed #aaa; outline-offset:-6px}

    /* Bottom tabs */
    .bottom-tabs{
      position:fixed;bottom:0;left:0;width:100%;background:var(--brand);
      display:flex;justify-content:center;gap:12px;padding:10px
    }
    .tab-button{
      padding:10px 16px;margin:0;border:none;border-radius:6px;font-weight:bold;color:#fff;background:var(--brand);
      cursor:pointer
    }
    .tab-button.active{background:var(--brand-dark)}

    /* Display Mode */
    .display-mode .top-section, .display-mode .bottom-tabs{display:none}
    .qr-section{
      background:#f9f9f9;position:relative;overflow:hidden;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh
    }
    .display-mode .qr-section{
      background-image:url('https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/durga_puja_background.jpg');
      background-size:cover;background-position:center;
    }
    .logo{width:260px;margin-bottom:10px;z-index:2;position:relative}
    .display-container{
      display:none;grid-template-columns:1.1fr 0.9fr;gap:24px;max-width:1280px;margin:auto;padding:24px;width:100%;z-index:2
    }
    .display-left{
      background:#fff;border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.06);display:flex;flex-direction:column;gap:16px;max-height:calc(100vh - 160px);overflow:auto
    }
    .display-right{
      background:#fff;border-radius:16px;padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;box-shadow:0 4px 12px rgba(0,0,0,.06);max-height:calc(100vh - 160px);overflow:auto
    }
    .brand-badge{display:inline-flex;gap:8px;align-items:center;font-size:12px;color:#6b7280;background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .brand-badge img{height:16px;width:16px;object-fit:contain;border-radius:4px}
    .brand-ghost{opacity:.8}
    .display-brand{position:fixed;right:14px;bottom:12px;z-index:1000}
    @media (max-width:900px){.display-brand{right:8px;bottom:8px}}
    .display-order-header{font-size:24px;font-weight:700;color:var(--brand)}
    .display-order-items{display:flex;flex-direction:column;gap:12px}
    .display-order-row{display:flex;justify-content:space-between;align-items:flex-start;gap:16px}
    .display-order-info{display:flex;flex-direction:column;gap:4px}
    .display-order-name{font-size:18px;font-weight:600;color:#222}
    .display-order-meta{font-size:14px;color:#666}
    .display-order-line-total{font-size:18px;font-weight:700;color:#222}
    .display-left-totals{display:flex;flex-direction:column;gap:8px;margin-top:auto;padding-top:16px;border-top:1px solid #e5e5e5}
    .display-left-total-row{display:flex;justify-content:space-between;align-items:center;font-size:20px;font-weight:700;color:var(--brand)}
    .display-left-total-row.subtotal{font-size:18px;font-weight:600;color:#111}
    .display-left-total-row.fee{font-size:18px;font-weight:600;color:var(--warn)}
    .display-left-total-row.grand{font-size:24px;font-weight:800;color:var(--brand)}
    .display-left-empty{font-size:18px;color:#555;text-align:center;padding:40px 0}
    .display-total{font-size:clamp(36px,6vw,64px);font-weight:800;color:var(--brand)}
    .display-memo{font-size:clamp(16px,2.6vw,24px);color:#333}
    .display-qr{max-width:360px;width:100%;height:auto}
    .display-right-logo{width:240px;max-width:100%;height:auto}
    .qr-missing{font-size:20px;color:var(--danger);font-weight:bold;text-align:center}
    .display-zelle-logo{height:64px;object-fit:contain}
    .quote-container{
      position:absolute;bottom:20px;width:80%;text-align:center;background:rgba(255,255,255,.72);
      padding:10px;border-radius:10px;font-family:'Noto Sans Bengali',sans-serif;font-size:22px;color:#333;animation:fadeInOut 10s infinite
    }
    .fullscreen-button{
      position:fixed;bottom:10px;right:10px;padding:10px;background:#333;color:#fff;border:none;border-radius:6px;z-index:1000;font-weight:bold;cursor:pointer
    }

    @keyframes fadeInOut{
      0%{opacity:0}10%{opacity:1}90%{opacity:1}100%{opacity:0}
    }

    /* Order Tracking */
    .order-tracking{display:none;padding:20px}
    .order-tracking h2{margin:0 0 10px}
    .subtabs{display:flex;gap:8px;margin:8px 0 12px}
    .subtabs button{padding:8px 12px;border:none;border-radius:6px;background:#eee;cursor:pointer;font-weight:bold}
    .subtabs button.active{background:var(--brand);color:#fff}
    .order-tracking table{width:100%;border-collapse:collapse;overflow-x:auto}
    .order-tracking th, .order-tracking td{border:1px solid #ddd;padding:6px;text-align:center;font-size:12px}
    .order-tracking tr:nth-child(even){background:#f7f7f7}
    .order-tracking th{background:#4CAF50;color:#fff;position:sticky;top:0;z-index:1}
    .order-overwritten td{background:#fff3cd}
    #download-csv{margin-top:10px;padding:10px;background:#333;color:#fff;border:none;border-radius:6px;font-weight:bold;cursor:pointer}
    .delete-order-button{background:transparent;border:none;color:var(--danger);font-size:18px;cursor:pointer}
    .controls-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    /* Zelle confirmations small buttons */
    .btn-small{padding:6px 10px;border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:bold}
    .btn-ok{background:var(--ok)}
    .btn-warn{background:var(--warn)}
    .btn-muted{background:#6b7280}

    .zelle-account-control{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    .current-account-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .current-account-row strong{font-size:16px}
    .current-account-detail{font-size:14px;color:#555}
    .zelle-account-buttons{display:flex;flex-wrap:wrap;gap:8px}
    .zelle-account-button{
      padding:8px 14px;border:1px solid var(--brand);border-radius:6px;background:#fff;color:var(--brand);
      font-weight:bold;cursor:pointer;transition:background .2s,color .2s;display:flex;flex-direction:column;align-items:center;
      gap:4px;min-width:86px
    }
    .zelle-account-button:hover{background:var(--brand);color:#fff}
    .zelle-account-button.active{background:var(--brand);color:#fff;box-shadow:0 0 0 1px #fff inset}
    .zelle-account-button:disabled{cursor:default;opacity:.9}
    .zelle-account-button .account-code{font-size:16px}
    .zelle-account-button .account-label{font-size:12px;color:#555;font-weight:500}
    .zelle-account-button .account-action{font-size:12px;font-weight:bold;color:inherit}
    .zelle-account-totals{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .zelle-fee-card{background:#fff;border:1px solid rgba(184,16,13,.25);border-radius:12px;padding:14px;box-shadow:0 6px 16px rgba(0,0,0,.05);display:flex;flex-direction:column;gap:12px}
    .zelle-fee-card h3{margin:0;font-size:15px;color:#b0100d}
    .zelle-fee-row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .zelle-fee-toggle{display:flex;align-items:center;gap:8px;font-weight:600;color:#333}
    .zelle-fee-toggle input[type="checkbox"]{width:20px;height:20px}
    .zelle-fee-amount-input{width:120px;padding:8px;border-radius:8px;border:1px solid #d1d5db;font-size:14px}
    .zelle-fee-save{align-self:flex-start;padding:8px 14px;border:none;border-radius:6px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
    .zelle-fee-save:disabled{opacity:.6;cursor:default}
    .account-total-card{
      background:#fff;border:1px solid #ddd;border-radius:8px;padding:10px 14px;display:flex;
      flex-direction:column;gap:4px;min-width:140px
    }
    .account-total-card.active{border-color:var(--brand);box-shadow:0 0 0 2px rgba(184,16,13,.15)}
    .zelle-top-layout{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;margin-top:16px}
    .zelle-left-stack{flex:1 1 460px;min-width:320px;display:flex;flex-direction:column;gap:12px}
    .switch-log-card{
      flex:0 0 260px;max-width:320px;background:#fff;border:1px solid rgba(184,16,13,.25);
      border-radius:12px;padding:14px;box-shadow:0 6px 16px rgba(0,0,0,.05)
    }
    .switch-log-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .switch-log-header h3{margin:0;font-size:15px;color:#b0100d}
    .switch-log-clear{
      background:transparent;border:none;color:#b0100d;font-size:12px;font-weight:600;cursor:pointer;
      padding:4px 6px;border-radius:6px
    }
    .switch-log-clear:hover{background:rgba(184,16,13,.1)}
    .switch-log-list{display:flex;flex-direction:column;gap:4px;max-height:280px;overflow-y:auto}
    .switch-log-row{
      display:grid;grid-template-columns:1fr 1.1fr auto;gap:8px;align-items:center;font-size:12px;
      padding:6px 8px;border-radius:8px;background:#fff;border:1px solid rgba(0,0,0,.06);
      box-shadow:0 1px 2px rgba(0,0,0,.05)
    }
    /* Items Admin */
    .items-admin{display:none;padding:24px;background:#f8f8f8;min-height:calc(100vh - 140px);overflow:auto}
    .items-admin h2{margin:0 0 12px;font-size:24px}
    .items-admin-header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:16px}
    .items-admin-header .subtabs{margin:0}
    .items-admin-header .search-box{flex:1 1 220px;min-width:200px}
    .items-admin-header .search-box input{width:100%;padding:8px 12px;border:1px solid #ccc;border-radius:6px;font-size:15px}
    .items-admin-header .primary-button{background:var(--brand);color:#fff;border:none;border-radius:8px;padding:10px 16px;font-weight:600;cursor:pointer}
    .items-admin-header .primary-button:hover{background:var(--brand-dark)}
    .items-admin-table-wrapper{background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden;border:1px solid #e5e5e5}
    .items-admin table{width:100%;border-collapse:collapse}
    .items-admin thead{background:#fafafa}
    .items-admin th,.items-admin td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
    .items-admin tbody tr:hover{background:#fdf2f2}
    .items-admin td.actions{white-space:nowrap}
    .items-admin .inline-number{width:100px;padding:6px;border:1px solid #ccc;border-radius:6px;font-size:14px}
    .items-admin .inline-select{padding:6px 28px 6px 10px;border:1px solid #ccc;border-radius:6px;font-size:14px;min-width:140px}
    .items-admin .inline-checkbox{width:18px;height:18px}
    .items-admin .thumbnail{width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid #eee;background:#fafafa}
    .items-admin .empty-state{padding:30px;text-align:center;color:#777;font-size:15px}
    .items-admin .sort-buttons{display:inline-flex;flex-direction:column;margin-left:6px;vertical-align:middle}
    .items-admin .sort-buttons button{border:1px solid #ccc;background:#fff;padding:2px 4px;margin:1px;border-radius:4px;cursor:pointer;font-size:12px}
    .items-admin .sort-buttons button:hover{background:#f1f5f9}
    .items-admin .table-button{padding:8px 12px;border:none;border-radius:6px;font-weight:600;cursor:pointer;background:#e5e7eb;color:#111;margin-right:6px}
    .items-admin .table-button.primary{background:var(--brand);color:#fff}
    .items-admin .table-button.danger{background:#b8100d;color:#fff}
    .items-admin .ticket-color-manager{margin-top:24px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.04);border:1px solid #e5e5e5}
    .items-admin .ticket-color-list{display:flex;flex-direction:column;gap:10px;margin-top:14px}
    .items-admin .ticket-color-row{display:flex;align-items:center;gap:10px}
    .items-admin .ticket-color-row input{flex:1;padding:8px 10px;border:1px solid #ccc;border-radius:6px;font-size:14px}
    .items-admin .ticket-color-row button{padding:8px 12px;border:none;border-radius:6px;font-weight:600;cursor:pointer}
    .items-admin .ticket-color-row button.primary{background:var(--brand);color:#fff}
    .items-admin .ticket-color-row button.secondary{background:#e5e7eb;color:#111}
    .items-admin .ticket-color-row button.danger{background:#b8100d;color:#fff}
    .items-admin .ticket-color-add{display:flex;gap:10px;margin-top:16px}
    .items-admin .ticket-color-add input{flex:1;padding:8px 10px;border:1px solid #ccc;border-radius:6px;font-size:14px}
    .items-admin .ticket-color-add button{padding:10px 16px;border:none;border-radius:8px;font-weight:600;cursor:pointer;background:var(--brand);color:#fff}
    .items-admin .ticket-color-add button:hover{background:var(--brand-dark)}
    .items-admin .ticket-color-hint{font-size:13px;color:#777;margin-top:10px}
    .switch-log-row:hover{background:rgba(184,16,13,.06)}
    .switch-log-time{color:#4b5563;font-weight:600}
    .switch-log-arrow{text-align:right;color:#b0100d;font-weight:600}
    .switch-log-delete{
      background:transparent;border:none;color:#b0100d;font-size:14px;cursor:pointer;line-height:1;padding:2px 4px;
      border-radius:50%
    }
    .switch-log-delete:hover{background:rgba(184,16,13,.1)}
    .switch-log-empty{font-size:12px;color:#666;padding:6px 0}

    /* Analytics */
    .analytics{display:none;padding:20px;box-sizing:border-box}
    .analytics-layout{display:flex;flex-direction:column;gap:20px;height:calc(100vh - 160px);min-height:420px;overflow:hidden}
    .analytics-header-row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .analytics-panels{flex:1;display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;min-height:0;overflow:hidden}
    .analytics-panel{background:#fff;border-radius:16px;padding:18px;box-shadow:0 8px 20px rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.06);display:flex;flex-direction:column;min-height:0}
    .analytics-panel h3{margin:0;font-size:18px;color:var(--brand)}
    .analytics-panel .panel-body{margin-top:14px;flex:1;display:flex;flex-direction:column;min-height:0}
    .analytics-panel .panel-body.scrollable{overflow:auto}
    .items-table-wrapper{flex:1;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;background:#fafafa}
    .items-table{width:100%;border-collapse:collapse;font-size:13px}
    .items-table thead th{position:sticky;top:0;background:#fff;font-weight:700;text-align:left;padding:10px;border-bottom:1px solid #e5e7eb}
    .items-table tbody td{padding:10px;border-bottom:1px solid #f0f0f0}
    .items-table tbody tr:last-child td{border-bottom:none}
    .analytics-metric-row{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px}
    .analytics-metric{background:rgba(184,16,13,.08);border-radius:12px;padding:12px 16px;min-width:140px;display:flex;flex-direction:column;gap:6px}
    .analytics-metric span{font-size:12px;color:#555;text-transform:uppercase;letter-spacing:.6px}
    .analytics-metric strong{font-size:20px;color:var(--brand)}
    .payment-charts{display:flex;gap:16px;flex-wrap:wrap;margin-top:18px}
    .payment-chart{flex:1 1 200px;min-width:200px;max-width:260px;display:flex;flex-direction:column;align-items:center;gap:8px}
    .payment-chart canvas{width:100%;height:200px;max-height:220px}
    .chart-caption{font-size:12px;color:#555;font-weight:600;text-transform:uppercase;letter-spacing:.6px;text-align:center}
    .hourly-chart-wrapper{flex:1;min-height:260px}
    .hourly-chart-wrapper canvas{width:100%;height:100%}
    @media (max-width:900px){
      .analytics-layout{height:auto;min-height:0}
      .analytics-panels{grid-template-columns:1fr}
      .payment-chart{max-width:100%}
      .hourly-chart-wrapper{min-height:240px}
    }

    /* Inventory */
    .inventory-view{display:none;padding:18px;box-sizing:border-box;height:calc(100vh - 160px);min-height:420px;display:flex;flex-direction:column;gap:16px;background:#f5f5f7}
    .inventory-stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .inventory-stat-card{background:#fff;border-radius:14px;padding:12px 14px;border:1px solid rgba(0,0,0,.05);box-shadow:0 6px 16px rgba(0,0,0,.04);display:flex;flex-direction:column;gap:4px}
    .inventory-stat-card span{font-size:11px;color:#666;letter-spacing:.5px;text-transform:uppercase;font-weight:600}
    .inventory-stat-card strong{font-size:20px;color:var(--brand);font-weight:700}
    .inventory-panel{flex:1;min-height:0;background:#fff;border-radius:16px;border:1px solid rgba(0,0,0,.06);box-shadow:0 8px 20px rgba(0,0,0,.06);display:flex;flex-direction:column;overflow:hidden}
    .inventory-scroll{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:16px}
    .inventory-controls{position:sticky;top:0;z-index:2;background:#fff;padding-bottom:12px;margin:-4px -4px 12px -4px;padding:4px 4px 12px 4px;border-bottom:1px solid #f0f0f0;display:flex;flex-direction:column;gap:12px}
    .inventory-control-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .inventory-search{flex:1 1 240px;min-width:200px}
    .inventory-search input{width:100%;padding:8px 12px;border-radius:999px;border:1px solid #d1d5db;font-size:14px}
    .inventory-day-toggle{display:inline-flex;border:1px solid #e5e7eb;border-radius:999px;overflow:hidden}
    .inventory-day-toggle button{padding:6px 14px;border:none;background:transparent;font-weight:600;font-size:13px;color:#555;cursor:pointer}
    .inventory-day-toggle button.active{background:var(--brand);color:#fff}
    .inventory-filter-pills{display:flex;gap:8px;flex-wrap:wrap}
    .inventory-filter-pill{padding:6px 12px;border-radius:999px;border:1px solid #d1d5db;background:#fafafa;font-weight:600;font-size:13px;color:#555;cursor:pointer;transition:all .15s ease}
    .inventory-filter-pill:hover{border-color:var(--brand);color:var(--brand)}
    .inventory-filter-pill.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .inventory-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;align-content:flex-start}
    .inventory-item-card{border:1px solid #e5e7eb;border-radius:14px;padding:12px 14px;display:flex;flex-direction:column;gap:10px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.04);position:relative}
    .inventory-item-card.is-oos{border-color:rgba(184,16,13,.35);box-shadow:0 0 0 1px rgba(184,16,13,.12)}
    .inventory-item-card.is-low:not(.is-zero){border-color:rgba(178,106,0,.4)}
    .inventory-item-card.is-zero{border-color:rgba(184,16,13,.4)}
    .inventory-item-card.is-untracked{border-style:dashed}
    .inventory-card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .inventory-item-name{display:flex;flex-direction:column;gap:6px}
    .inventory-item-name strong{font-size:15px;color:#111}
    .inventory-item-code{font-size:11px;color:#666;background:#f3f4f6;border-radius:999px;padding:2px 8px;font-weight:600;align-self:flex-start}
    .inventory-track-toggle{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#555;font-weight:600;cursor:pointer;user-select:none}
    .inventory-track-toggle input{appearance:none;width:34px;height:18px;border-radius:999px;background:#d1d5db;position:relative;transition:background .2s ease}
    .inventory-track-toggle input::after{content:'';position:absolute;width:16px;height:16px;border-radius:50%;background:#fff;top:1px;left:1px;transition:transform .2s ease}
    .inventory-track-toggle input:checked{background:var(--brand)}
    .inventory-track-toggle input:checked::after{transform:translateX(16px)}
    .inventory-card-meta{display:flex;gap:12px;font-size:12px;color:#666;flex-wrap:wrap}
    .inventory-card-meta span{display:flex;align-items:center;gap:4px;font-weight:600}
    .inventory-card-meta span strong{color:#111;font-size:14px;font-weight:700}
    .inventory-card-body{display:flex;flex-direction:column;gap:10px}
    .inventory-input-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .inventory-input-group{display:flex;flex-direction:column;gap:4px}
    .inventory-input-group label{font-size:11px;font-weight:700;color:#666;text-transform:uppercase;letter-spacing:.5px}
    .inventory-input-group input{padding:8px 10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px;width:100%}
    .inventory-quick-buttons{display:flex;flex-wrap:wrap;gap:8px}
    .inventory-quick-button{padding:6px 10px;border-radius:8px;border:1px solid rgba(184,16,13,.2);background:#fff;font-weight:600;color:var(--brand);cursor:pointer;font-size:12px;min-width:52px}
    .inventory-quick-button:hover{background:rgba(184,16,13,.08)}
    .inventory-untracked-label{display:none;font-size:12px;font-weight:600;color:#555;background:#f3f4f6;border-radius:999px;padding:6px 10px;align-self:flex-start}
    .inventory-zero-warning{display:none;font-size:12px;font-weight:600;color:var(--brand);background:rgba(184,16,13,.08);border-radius:8px;padding:6px 10px;align-self:flex-start}
    .inventory-empty{font-size:14px;color:#666;text-align:center;padding:24px;border:1px dashed #d1d5db;border-radius:12px;background:#fafafa}
    @media (max-width:900px){
      .inventory-view{height:auto;min-height:0}

    }
    @media (max-width:640px){
      .inventory-grid{grid-template-columns:1fr}
      .inventory-card-header{flex-direction:column;align-items:flex-start}
      .inventory-track-toggle{align-self:flex-start}
    }

    /* Modals */
    .modal{display:none;position:fixed;z-index:1001;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,.4)}
    .modal-content{
      background:#fff;margin:8% auto;padding:20px;border:1px solid #888;width:420px;max-width:92%;
      text-align:center;border-radius:12px;position:relative
    }
    .close-modal-button{
      position:absolute;top:10px;right:16px;background:transparent;border:none;color:#999;font-size:28px;font-weight:bold;cursor:pointer
    }
    .close-modal-button:hover{color:#000}
    .payment-option-button{
      width:85%;padding:14px;margin:10px 0;background:var(--brand);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:18px
    }
    .payment-option-button:hover{background:var(--brand-dark)}
    .row{display:flex;justify-content:space-between;align-items:center;margin:10px 0}
    .pill{
      border:1px solid #ccc;border-radius:20px;padding:6px 10px;display:inline-flex;gap:6px;align-items:center
    }
    .pill button{
      border:none;background:#eee;border-radius:14px;padding:4px 8px;cursor:pointer;font-weight:bold
    }
    .pill button.active{background:var(--brand);color:#fff}
    .name-button{
      padding:8px 12px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;
      background:rgba(255,255,255,.2);color:#fff;transition:background .2s ease,transform .2s ease
    }
    .name-button:hover{background:rgba(255,255,255,.3);transform:translateY(-1px)}
    .name-button:focus{outline:2px solid #fff;outline-offset:2px}
    .pos-mode-controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    .pos-indicator{
      padding:8px 16px;border-radius:999px;border:1px solid rgba(255,255,255,.35);
      background:rgba(0,0,0,.2);color:#fff;font-weight:700;letter-spacing:.5px;
      text-transform:uppercase
    }
    body[data-pos-id="POS2"] .pos-indicator{background:rgba(13,110,253,.3)}
    body[data-pos-id="POS3"] .pos-indicator{background:rgba(25,135,84,.3)}
    .pos-switcher-label{
      font-size:12px;font-weight:600;color:#fff;letter-spacing:.6px;text-transform:uppercase
    }
    .pos-switcher-select{
      appearance:none;-webkit-appearance:none;-moz-appearance:none;
      background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.35);
      border-radius:8px;padding:6px 10px;color:#fff;font-weight:700;
      text-transform:uppercase;cursor:pointer;min-width:120px
    }
    .pos-switcher-select:focus{outline:2px solid rgba(255,255,255,.8);outline-offset:2px}
    .pos-switcher-select option{color:#111;font-weight:600;text-transform:none}

    .order-summary-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .order-number-display{
      font-size:20px;font-weight:700;color:var(--brand);margin-bottom:14px;padding:8px 12px;border-radius:10px;
      background:#fff;border:1px solid rgba(184,16,13,.2);display:inline-flex;gap:6px;align-items:center
    }
    .pos-chip{
      padding:4px 10px;border-radius:999px;background:rgba(184,16,13,.1);color:var(--brand);
      font-size:13px;font-weight:700;text-transform:uppercase
    }
    .pos-filter-row{align-items:center;gap:12px;flex-wrap:wrap}
    .pos-filter-label{font-weight:600;color:#444}
    .pos-filter-buttons{display:flex;flex-wrap:wrap;gap:8px}
    .pos-filter-button{
      padding:6px 12px;border-radius:999px;border:1px solid #ccc;background:#f5f5f5;
      cursor:pointer;font-weight:600;color:#444;transition:all .15s ease
    }
    .pos-filter-button:hover{background:#fff;color:var(--brand);border-color:rgba(184,16,13,.3)}
    .pos-filter-button.active{background:var(--brand);border-color:var(--brand);color:#fff}
    .display-name-banner{
      display:none;position:relative;margin-bottom:16px;padding:10px 20px;border-radius:12px;
      background:rgba(255,255,255,.9);color:#111;font-size:clamp(20px,3vw,34px);font-weight:700;
      box-shadow:0 10px 24px rgba(0,0,0,.12);backdrop-filter:blur(4px);z-index:3
    }
    .display-name-banner.active{display:inline-flex;animation:displayNameEnter .35s ease forwards}
    @keyframes displayNameEnter{from{opacity:0;transform:translateY(-12px);}to{opacity:1;transform:translateY(0);}}
    .display-order-number{font-size:clamp(30px,5vw,52px);font-weight:800;color:var(--brand);text-align:center}
    .display-order-number-inline{font-size:clamp(20px,3.4vw,32px);text-align:left}
    .customer-name-input{width:100%;padding:10px;font-size:18px;border-radius:8px;border:1px solid #d1d5db}
  </style>
</head>
<body>

  <!-- Top: Search + Day switch + Tickets -->
  <div class="top-section">
    <div class="search">
      <input type="text" placeholder="Search" id="search-input" onkeyup="searchItems()" />
    </div>

    <div class="day-switch">
      <span style="font-weight:bold;">Day:</span>
      <button id="btn-day-sat" class="active" onclick="setDay('SAT')">Saturday</button>
      <button id="btn-day-sun" onclick="setDay('SUN')">Sunday</button>
      <span class="oos-tag">2025</span>
    </div>

    <button id="customer-name-button" class="name-button" type="button" onclick="openCustomerNameModal()">Name</button>

    <div class="pos-mode-controls" role="group" aria-label="POS station selector">
      <div class="pos-indicator" id="pos-indicator" aria-live="polite">POS1</div>
      <label for="pos-switcher-select" class="pos-switcher-label">Switch POS</label>
      <select id="pos-switcher-select" class="pos-switcher-select" onchange="handlePosSwitchChange(event)" aria-label="Switch POS station">
        <option value="POS1">POS1 — Full</option>
        <option value="POS2">POS2 — Cash</option>
        <option value="POS3">POS3 — Cash</option>
      </select>
    </div>

    <div class="pos-indicator" id="pos-indicator" aria-live="polite">POS1</div>

    <div class="ticket-section" id="ticket-counter-container" aria-live="polite"></div>
  </div>
  <!-- Mode Switch -->
  <div id="mode-switch-row" style="padding:10px 20px;display:flex;gap:10px;align-items:center;">
    <button onclick="setMode('POS')">POS Mode (iPad/Computer)</button>
    <button onclick="setMode('Display')">Display Mode (Phone)</button>
  </div>
  <!-- Main -->
  <div class="container">
    <div class="item-grid" id="item-grid"></div>

    <div class="order-summary">
      <div class="order-summary-header">
        <h2 id="current-order-heading">Current Order</h2>
      </div>
      <div id="order-list"></div>
      <div id="current-order-number-display" class="order-number-display"><span class="pos-chip" id="current-pos-chip">POS1</span> Order #<span id="current-order-number">1</span></div>
      <div class="total-amount">
        $<span id="total-price-summary">0.00</span>
        <span class="edit-total-icon" title="Edit Total" onclick="openEditTotalModal()">&#9998;</span>
      </div>
      <div class="payment-status-row hide" id="payment-status-row">
        <span class="payment-status-chip" id="payment-status-chip"></span>
        <button type="button" class="payment-change-link hide" id="payment-change-link"></button>
      </div>
      <div class="payment-buttons" id="payment-buttons">
        <button class="payment-button" id="cash-payment-button" onclick="processPayment('Cash')">Cash</button>
        <button class="payment-button" id="zelle-payment-button" onclick="processPayment('Zelle')">Zelle</button>
      </div>
      <button class="next-button" onclick="clearOrder()">Next Customer</button>
    </div>
  </div>

  <!-- Display Section (for Display Mode) -->
  <div class="qr-section">
    <img src="https://assets.cdn.filesafe.space/slWdpqUTRhMfisMySSJ0/media/66f7050f5b684e16ab132d41.jpeg" alt="Company Logo" class="logo">
    <div class="display-name-banner" id="display-name-banner"></div>
    <div class="display-container" id="display-container">
      <div class="display-left" id="display-order-list"></div>
      <div class="display-right" id="display-payment-panel"></div>
    </div>
    <div class="quote-container" id="quote-container"></div>
  </div>

  <!-- Fullscreen -->
  <button class="fullscreen-button" onclick="toggleFullscreen()">Fullscreen</button>



  <!-- Order Tracking -->
  <div class="order-tracking" id="order-tracking">
    <div class="controls-row">
      <h2 style="margin-right:auto">Order Log</h2>
      <div class="subtabs">
        <button id="ot-sat" class="active" onclick="switchDaySubtab('SAT','ot')">Saturday</button>
        <button id="ot-sun" onclick="switchDaySubtab('SUN','ot')">Sunday</button>
      </div>
    </div>
    <div class="controls-row pos-filter-row">
      <div class="pos-filter-label">POS Filter:</div>
      <div class="pos-filter-buttons">
        <button id="pos-filter-all" class="pos-filter-button active" onclick="setOrderTrackingFilter('ALL')">All POS</button>
        <button id="pos-filter-pos1" class="pos-filter-button" onclick="setOrderTrackingFilter('POS1')">POS1</button>
        <button id="pos-filter-pos2" class="pos-filter-button" onclick="setOrderTrackingFilter('POS2')">POS2</button>
        <button id="pos-filter-pos3" class="pos-filter-button" onclick="setOrderTrackingFilter('POS3')">POS3</button>
      </div>
    </div>
    <div class="controls-row">
      <button id="download-csv" onclick="downloadCSV()">Download CSV</button>
      <button id="clear-orders" onclick="clearAllOrders()">Clear Orders</button>
    </div>
    <div style="overflow-x:auto; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Order #</th>
            <th>POS</th>
            <th>POS Order #</th>
            <th>Time</th>
            <th>Name</th>
            <!-- Item Codes will be auto headers from menuItems -->
            <th id="th-dynamic-start" colspan="1"></th>
            <th>Total</th>
            <th>Zelle Phone</th>
            <th>Payment Method</th>
            <th>Pass Fee</th>
            <th>Fee</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="order-log"></tbody>
      </table>
    </div>
  </div>

  <!-- Zelle Confirmations -->
  <div class="order-tracking" id="zelle-confirmations">
    <div class="controls-row">
      <h2 style="margin-right:auto">Zelle Control</h2>
      <div class="subtabs">
        <button id="ze-sat" class="active" onclick="switchDaySubtab('SAT','ze')">Saturday</button>
        <button id="ze-sun" onclick="switchDaySubtab('SUN','ze')">Sunday</button>
      </div>
    </div>
    <div class="zelle-top-layout">
      <div class="zelle-left-stack">
        <div class="zelle-account-control">
          <div class="current-account-row">
            <strong>Current Account:</strong>
            <span id="current-zelle-account">—</span>
            <span id="current-zelle-account-detail" class="current-account-detail" style="display:none"></span>
          </div>
          <div id="zelle-account-buttons" class="zelle-account-buttons"></div>
        </div>
        <div class="zelle-fee-card" aria-labelledby="zelle-fee-heading">
          <h3 id="zelle-fee-heading">Zelle Fee</h3>
          <div class="zelle-fee-row">
            <label class="zelle-fee-toggle" for="zelle-fee-toggle">
              <input type="checkbox" id="zelle-fee-toggle" onchange="handleZelleFeeToggleChange()" />
              Enable processing fee
            </label>
          </div>
          <div class="zelle-fee-row">
            <label for="zelle-fee-amount" style="font-weight:600;color:#333">Fee amount ($)</label>
            <input type="number" id="zelle-fee-amount" class="zelle-fee-amount-input" min="0" max="20" step="0.50" />
          </div>
          <button type="button" class="zelle-fee-save" onclick="saveZelleFeeSettings()">Save</button>
        </div>
        <div class="controls-row" style="margin-top:12px">
          <button onclick="downloadZelleCSV()">Download CSV</button>
        </div>
        <div id="zelle-account-totals" class="zelle-account-totals"></div>
      </div>
      <div class="switch-log-card">
        <div class="switch-log-header">
          <h3>Switch Log</h3>
          <button type="button" id="switch-log-clear-button" class="switch-log-clear" onclick="clearZelleSwitchLog()" style="display:none">Clear log</button>
        </div>
        <div id="zelle-switch-log" class="switch-log-list"></div>
      </div>
    </div>
    <div style="overflow-x:auto; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Order #</th>
            <th>POS</th>
            <th>Total</th>
            <th>Customer Name</th>
            <th>Zelle Phone</th>
            <th>Account</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="zelle-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Stock Log -->
  <div class="order-tracking" id="stock-log">
    <div class="controls-row">
      <h2 style="margin-right:auto">Stock Log</h2>
      <div class="subtabs">
        <button id="sl-sat" class="active" onclick="switchDaySubtab('SAT','sl')">Saturday</button>
        <button id="sl-sun" onclick="switchDaySubtab('SUN','sl')">Sunday</button>
      </div>
    </div>

    <div class="controls-row">
      <button id="stock-download-csv" onclick="downloadStockCSV()">Download CSV</button>
      <button id="stock-clear" onclick="clearAllStockLog()">Clear Stock Log</button>
    </div>

    <div style="overflow-x:auto; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Code</th>
            <th>Item</th>
            <th>Status</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="stock-log-body"></tbody>
      </table>
    </div>
  </div>


  <!-- Items Admin -->
  <div class="items-admin" id="items-admin-view">
    <div class="items-admin-header">
      <h2 style="margin-right:auto">Items (Admin)</h2>
      <div class="subtabs" role="group" aria-label="Items day selector">
        <button id="items-admin-sat" class="active" onclick="setItemsAdminDay('SAT')">Saturday</button>
        <button id="items-admin-sun" onclick="setItemsAdminDay('SUN')">Sunday</button>
      </div>
      <div class="search-box">
        <input type="text" id="items-admin-search" placeholder="Search items…" oninput="renderItemsAdminTable()" autocomplete="off">
      </div>
      <button type="button" class="primary-button" onclick="openItemModal('create')">Add Item</button>
    </div>
    <div class="items-admin-table-wrapper">
      <table>
        <thead>
          <tr>
            <th style="width:90px;">Code</th>
            <th>Name</th>
            <th style="width:110px;">Price ($)</th>
            <th style="width:170px;">Ticket Color</th>
            <th style="width:90px;">Image</th>
            <th style="width:90px;">Active</th>
            <th style="width:80px;">Sort</th>
            <th style="width:140px;">Actions</th>
          </tr>
        </thead>
        <tbody id="items-admin-table-body">
          <tr><td colspan="8" class="empty-state">Loading items…</td></tr>
        </tbody>
      </table>
    </div>
    <div class="ticket-color-manager" id="ticket-color-manager">
      <h3 style="margin:0 0 6px;">Ticket Colors</h3>
      <p class="ticket-color-hint">Manage the shared list of ticket colors for the 2025 season.</p>
      <div class="ticket-color-list" id="ticket-color-list"></div>
      <div class="ticket-color-add">
        <input type="text" id="ticket-color-new" placeholder="Add a new color name" autocomplete="off">
        <button type="button" onclick="handleAddTicketColor()">Add Color</button>
      </div>
    </div>
  </div>

  <!-- Analytics -->
  <div class="inventory-view" id="inventory-view">
    <div class="inventory-stats-row">
      <div class="inventory-stat-card">
        <span>Total Initial Units</span>
        <strong id="inventory-total-initial">0</strong>
      </div>
      <div class="inventory-stat-card">
        <span>Total Remaining Units</span>
        <strong id="inventory-total-remaining">0</strong>
      </div>
      <div class="inventory-stat-card">
        <span>Units Sold So Far</span>
        <strong id="inventory-total-sold">0</strong>
      </div>
      <div class="inventory-stat-card">
        <span># Low Items</span>
        <strong id="inventory-low-count">0</strong>
      </div>
      <div class="inventory-stat-card">
        <span># Zero Items</span>
        <strong id="inventory-zero-count">0</strong>
      </div>
    </div>

      <div class="inventory-scroll">
        <div class="inventory-controls">
          <div class="inventory-control-row">
            <div class="inventory-search">
              <input type="text" id="inventory-filter-input" placeholder="Search inventory…" autocomplete="off">
            </div>
            <div class="inventory-day-toggle" role="group" aria-label="Inventory day selector">
              <button id="inventory-day-sat" type="button" class="active" onclick="setDay('SAT')">Sat</button>
              <button id="inventory-day-sun" type="button" onclick="setDay('SUN')">Sun</button>
            </div>
          </div>
          <div class="inventory-filter-pills" role="group" aria-label="Inventory filters">
            <button type="button" class="inventory-filter-pill active" data-inventory-filter="ALL">All</button>
            <button type="button" class="inventory-filter-pill" data-inventory-filter="LOW">Low (&lt;20%)</button>
            <button type="button" class="inventory-filter-pill" data-inventory-filter="ZERO">Zero</button>
            <button type="button" class="inventory-filter-pill" data-inventory-filter="UNTRACKED">No-inventory items</button>
            <button type="button" class="inventory-filter-pill" data-inventory-filter="TRACKED">Tracked items</button>
          </div>
        </div>
        <div class="inventory-grid" id="inventory-items-grid">
          <div class="inventory-empty" id="inventory-empty-state">Loading inventory…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics -->
  <div class="analytics" id="analytics">
    <div class="analytics-layout">
      <div class="controls-row analytics-header-row">
        <h2 style="margin-right:auto">Sales Analytics</h2>
        <div class="subtabs">
          <button id="an-sat" class="active" onclick="switchDaySubtab('SAT','an')">Saturday</button>
          <button id="an-sun" onclick="switchDaySubtab('SUN','an')">Sunday</button>
        </div>
      </div>
      <div class="analytics-panels">
        <section class="analytics-panel">
          <h3>Items Sold</h3>
          <div class="panel-body">
            <div class="items-table-wrapper">
              <table class="items-table">
                <thead>
                  <tr>
                    <th>Item Name</th>
                    <th>Units Sold</th>
                    <th>Gross ($)</th>
                  </tr>
                </thead>
                <tbody id="analytics-items-body"></tbody>
              </table>
            </div>
          </div>
        </section>
        <section class="analytics-panel">
          <h3>Payment Method Split</h3>
          <div class="panel-body">
            <div class="analytics-metric-row">
              <div class="analytics-metric">
                <span>Total Orders</span>
                <strong id="analytics-total-orders">0</strong>
              </div>
              <div class="analytics-metric">
                <span>Total Revenue</span>
                <strong id="analytics-total-revenue">$0.00</strong>
              </div>
            </div>
            <div class="payment-charts">
              <div class="payment-chart">
                <canvas id="payment-count-chart"></canvas>
                <div class="chart-caption">By Orders</div>
              </div>
              <div class="payment-chart">
                <canvas id="payment-revenue-chart"></canvas>
                <div class="chart-caption">By Revenue</div>
              </div>
            </div>
          </div>
        </section>
        <section class="analytics-panel">
          <h3>Expected vs Actual</h3>
          <div class="panel-body scrollable">
            <div class="analytics-metric-row">
              <div class="analytics-metric">
                <span>Expected Revenue</span>
                <strong id="analytics-expected-revenue">$0.00</strong>
              </div>
              <div class="analytics-metric">
                <span>Actual Revenue</span>
                <strong id="analytics-actual-revenue">$0.00</strong>
              </div>
              <div class="analytics-metric">
                <span>Shrinkage (Units)</span>
                <strong id="analytics-shrinkage-units">0</strong>
              </div>
              <div class="analytics-metric">
                <span>Shrinkage ($)</span>
                <strong id="analytics-shrinkage-dollars">$0.00</strong>
              </div>
            </div>
            <div class="items-table-wrapper" style="margin-top:12px;">
              <table class="items-table">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>Initial</th>
                    <th>Current</th>
                    <th>Units Sold</th>
                    <th>Unaccounted (Units)</th>
                    <th>Unaccounted ($)</th>
                  </tr>
                </thead>
                <tbody id="analytics-expected-body"></tbody>
              </table>
            </div>
          </div>
        </section>
        <section class="analytics-panel">
          <h3>Hourly Sales</h3>
          <div class="panel-body">
            <div class="hourly-chart-wrapper">
              <canvas id="hourly-sales-chart"></canvas>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Footer Tabs -->
   <div class="bottom-tabs">
    <button id="pos-tab-button" class="tab-button active" onclick="switchTab('POS')">POS</button>
   <button id="order-tracking-tab-button" class="tab-button" onclick="switchTab('Order Tracking')">Order Tracking</button>
   <button id="zelle-tab-button" class="tab-button" onclick="switchTab('Zelle')">Zelle Control</button>
   <button id="stock-tab-button" class="tab-button" onclick="switchTab('Stock Log')">Stock Log</button>
    <button id="inventory-tab-button" class="tab-button" onclick="switchTab('Inventory')">Inventory</button>
    <button id="analytics-tab-button" class="tab-button" onclick="switchTab('Analytics')">Analytics</button>
    <button id="items-admin-tab-button" class="tab-button" onclick="switchTab('Items Admin')">Items (Admin)</button>
  </div>

  <!-- Edit Total Modal -->
  <div id="edit-total-modal" class="modal">
    <div class="modal-content">
      <button class="close-modal-button" onclick="closeEditTotalModal()">&times;</button>
      <h2>Edit Total Price</h2>
      <input type="number" id="new-total-price" step="0.01" min="0" style="width: 80%; padding: 10px; font-size: 18px;">
      <button class="payment-option-button" style="margin-top: 20px;" onclick="updateTotalPrice()">Update</button>
    </div>
  </div>

  <!-- Edit Price Modal -->
  <div id="edit-price-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-price-title">
    <div class="modal-content" role="document">
      <button class="close-modal-button" onclick="closeEditPriceModal()" aria-label="Close edit price dialog">&times;</button>
      <h2 id="edit-price-title">Edit Price</h2>
      <div style="margin:18px 0 0;text-align:left">
        <label for="edit-price-input" class="modal-label">Price</label>
        <input type="number" id="edit-price-input" step="0.01" min="0" style="width:100%;padding:10px;font-size:18px;">
      </div>
      <div style="margin:16px 0 0;text-align:left">
        <label for="edit-ticket-color-select" class="modal-label">Ticket Color</label>
        <select id="edit-ticket-color-select" style="width:100%;padding:10px;font-size:16px;border-radius:8px;border:1px solid #d1d5db;"></select>
      </div>
      <div class="modal-actions">
        <button type="button" class="modal-button secondary" onclick="closeEditPriceModal()">Cancel</button>
        <button type="button" class="modal-button primary" onclick="savePriceOverride()">Save</button>
      </div>
    </div>
  </div>

  <!-- Item Editor Modal -->
  <div id="item-editor-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="item-editor-title">
    <div class="modal-content" role="document" style="max-width:520px;">
      <button class="close-modal-button" onclick="closeItemModal()" aria-label="Close item editor">&times;</button>
      <h2 id="item-editor-title">Add Item</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;">
        <div style="grid-column:1 / span 2;text-align:left;">
          <label class="modal-label" for="item-name-input">Name</label>
          <input type="text" id="item-name-input" maxlength="80" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:16px;">
        </div>
        <div style="text-align:left;">
          <label class="modal-label" for="item-code-input">Code</label>
          <input type="text" id="item-code-input" maxlength="12" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:16px;text-transform:uppercase;">
        </div>
        <div style="text-align:left;">
          <label class="modal-label" for="item-price-input">Price</label>
          <input type="number" id="item-price-input" step="0.01" min="0" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:16px;">
        </div>
        <div style="text-align:left;">
          <label class="modal-label" for="item-ticket-select">Ticket Color</label>
          <select id="item-ticket-select" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:16px;"></select>
        </div>
        <div style="grid-column:1 / span 2;text-align:left;">
          <label class="modal-label" for="item-image-input">Image URL</label>
          <input type="url" id="item-image-input" placeholder="https://" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:16px;">
        </div>
        <div style="text-align:left;">
          <label class="modal-label" for="item-active-input">Active</label>
          <div style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="item-active-input" checked>
            <span>Show in POS</span>
          </div>
        </div>
        <div style="text-align:left;">
          <label class="modal-label" for="item-sort-input">Sort</label>
          <input type="number" id="item-sort-input" step="1" min="0" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:16px;">
        </div>
      </div>
      <div class="modal-actions" style="margin-top:24px;">
        <button type="button" class="modal-button secondary" onclick="closeItemModal()">Cancel</button>
        <button type="button" class="modal-button primary" onclick="saveItemFromModal()">Save</button>
      </div>
    </div>
  </div>

  <!-- Customer Name Modal -->
  <div id="customer-name-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="customer-name-title">
    <div class="modal-content" role="document">
      <button class="close-modal-button" onclick="closeCustomerNameModal()" aria-label="Close customer name dialog">&times;</button>
      <h2 id="customer-name-title">Customer Name</h2>
      <div style="margin:18px 0 0;text-align:left">
        <label for="customer-name-input" class="modal-label">Name</label>
        <input type="text" id="customer-name-input" class="customer-name-input" placeholder="Enter name" maxlength="64">
      </div>
      <div class="modal-actions" style="margin-top:20px">
        <button type="button" class="modal-button secondary" onclick="skipCustomerName()">Skip</button>
        <button type="button" class="modal-button primary" onclick="saveCustomerName()">Save</button>
      </div>
    </div>
  </div>

  <!-- Zelle Phone Modal -->
  <div id="zelle-phone-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="zelle-phone-title">
    <div class="modal-content" role="document">
      <button class="close-modal-button" onclick="handleZellePhoneSkip()" aria-label="Close Zelle phone dialog">&times;</button>
      <h2 id="zelle-phone-title">Enter Zelle phone number</h2>
      <div style="margin:18px 0 0;text-align:left">
        <label for="zelle-phone-input" class="modal-label">Phone number</label>
        <input type="text" id="zelle-phone-input" class="customer-name-input" placeholder="(555) 123-4567" autocomplete="tel">
      </div>
      <div class="modal-actions" style="margin-top:20px">
        <button type="button" class="modal-button primary" onclick="handleZellePhoneSave()">Save</button>
        <button type="button" class="modal-button secondary" onclick="handleZellePhoneSkip()">Skip</button>
      </div>
    </div>
  </div>

  <div id="payment-toast" class="toast payment-toast" role="status" aria-live="polite"></div>
  <div id="price-toast" class="toast" role="status" aria-live="polite"></div>

  <!-- (Stripe card modal removed for Zelle/Cash flow) -->

  <script>
    /* ==========================
       CONFIG + GLOBAL STATE
       ========================== */

    // Firebase configuration (same project)
    const firebaseConfig = {
      apiKey: "AIzaSyDHoasqENlnp0zSAsz-3HfMkx4tgG-oZhA",
      authDomain: "akghorpos.firebaseapp.com",
      databaseURL: "https://akghorpos-default-rtdb.firebaseio.com",
      projectId: "akghorpos",
      storageBucket: "akghorpos.appspot.com",
      messagingSenderId: "791887148716",
      appId: "1:791887148716:web:5c8fb06053dcd6e5799109",
      measurementId: "G-7DE60HHEK8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function derivePosId(){
      try{
        const params = new URLSearchParams(window.location.search);
        const raw = params.get('pos');
        if(raw === '2') return 'POS2';
        if(raw === '3') return 'POS3';
      }catch(err){
        console.warn('Unable to parse POS selector from URL:', err);
      }
      return 'POS1';
    }

    const POS_ID = derivePosId();
    const IS_POS1 = POS_ID === 'POS1';
    const POS_IDS = ['POS1','POS2','POS3'];
    const POS_QUERY_VALUE = { POS1:'1', POS2:'2', POS3:'3' };


    // 2025 Season + Day split
    const SEASON = '2025';
    let DAY = 'SAT'; // default; can switch to 'SUN'

    const BRAND = {
      enabled: true,
      name: "Stratford Meridian",
      logoSquare: "https://i.imgur.com/K3AnfdH.png",
      logoText: "https://i.imgur.com/K3AnfdH.png",
      link: null
    };

    // POS/Admin editing state
    let currentPriceEdit = null;
    let lastFocusBeforePriceModal = null;
    let priceToastTimeout = null;
    let currentItemModal = null;
    let currentCustomerName = '';
    let customerNameModalEl = null;
    let lastFocusBeforeNameModal = null;
    let zellePhoneModalEl = null;
    let zellePhoneInputEl = null;
    let lastFocusBeforeZelleModal = null;
    let pendingZellePhoneCallback = null;
    let displayNameRef = null;

    // Zelle account state
    let activeZelleAccount = null;
    let zelleAccountConfig = {};
    let zelleConfigRef = null;
    let zelleCurrentAccountRef = null;
    let zelleFeeConfig = { enabled:false, amountCents:0 };
    let zelleFeeRef = null;
    let latestZelleAccountTotals = {};

    // App state
    let total = 0;
    let orderList = [];
    let orderNumber = 0; // per-day, as in original
    let currentOrderRef = null;
    let orderHistory = {};
    let orderTrackingFilter = 'ALL';
    let ordersRef = null;
    let isTotalOverwritten = false;
    const oosMap = {}; // effective OOS state per code
    const manualOosMap = {}; // manual toggles only
    const inventoryState = { SAT:{}, SUN:{} };
    const inventoryInputTimers = {};
    const inventoryDomCache = { day:null, items:{}, emptyEl:null, totalItems:0 };
    let inventoryListenerRef = null;
    let inventoryLoaded = { SAT:false, SUN:false };
    const inventoryFilterState = { search:'', pill:'ALL' };
    let activeInventoryTooltip = null;
    let activeInventoryTooltipTimeout = null;
    const latestOrdersSnapshot = { SAT:{}, SUN:{} };
    let ordersDeltaListener = null;
    let posBrandBadgeEl = null;
    let displayBrandFloatingEl = null;
    const paymentState = {
      processing:false,
      processingMessage:'',
      lastOrderKey:null,
      lastOrderPath:null,
      lastOrderNumber:null,
      lastMethod:null,
      lastOrderDetails:null,
      lastDisplayPayload:null,
      lastOrderBaseSubtotal:0
    };
    let paymentToastTimeout = null;

   /* ==========================
       MENU (2025 — per day)
       ========================== */
    const MENU_DAYS = ['SAT','SUN'];
    const DEFAULT_TICKET_COLORS = ['Purple','Red','Green','Blue'];
    let itemsAdminDay = 'SAT';

    const menuState = {
      SAT:{ ref:null, loaded:false, map:{}, ordered:[], active:[] },
      SUN:{ ref:null, loaded:false, map:{}, ordered:[], active:[] }
    };

    let ticketColorsRef = null;
    let ticketColors = DEFAULT_TICKET_COLORS.slice();
    const ticketCounterElements = {};

    function menuPathForDay(day){
      return `menu/${SEASON}/${day}`;
    }

    function normalizeTicketColorValue(value){
      if(value === undefined || value === null) return '';
      const raw = String(value).trim();
      if(raw === '') return '';
      const lower = raw.toLowerCase();
      if(lower === 'na' || lower === 'n/a' || lower === 'none') return '';
      return raw;
    }

    function normalizeMenuItem(day, code, raw){
      const name = raw && raw.name ? String(raw.name).trim() : code;
      const priceRaw = raw && raw.price !== undefined ? Number(raw.price) : 0;
      const price = Number.isFinite(priceRaw) ? round2(priceRaw) : 0;
      const ticketColor = normalizeTicketColorValue(raw && raw.ticketColor);
      const image = raw && raw.image ? String(raw.image).trim() : '';
      const active = raw && raw.active === false ? false : true;
      const sortRaw = raw && raw.sort !== undefined ? Number(raw.sort) : 100;
      const sort = Number.isFinite(sortRaw) ? sortRaw : 100;
      return { code, name, price, ticketColor, image, active, sort, day };
    }

    function updateMenuState(day, value){
      const node = value || {};
      const map = {};
      Object.keys(node).forEach(code=>{
        map[code] = normalizeMenuItem(day, code, node[code]);
      });
      const ordered = Object.values(map).sort((a,b)=>{
        const sortDiff = (a.sort||0) - (b.sort||0);
        if(sortDiff !== 0) return sortDiff;
        const nameDiff = a.name.localeCompare(b.name);
        if(nameDiff !== 0) return nameDiff;
        return a.code.localeCompare(b.code);
      });
      const active = ordered.filter(item=>item.active !== false);
      menuState[day] = Object.assign(menuState[day] || {}, { map, ordered, active, loaded:true });
      rebuildItemCodeMap();
      if(day === DAY){
        initializeMenuItems();
        syncTicketCounters();
        refreshInventoryListener();
        renderInventoryView();
      }
      if(day === itemsAdminDay){
        renderItemsAdminTable();
      }
    }

    function attachMenuListeners(){
      MENU_DAYS.forEach(day=>{
        if(menuState[day] && menuState[day].ref){
          menuState[day].ref.off();
        }
        const ref = db.ref(menuPathForDay(day));
        menuState[day].ref = ref;
        ref.on('value', snapshot=>{
          updateMenuState(day, snapshot.val());
        });
      });
    }

    function menuForDay(dayValue){
      const state = menuState[dayValue] || menuState.SAT;
      return state ? state.ordered : [];
    }

    function activeMenuForDay(dayValue){
      const state = menuState[dayValue] || menuState.SAT;
      return state ? state.active : [];
    }

    function currentMenu(){
      return activeMenuForDay(DAY);
    }

    function getMenuItemByCode(day, code){
      const state = menuState[day] || menuState.SAT;
      if(!state || !state.map) return null;
      return state.map[code] || null;
    }

    function getOrderedMenu(day){
      const state = menuState[day] || menuState.SAT;
      return state ? state.ordered : [];
    }

    function getEffectivePriceFor(item){
      if(!item) return 0;
      const price = Number(item.price);
      return Number.isFinite(price) ? price : 0;
    }

    function getEffectiveTicketColorLabel(item){
      if(!item) return null;
      const value = normalizeTicketColorValue(item.ticketColor);
      return value === '' ? null : value;
    }

    function renderTicketCounters(){
      const container = document.getElementById('ticket-counter-container');
      if(!container) return;
      container.innerHTML = '';
      Object.keys(ticketCounterElements).forEach(key=>{ delete ticketCounterElements[key]; });
      if(ticketColors.length === 0){
        const placeholder = document.createElement('div');
        placeholder.className = 'ticket';
        const label = document.createElement('div');
        label.className = 'ticket-label';
        label.textContent = 'No Colors';
        const count = document.createElement('span');
        count.className = 'ticket-count';
        count.textContent = '0';
        placeholder.appendChild(label);
        placeholder.appendChild(count);
        container.appendChild(placeholder);
        return;
      }
      ticketColors.forEach(color=>{
        const wrapper = document.createElement('div');
        wrapper.className = 'ticket';
        const label = document.createElement('div');
        label.className = 'ticket-label';
        const normalized = color.toLowerCase();
        label.setAttribute('data-color', normalized);
        label.classList.add(`ticket-${normalized.replace(/[^a-z0-9-]/g,'-')}`);
        label.textContent = color;
        const countEl = document.createElement('span');
        countEl.className = 'ticket-count';
        countEl.textContent = '0';
        wrapper.appendChild(label);
        wrapper.appendChild(countEl);
        container.appendChild(wrapper);
        ticketCounterElements[color] = countEl;
      });
    }

    function populateTicketColorSelect(selectEl, selectedValue){
      if(!selectEl) return;
      const current = selectedValue === undefined ? selectEl.value : selectedValue;
      selectEl.innerHTML = '';
      const noneOption = document.createElement('option');
      noneOption.value = '';
      noneOption.textContent = 'N/A';
      selectEl.appendChild(noneOption);
      ticketColors.forEach(color=>{
        const opt = document.createElement('option');
        opt.value = color;
        opt.textContent = color;
        selectEl.appendChild(opt);
      });
      selectEl.value = current || '';
      selectEl.setAttribute('data-selected', selectEl.value);
    }

    function updateTicketColorSelects(){
      const editSelect = document.getElementById('edit-ticket-color-select');
      if(editSelect){
        populateTicketColorSelect(editSelect, editSelect.getAttribute('data-selected') || editSelect.value || '');
      }
      const modalSelect = document.getElementById('item-ticket-select');
      if(modalSelect){
        populateTicketColorSelect(modalSelect, modalSelect.getAttribute('data-selected') || modalSelect.value || '');
      }
      renderItemsAdminTable();
      renderTicketColorManager();
    }

    function attachTicketColorsListener(){
      if(ticketColorsRef){
        ticketColorsRef.off();
      }
      ticketColorsRef = db.ref(`tickets/${SEASON}/colors`);
      ticketColorsRef.on('value', snapshot=>{
        const value = snapshot.val();
        let next = Array.isArray(value) ? value.map(v=>normalizeTicketColorValue(v)).filter(Boolean) : [];
        const deduped = [];
        next.forEach(color=>{
          if(!deduped.some(existing=>existing.toLowerCase() === color.toLowerCase())){
            deduped.push(color);
          }
        });
        if(deduped.length === 0){
          deduped.push(...DEFAULT_TICKET_COLORS);
          db.ref(`tickets/${SEASON}/colors`).set(deduped).catch(err=>{
            console.error('Unable to seed default ticket colors', err);
          });
        }
        ticketColors = deduped;
        renderTicketCounters();
        updateTicketColorSelects();
        syncTicketCounters();
      });
    }

    function normalizePosValue(raw){
      if(raw === 'POS2' || raw === 'POS3') return raw;
      return 'POS1';
    }

    // Map name -> code (rebuild when needed)
    const itemCodeMap = {};
    function rebuildItemCodeMap(){
      Object.keys(itemCodeMap).forEach(k=>delete itemCodeMap[k]);
      currentMenu().forEach(it => {
        itemCodeMap[it.name] = it.code;
      });
    }

    /* ==========================
       Quotes (Display Mode)
       ========================== */
    const quotes = [
      'যদি তোর ডাক শুনে কেউ না আসে তবে একলা চলো রে',
      'আমার মুক্তি আলোয় আলোয় এই আকাশে',
      'প্রাণ ভরিয়ে, তৃষা হরিয়ে, মোরে আরো আরো আরো দাও প্রাণ',
      'আমার সকল রসের ধারা তুমি হরছো শুকায়ে',
      'দাও ফিরে সে অরণ্য লও এ নগর',
      'পুরানো সেই দিনের কথা ভুলবি কিরে হায়',
      'আমি চিরতরে দূরে চলে যাবো তবু আমারে দেবো না ভুলিতে',
      'তুমি সন্ধ্যার মেঘমালা তুমি তারার আলো',
      'তুমি রবে নীরবে হৃদয়ে মম',
      'হৃদয় আমার নাচেরে আজিকে ময়ূরের মত নাচেরে'
    ];
    let currentQuoteIndex = 0, quoteInterval;

    /* ==========================
       Mode: POS vs Display
       ========================== */
    function setMode(mode){
      if(mode==='Display' && !IS_POS1){
        alert('Display Mode is only available on POS1.');
        return;
      }
      if(mode==='POS'){
        document.body.classList.remove('display-mode');
        document.querySelector('.item-grid').style.display='flex';
        document.querySelector('.order-summary').style.display='block';
        document.querySelector('.top-section').style.display='flex';
        document.querySelector('.bottom-tabs').style.display='flex';
        document.querySelector('.qr-section').style.display='none';
        ensurePOSBrandBadge();
        refreshDisplayFloatingBrand(false);
        if(currentOrderRef){ currentOrderRef.off(); currentOrderRef=null; }
        resetDisplayPanels();
        clearInterval(quoteInterval);
      }else{
        document.body.classList.add('display-mode');
        document.querySelector('.item-grid').style.display='none';
        document.querySelector('.order-summary').style.display='none';
        document.querySelector('.top-section').style.display='none';
        document.querySelector('.bottom-tabs').style.display='none';
        document.querySelector('.qr-section').style.display='flex';
        refreshDisplayFloatingBrand(true);
        updateZelleAccountDisplay();
        resetDisplayPanels();

        currentOrderRef = firebase.database().ref('currentOrder');
        currentOrderRef.on('value',(snapshot)=>{
          renderDisplayState(snapshot.val());
        });
        rotateQuotes();
      }
    }

    function resetDisplayPanels(){
      const container = document.getElementById('display-container');
      const left = document.getElementById('display-order-list');
      const right = document.getElementById('display-payment-panel');
      if(left) left.innerHTML='';
      if(right){
        right.innerHTML='';
        right.style.display='none';
      }
      if(container) container.style.display='none';
      const quoteEl = document.getElementById('quote-container');
      if(quoteEl) quoteEl.style.display='block';
      const nameBanner = document.getElementById('display-name-banner');
      if(nameBanner){
        nameBanner.classList.remove('active');
        nameBanner.textContent='';
      }
    }

    function buildBrandBadge(options={}){
      if(!BRAND.enabled) return null;
      const tag = BRAND.link ? 'a' : 'div';
      const badge = document.createElement(tag);
      badge.className = 'brand-badge brand-ghost';
      if(BRAND.link){
        badge.href = BRAND.link;
        badge.target = '_blank';
        badge.rel = 'noopener noreferrer';
      }else{
        badge.style.pointerEvents = 'none';
      }
      const img = document.createElement('img');
      img.src = options.logo || BRAND.logoSquare;
      img.alt = `${BRAND.name} logo`;
      badge.appendChild(img);
      const text = document.createElement('span');
      text.textContent = `Powered by ${BRAND.name}`;
      badge.appendChild(text);
      if(options.small) badge.style.fontSize = '11px';
      return badge;
    }

    function ensurePOSBrandBadge(){
      const topSection = document.querySelector('.top-section');
      if(!topSection){
        if(posBrandBadgeEl){ posBrandBadgeEl.remove(); posBrandBadgeEl=null; }
        return;
      }
      if(!BRAND.enabled){
        if(posBrandBadgeEl){ posBrandBadgeEl.remove(); posBrandBadgeEl=null; }
        return;
      }
      if(posBrandBadgeEl && posBrandBadgeEl.parentElement===topSection) return;
      if(posBrandBadgeEl) posBrandBadgeEl.remove();
      const badge = buildBrandBadge({ logo:BRAND.logoText });
      if(badge){
        badge.style.marginLeft = 'auto';
        posBrandBadgeEl = badge;
        topSection.appendChild(posBrandBadgeEl);
      }
    }

    function refreshDisplayFloatingBrand(isDisplay){
      if(!BRAND.enabled){
        if(displayBrandFloatingEl){ displayBrandFloatingEl.remove(); displayBrandFloatingEl=null; }
        return;
      }
      if(!displayBrandFloatingEl){
        const badge = buildBrandBadge({ logo:BRAND.logoSquare, small:true });
        if(badge){
          badge.classList.add('display-brand');
          displayBrandFloatingEl = badge;
          document.body.appendChild(displayBrandFloatingEl);
        }
      }
      if(displayBrandFloatingEl) displayBrandFloatingEl.style.display = isDisplay ? 'inline-flex' : 'none';
    }

    function renderDisplayState(data){
      const container = document.getElementById('display-container');
      const left = document.getElementById('display-order-list');
      const right = document.getElementById('display-payment-panel');
      const quoteEl = document.getElementById('quote-container');
      const displayNameBanner = document.getElementById('display-name-banner');
      if(!container || !left || !right) return;

      const formatMoney = (value)=>{
        const num = Number(value);
        return Number.isFinite(num) ? num.toFixed(2) : '0.00';
      };

      const items = Array.isArray(data && data.items) ? data.items : [];
      const totalValue = formatMoney(data && data.total);
      const subtotalValue = formatMoney((data && data.subtotal!==undefined) ? data.subtotal : (data && data.total));
      const rawFeeCents = Number(data && data.zelleFeeCents);
      const feeCents = Number.isFinite(rawFeeCents) ? rawFeeCents : 0;
      const feeValue = (feeCents/100).toFixed(2);
      const hasItems = items.length>0;
      const paymentMethod = data && data.paymentMethod;
      const feeEnabled = Boolean(data && data.zelleFeeEnabled);
      const shouldShowFee = paymentMethod==='Zelle' && feeEnabled;
      const showRight = paymentMethod==='Zelle' || paymentMethod==='Cash';
      const displayName = data && typeof data.name === 'string' ? data.name.trim() : '';
      const orderNumberValue = Number(data && data.orderNumber);
      const nextOrderNumberValue = Number(data && data.nextOrderNumber);
      const hasOrderNumber = Number.isFinite(orderNumberValue) && orderNumberValue > 0;
      const hasNextOrderNumber = Number.isFinite(nextOrderNumberValue) && nextOrderNumberValue > 0;
      const effectiveOrderNumber = hasOrderNumber ? orderNumberValue : (hasNextOrderNumber ? nextOrderNumberValue : null);
      const shouldShow = hasItems || showRight || Boolean(displayName);

      if(displayNameBanner){
        displayNameBanner.classList.remove('active');
        displayNameBanner.textContent='';
      }

      if(!shouldShow){
        container.style.display='none';
        left.innerHTML='';
        right.innerHTML='';
        right.style.display='none';
        if(quoteEl) quoteEl.style.display='block';
        return;
      }

      container.style.display='grid';
      if(quoteEl) quoteEl.style.display='none';

      if(displayNameBanner){
        if(displayName){
          displayNameBanner.textContent = displayName;
          displayNameBanner.classList.remove('active');
          void displayNameBanner.offsetWidth;
          displayNameBanner.classList.add('active');
        }else{
          displayNameBanner.classList.remove('active');
        }
      }

      left.innerHTML='';
      const header = document.createElement('div');
      header.className='display-order-header';
      header.textContent='Current Order';
      left.appendChild(header);

      if(effectiveOrderNumber){
        const orderNumberInline = document.createElement('div');
        orderNumberInline.className='display-order-number display-order-number-inline';
        orderNumberInline.textContent = `Order #${effectiveOrderNumber}`;
        left.appendChild(orderNumberInline);
      }

      if(hasItems){
        const list = document.createElement('div');
        list.className='display-order-items';
        items.forEach(item=>{
          const qty = Number(item.quantity) || 0;
          const price = Number(item.price) || 0;
          const row = document.createElement('div');
          row.className='display-order-row';

          const info = document.createElement('div');
          info.className='display-order-info';
          const name = document.createElement('div');
          name.className='display-order-name';
          name.textContent = item.name || '';
          const meta = document.createElement('div');
          meta.className='display-order-meta';
          meta.textContent = `${qty} × $${formatMoney(price)}`;
          info.appendChild(name);
          info.appendChild(meta);

          const lineTotal = document.createElement('div');
          lineTotal.className='display-order-line-total';
          lineTotal.textContent = `$${formatMoney(qty * price)}`;

          row.appendChild(info);
          row.appendChild(lineTotal);
          list.appendChild(row);
        });
        left.appendChild(list);

        const totalsContainer = document.createElement('div');
        totalsContainer.className='display-left-totals';
        if(shouldShowFee){
          const subtotalRow = document.createElement('div');
          subtotalRow.className='display-left-total-row subtotal';
          subtotalRow.innerHTML = `<span>Subtotal</span><span>$${subtotalValue}</span>`;
          totalsContainer.appendChild(subtotalRow);

          const feeRow = document.createElement('div');
          feeRow.className='display-left-total-row fee';
          feeRow.innerHTML = `<span>Processing fee</span><span>$${feeValue}</span>`;
          totalsContainer.appendChild(feeRow);
        }
        const totalRow = document.createElement('div');
        totalRow.className='display-left-total-row grand';
        const totalLabel = shouldShowFee ? 'Grand Total' : 'Total';
        const totalAmount = shouldShowFee ? totalValue : subtotalValue;
        totalRow.innerHTML = `<span>${totalLabel}</span><span>$${totalAmount}</span>`;
        totalsContainer.appendChild(totalRow);
        left.appendChild(totalsContainer);
      }else{
        const empty = document.createElement('div');
        empty.className='display-left-empty';
        empty.textContent = 'No items yet.';
        left.appendChild(empty);
      }

      if(showRight){
        right.style.display='flex';
        right.innerHTML='';
        if(paymentMethod==='Zelle'){
          const logo = document.createElement('img');
          logo.src = 'https://i.imgur.com/UsEzWqE.png';
          logo.alt = 'Zelle logo';
          logo.className='display-zelle-logo';
          right.appendChild(logo);

          if(effectiveOrderNumber){
            const orderNumberEl = document.createElement('div');
            orderNumberEl.className='display-order-number';
            orderNumberEl.textContent = `Order #${effectiveOrderNumber}`;
            right.appendChild(orderNumberEl);
          }

          const totalEl = document.createElement('div');
          totalEl.className='display-total';
          totalEl.textContent = `$${totalValue}`;
          right.appendChild(totalEl);

          const memo = document.createElement('div');
          memo.className='display-memo';
          memo.textContent = `Memo: ${hasOrderNumber ? orderNumberValue : '—'}`;
          right.appendChild(memo);

          const accountCode = (data && data.zelleAccount) || activeZelleAccount;
          const info = getZelleAccountInfo(accountCode) || {};
          const qrUrl = info.qr;
          if(qrUrl){
            const qr = document.createElement('img');
            qr.src = qrUrl;
            qr.alt = 'Zelle QR';
            qr.className='display-qr';
            right.appendChild(qr);
          }else{
            const missing = document.createElement('div');
            missing.className='qr-missing';
            missing.textContent = 'QR not set';
            right.appendChild(missing);
          }
          if(BRAND.enabled){
            const badge = buildBrandBadge({ logo:BRAND.logoSquare, small:true });
            if(badge) right.appendChild(badge);
          }
        }else if(paymentMethod==='Cash'){
          const logo = document.createElement('img');
          logo.src = 'https://assets.cdn.filesafe.space/slWdpqUTRhMfisMySSJ0/media/66f7050f5b684e16ab132d41.jpeg';
          logo.alt = 'Company Logo';
          logo.className='logo display-right-logo';
          right.appendChild(logo);

          if(effectiveOrderNumber){
            const orderNumberEl = document.createElement('div');
            orderNumberEl.className='display-order-number';
            orderNumberEl.textContent = `Order #${effectiveOrderNumber}`;
            right.appendChild(orderNumberEl);
          }

          const totalEl = document.createElement('div');
          totalEl.className='display-total';
          totalEl.textContent = `$${totalValue}`;
          right.appendChild(totalEl);
        }
      }else{
        right.innerHTML='';
        right.style.display='none';
      }
    }

    function rotateQuotes(){
      const qc = document.getElementById('quote-container');
      qc.innerText = quotes[currentQuoteIndex];
      quoteInterval = setInterval(()=>{
        currentQuoteIndex = (currentQuoteIndex+1) % quotes.length;
        qc.innerText = quotes[currentQuoteIndex];
      },10000);
    }

    function toggleFullscreen(){
      const qrSection = document.querySelector('.qr-section');
      if(!document.fullscreenElement){
        if(qrSection.requestFullscreen) qrSection.requestFullscreen();
        else if(qrSection.webkitRequestFullscreen) qrSection.webkitRequestFullscreen();
        else if(qrSection.msRequestFullscreen) qrSection.msRequestFullscreen();
      }else{
        if(document.exitFullscreen) document.exitFullscreen();
        else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
        else if(document.msExitFullscreen) document.msExitFullscreen();
      }
    }

    /* ==========================
       POS: Add/Remove + Tickets
       ========================== */
    function addItem(item){
      if(!item) return;
      const code = item.code || itemCodeMap[item.name];
      if(oosMap[code]) return; // blocked when out of stock
      const available = getInventoryAvailableForCode(code);
      const existing = orderList.find(i=>i.code===code);
      const currentQty = existing ? existing.quantity : 0;
      if(available !== Infinity && available <= currentQty){
        showPriceToast(`Only ${Math.max(0, available)} left`);
        return;
      }
      if(existing) existing.quantity += 1;
      else orderList.push({
        code,
        name:item.name,
        price:item.price,
        ticketColor:item.ticketColor || null,
        quantity:1
      });
      total = round2(total + item.price);
      updateOrderSummary();
      syncTicketCounters();
    }

    function removeItem(code){
      const idx = orderList.findIndex(i=>i.code===code);
      if(idx>-1){
        const it = orderList[idx];
        total = Math.max(0, round2(total - (it.price*it.quantity)));
        orderList.splice(idx,1);
        updateOrderSummary();
        syncTicketCounters();
      }
    }

    function updateOrderSummary(){
      const listEl = document.getElementById('order-list');
      const totalEl = document.getElementById('total-price-summary');
      listEl.innerHTML='';
      orderList.forEach(item=>{
        const row = document.createElement('div');
        row.className='order-item';
        row.innerHTML = `<span>${item.name} x ${item.quantity}</span>
                         <span>$${(item.price*item.quantity).toFixed(2)}</span>`;
        const del = document.createElement('button');
        del.className='delete-item';
        del.innerHTML='&times;';
        del.onclick=()=>removeItem(item.code);
        row.appendChild(del);
        listEl.appendChild(row);
      });
      totalEl.innerText = total.toFixed(2);
      syncCurrentOrderBroadcast();
      refreshOrderMetaUI();
    }

    function syncTicketCounters(){
      const counts = {};
      ticketColors.forEach(color=>{ counts[color] = 0; });
      orderList.forEach(item=>{
        const qty = Number(item.quantity)||0;
        const color = item.ticketColor ? String(item.ticketColor).trim() : '';
        if(color && Object.prototype.hasOwnProperty.call(counts, color)){
          counts[color] += qty;
        }
      });
      ticketColors.forEach(color=>{
        const el = ticketCounterElements[color];
        if(el){
          el.textContent = counts[color] || 0;
        }
      });
    }

    function getNextOrderNumber(){
      const base = Number(orderNumber);
      return Number.isFinite(base) ? base + 1 : 1;
    }

    function updateCurrentOrderHeading(){
      const heading = document.getElementById('current-order-heading');
      if(heading){
        heading.textContent = currentCustomerName ? `${currentCustomerName} — ${POS_ID}` : `Current Order — ${POS_ID}`;
      }
      const posChip = document.getElementById('current-pos-chip');
      if(posChip){
        posChip.textContent = POS_ID;
      }
    }

    function refreshOrderMetaUI(){
      updateCurrentOrderHeading();
      const numberEl = document.getElementById('current-order-number');
      if(numberEl){
        numberEl.textContent = getNextOrderNumber();
      }
      updatePaymentStatusUI();
    }

    function setPaymentButtonsDisabled(disabled){
      ['cash-payment-button','zelle-payment-button'].forEach(id=>{
        const btn = document.getElementById(id);
        if(btn){
          btn.disabled = disabled;
          btn.classList.toggle('is-disabled', disabled);
        }
      });
    }

    function showPaymentStatus(message, options={}){
      const row = document.getElementById('payment-status-row');
      const chip = document.getElementById('payment-status-chip');
      const changeBtn = document.getElementById('payment-change-link');
      if(!row || !chip) return;
      chip.textContent = message;
      row.classList.remove('hide');
      const changeTarget = options.changeTarget;
      if(changeBtn){
        if(changeTarget){
          changeBtn.textContent = `Change to ${changeTarget}`;
          changeBtn.dataset.targetMethod = changeTarget;
          changeBtn.classList.remove('hide');
          changeBtn.disabled = Boolean(options.disableChange);
        }else{
          changeBtn.classList.add('hide');
          changeBtn.disabled = true;
          delete changeBtn.dataset.targetMethod;
        }
      }
    }

    function hidePaymentStatus(){
      const row = document.getElementById('payment-status-row');
      const changeBtn = document.getElementById('payment-change-link');
      if(row) row.classList.add('hide');
      if(changeBtn){
        changeBtn.classList.add('hide');
        changeBtn.disabled = true;
        delete changeBtn.dataset.targetMethod;
      }
    }

    function updatePaymentStatusUI(){
      if(paymentState.processing){
        showPaymentStatus(paymentState.processingMessage || 'Working…', { disableChange:true });
        return;
      }
      if(paymentState.lastOrderKey && paymentState.lastOrderNumber && paymentState.lastMethod){
        let changeTarget = null;
        if(paymentState.lastMethod === 'Cash' && IS_POS1){
          changeTarget = 'Zelle';
        }else if(paymentState.lastMethod === 'Zelle'){
          changeTarget = 'Cash';
        }
        showPaymentStatus(`Recorded as ${paymentState.lastMethod} (Order #${paymentState.lastOrderNumber})`, {
          changeTarget,
          disableChange: !changeTarget
        });
      }else{
        hidePaymentStatus();
      }
    }

    function showPaymentToast(message, variant='success'){
      const toast = document.getElementById('payment-toast');
      if(!toast) return;
      if(paymentToastTimeout){
        clearTimeout(paymentToastTimeout);
        paymentToastTimeout = null;
      }
      toast.textContent = message;
      if(variant === 'error'){
        toast.classList.add('error');
      }else{
        toast.classList.remove('error');
      }
      toast.classList.add('show');
      paymentToastTimeout = setTimeout(()=>{
        toast.classList.remove('show');
      }, 2600);
    }

    function hidePaymentToast(){
      const toast = document.getElementById('payment-toast');
      if(toast){
        toast.classList.remove('show');
      }
      if(paymentToastTimeout){
        clearTimeout(paymentToastTimeout);
        paymentToastTimeout = null;
      }
    }

    function resetPaymentState(){
      paymentState.processing = false;
      paymentState.processingMessage = '';
      paymentState.lastOrderKey = null;
      paymentState.lastOrderPath = null;
      paymentState.lastOrderNumber = null;
      paymentState.lastMethod = null;
      paymentState.lastOrderDetails = null;
      paymentState.lastDisplayPayload = null;
      paymentState.lastOrderBaseSubtotal = 0;
      setPaymentButtonsDisabled(false);
      hidePaymentStatus();
      hidePaymentToast();
    }

    function getRecordedBaseSubtotal(){
      const stored = Number(paymentState.lastOrderBaseSubtotal);
      if(Number.isFinite(stored) && stored>=0){
        return stored;
      }
      const detailSubtotal = paymentState.lastOrderDetails && paymentState.lastOrderDetails.subtotal !== undefined
        ? Number(paymentState.lastOrderDetails.subtotal)
        : NaN;
      if(Number.isFinite(detailSubtotal) && detailSubtotal>=0){
        return detailSubtotal;
      }
      return round2(total);
    }

    function lastOrderRefPath(){
      if(paymentState.lastOrderPath){
        return paymentState.lastOrderPath;
      }
      if(paymentState.lastOrderKey){
        return `${ordersPath()}/${paymentState.lastOrderKey}`;
      }
      return null;
    }

    function buildCurrentOrderItemsSnapshot(){
      return orderList.map(item=>({
        code:item.code,
        name:item.name,
        price:item.price,
        ticketColor:item.ticketColor || null,
        quantity:item.quantity
      }));
    }

    function syncCurrentOrderBroadcast(){
      if(!db || !IS_POS1) return;
      const subtotalString = round2(total).toFixed(2);
      const payload = {
        items: buildCurrentOrderItemsSnapshot(),
        total: subtotalString,
        subtotal: subtotalString,
        nextOrderNumber: getNextOrderNumber(),
        orderNumber: null,
        paymentMethod: null,
        zelleAccount: null
      };
      const feeSnapshot = getZelleFeeSnapshot();
      payload.zelleFeeEnabled = feeSnapshot.enabled;
      payload.zelleFeeCents = feeSnapshot.enabled ? feeSnapshot.amountCents : 0;
      payload.name = currentCustomerName ? currentCustomerName : null;
      db.ref('currentOrder').update(payload);
    }

    function displayCurrentNamePath(){ return `display/${SEASON}/${DAY}/current/name`; }

    function applyCustomerName(name, options={}){
      const normalized = typeof name === 'string' ? name.trim() : '';
      currentCustomerName = normalized;
      updateCurrentOrderHeading();
      if(!options.skipBroadcast && IS_POS1){
        syncCurrentOrderBroadcast();
      }
      if(options.skipRemote || !IS_POS1) return;
      const ref = db.ref(displayCurrentNamePath());
      if(normalized){
        ref.set(normalized);
      }else{
        ref.remove();
      }
    }

    function openCustomerNameModal(){
      if(!customerNameModalEl){ customerNameModalEl = document.getElementById('customer-name-modal'); }
      const modal = customerNameModalEl;
      if(!modal) return;
      lastFocusBeforeNameModal = document.activeElement;
      modal.style.display='block';
      const input = document.getElementById('customer-name-input');
      if(input){
        input.value = currentCustomerName;
        setTimeout(()=>input.focus(),0);
      }
      modal.addEventListener('keydown', handleCustomerNameModalKeydown);
    }

    function closeCustomerNameModal(){
      if(!customerNameModalEl){ customerNameModalEl = document.getElementById('customer-name-modal'); }
      const modal = customerNameModalEl;
      if(!modal) return;
      modal.style.display='none';
      modal.removeEventListener('keydown', handleCustomerNameModalKeydown);
      const input = document.getElementById('customer-name-input');
      if(input) input.blur();
      if(lastFocusBeforeNameModal && typeof lastFocusBeforeNameModal.focus === 'function'){
        lastFocusBeforeNameModal.focus();
      }
      lastFocusBeforeNameModal = null;
    }

    function handleCustomerNameModalKeydown(event){
      if(event.key === 'Escape'){
        event.preventDefault();
        closeCustomerNameModal();
      }else if(event.key === 'Enter'){
        event.preventDefault();
        saveCustomerName();
      }
    }

    function saveCustomerName(){
      const input = document.getElementById('customer-name-input');
      if(!input) return;
      applyCustomerName(input.value);
      closeCustomerNameModal();
    }

    function skipCustomerName(){
      closeCustomerNameModal();
    }

    function refreshDisplayNameListener(){
      if(displayNameRef){ displayNameRef.off(); }
      displayNameRef = db.ref(displayCurrentNamePath());
      displayNameRef.on('value', snapshot=>{
        const remoteName = snapshot.val();
        applyCustomerName(remoteName || '', { skipRemote:true });
      });
    }

    /* ==========================
       Payment Flow (Cash / Zelle)
       ========================== */
    function processPayment(method){
      if(orderList.length===0){ alert('Add at least one item.'); return; }
      if(paymentState.processing){ return; }
      if(paymentState.lastOrderKey){
        showPaymentToast('Order already recorded. Use the change link or Next Customer.', 'error');
        return;
      }

      if(method==='Zelle' && !IS_POS1){
        alert('Zelle payments can only be recorded on POS1.');
        return;
      }

      if(method==='Zelle' && !activeZelleAccount){
        alert('Select a Zelle account before recording a Zelle payment.');
        return;
      }

      const finalizePayment = (zellePhoneValue, zellePhoneDigits)=>{
        paymentState.processing = true;
        paymentState.processingMessage = `Recording ${method}…`;
        setPaymentButtonsDisabled(true);
        updatePaymentStatusUI();

        const previousOrderNumber = Number(orderNumber) || 0;
        orderNumber = previousOrderNumber + 1; // keep per-day sequence
        const recordedOrderNumber = Number(orderNumber);
        const orderItemsSnapshot = buildCurrentOrderItemsSnapshot();
        const quantityMap = mapOrderItemsQuantities(orderItemsSnapshot);
        const availability = ensureInventoryAvailability(quantityMap);
        if(!availability.ok){
          const first = availability.insufficient[0];
          paymentState.processing = false;
          paymentState.processingMessage = '';
          orderNumber = previousOrderNumber;
          refreshOrderMetaUI();
          setPaymentButtonsDisabled(false);
          hidePaymentStatus();
          const limitMessage = first && first.code ? `Only ${Math.max(0, first.available)} left for ${first.code}` : 'Not enough stock to record this order.';
          showPaymentToast(limitMessage, 'error');
          return;
        }
        const deltaMap = buildInventoryDeltaFromQuantities(quantityMap, -1);
        const feeSnapshot = getZelleFeeSnapshot();
        const subtotalValueNumber = round2(total);
        const baseTotalCents = Math.max(0, Math.round(subtotalValueNumber * 100));
        const shouldApplyFee = method==='Zelle' && feeSnapshot.enabled;
        const appliedFeeCents = shouldApplyFee ? feeSnapshot.amountCents : 0;
        const finalTotalCents = baseTotalCents + appliedFeeCents;
        const finalTotalValue = (finalTotalCents/100).toFixed(2);
        const subtotalString = (baseTotalCents/100).toFixed(2);

        const orderDetails = {
          orderNumber: recordedOrderNumber,
          items: orderItemsSnapshot,
          total: finalTotalValue,
          method,
          passFee: false,
          fee: '0.00',
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          overwritten: isTotalOverwritten,
          day: DAY
        };
        orderDetails.name = currentCustomerName || null;
        orderDetails.customerName = orderDetails.name;
        orderDetails.subtotal = subtotalString;
        orderDetails.zelleFeeEnabled = shouldApplyFee;
        orderDetails.zelleFeeCents = appliedFeeCents;
        if(method==='Zelle'){
          orderDetails.zelleStatus = 'PENDING';
          orderDetails.zelleAccount = activeZelleAccount;
          orderDetails.zellePhone = typeof zellePhoneValue === 'string' ? zellePhoneValue : '';
          if(zellePhoneDigits){ orderDetails.zellePhoneDigits = zellePhoneDigits; }
        }

        const currentOrderPayload = {
          items: orderItemsSnapshot,
          total: finalTotalValue,
          subtotal: subtotalString,
          paymentMethod: method,
          orderNumber: recordedOrderNumber,
          nextOrderNumber: getNextOrderNumber(),
          name: currentCustomerName || null,
          zelleFeeEnabled: shouldApplyFee,
          zelleFeeCents: appliedFeeCents
        };
        if(method==='Zelle') currentOrderPayload.zelleAccount = activeZelleAccount;

        let inventoryCommitted = false;
        applyInventoryTransactionDelta(DAY, deltaMap).then(()=>{
          inventoryCommitted = true;
          return saveOrderToFirebase(orderDetails);
        }).then(({ key })=>{
          paymentState.processing = false;
          paymentState.processingMessage = '';
          paymentState.lastOrderKey = key;
          paymentState.lastOrderPath = `${ordersPath()}/${key}`;
          paymentState.lastOrderNumber = recordedOrderNumber;
          paymentState.lastMethod = method;
          paymentState.lastOrderDetails = Object.assign({}, orderDetails);
          paymentState.lastOrderBaseSubtotal = baseTotalCents/100;
          paymentState.lastDisplayPayload = IS_POS1 ? Object.assign({}, currentOrderPayload) : null;
          updatePaymentStatusUI();
          showPaymentToast(`✅ Payment recorded: ${method} (Order #${recordedOrderNumber})`);
          if(IS_POS1){
            db.ref('currentOrder').set(currentOrderPayload).catch(err=>{
              console.error('Unable to update display order', err);
            });
          }
        }).catch(err=>{
          console.error('Unable to record payment', err);
          paymentState.processing = false;
          paymentState.processingMessage = '';
          orderNumber = previousOrderNumber;
          refreshOrderMetaUI();
          setPaymentButtonsDisabled(false);
          hidePaymentStatus();
          if(inventoryCommitted){
            applyInventoryTransactionDelta(DAY, invertDeltaMap(deltaMap), { skipRender:false }).catch(revertErr=>{
              console.error('Inventory rollback failed', revertErr);
            });
            showPaymentToast("Couldn't record payment. Try again.", 'error');
          }else{
            const message = err && err.message ? err.message : 'Not enough stock to record this order.';
            showPaymentToast(message, 'error');
          }
        });

        // Operator still presses "Next Customer" when ready (manual step kept)
        refreshOrderMetaUI();
      };

      if(method==='Zelle'){
        openZellePhoneModal(finalizePayment);
      }else{
        finalizePayment('', '');
      }
    }

    function handlePaymentChangeClick(event){
      if(event) event.preventDefault();
      if(paymentState.processing) return;
      const target = event && event.currentTarget ? event.currentTarget.dataset.targetMethod : null;
      if(!target) return;
      switchPaymentMethod(target);
    }

    function switchPaymentMethod(targetMethod){
      if(!paymentState.lastOrderKey || paymentState.processing) return;
      if(!targetMethod || targetMethod === paymentState.lastMethod) return;
      if(targetMethod === 'Zelle'){
        if(!IS_POS1){
          showPaymentToast('Only POS1 can record Zelle payments.', 'error');
          return;
        }
        if(!activeZelleAccount){
          alert('Select a Zelle account before switching to Zelle.');
          return;
        }
        openZellePhoneModal((value, digits)=>{
          performSwitchToZelle(value, digits);
        });
      }else if(targetMethod === 'Cash'){
        performSwitchToCash();
      }
    }

    function performSwitchToZelle(zellePhoneValue, zellePhoneDigits){
      const path = lastOrderRefPath();
      if(!path) return;
      const orderRef = db.ref(path);
      const baseSubtotal = getRecordedBaseSubtotal();
      const baseCents = Math.max(0, Math.round(baseSubtotal * 100));
      const feeSnapshot = getZelleFeeSnapshot();
      const appliedFeeCents = feeSnapshot.enabled ? feeSnapshot.amountCents : 0;
      const finalTotalCents = baseCents + appliedFeeCents;
      const totalValue = (finalTotalCents/100).toFixed(2);
      const subtotalValue = (baseCents/100).toFixed(2);
      paymentState.processing = true;
      paymentState.processingMessage = 'Switching to Zelle…';
      updatePaymentStatusUI();
      const updates = {
        method:'Zelle',
        total: totalValue,
        subtotal: subtotalValue,
        zelleStatus:'PENDING',
        zelleAccount: activeZelleAccount || null,
        zelleFeeEnabled: feeSnapshot.enabled,
        zelleFeeCents: appliedFeeCents,
        zellePhone: typeof zellePhoneValue === 'string' ? zellePhoneValue : '',
        zellePhoneDigits: zellePhoneDigits ? zellePhoneDigits : null,
        passFee:false,
        fee:'0.00'
      };
      orderRef.update(updates).then(()=>{
        paymentState.processing = false;
        paymentState.processingMessage = '';
        paymentState.lastMethod = 'Zelle';
        paymentState.lastOrderDetails = Object.assign({}, paymentState.lastOrderDetails || {}, updates, {
          method:'Zelle',
          total: totalValue,
          subtotal: subtotalValue
        });
        if(!zellePhoneDigits && paymentState.lastOrderDetails){
          delete paymentState.lastOrderDetails.zellePhoneDigits;
        }
        paymentState.lastOrderBaseSubtotal = baseCents/100;
        if(IS_POS1 && paymentState.lastDisplayPayload){
          const payload = Object.assign({}, paymentState.lastDisplayPayload, {
            paymentMethod:'Zelle',
            total: totalValue,
            subtotal: subtotalValue,
            zelleAccount: activeZelleAccount || null,
            zelleFeeEnabled: feeSnapshot.enabled,
            zelleFeeCents: appliedFeeCents
          });
          paymentState.lastDisplayPayload = payload;
          db.ref('currentOrder').update(payload).catch(err=>{
            console.error('Unable to update display order', err);
          });
        }
        updatePaymentStatusUI();
        showPaymentToast(`✅ Payment updated: Zelle (Order #${paymentState.lastOrderNumber})`);
      }).catch(err=>{
        console.error('Unable to switch to Zelle', err);
        paymentState.processing = false;
        paymentState.processingMessage = '';
        updatePaymentStatusUI();
        showPaymentToast("Couldn't update payment. Try again.", 'error');
      });
    }

    function performSwitchToCash(){
      const path = lastOrderRefPath();
      if(!path) return;
      const orderRef = db.ref(path);
      const baseSubtotal = getRecordedBaseSubtotal();
      const baseCents = Math.max(0, Math.round(baseSubtotal * 100));
      const baseValue = (baseCents/100).toFixed(2);
      paymentState.processing = true;
      paymentState.processingMessage = 'Switching to Cash…';
      updatePaymentStatusUI();
      const updates = {
        method:'Cash',
        total: baseValue,
        subtotal: baseValue,
        zelleFeeEnabled:false,
        zelleFeeCents:0,
        zelleStatus:null,
        zelleAccount:null,
        zellePhone:null,
        zellePhoneDigits:null
      };
      orderRef.update(updates).then(()=>{
        paymentState.processing = false;
        paymentState.processingMessage = '';
        paymentState.lastMethod = 'Cash';
        if(!paymentState.lastOrderDetails) paymentState.lastOrderDetails = {};
        paymentState.lastOrderDetails.method = 'Cash';
        paymentState.lastOrderDetails.total = baseValue;
        paymentState.lastOrderDetails.subtotal = baseValue;
        paymentState.lastOrderDetails.zelleFeeEnabled = false;
        paymentState.lastOrderDetails.zelleFeeCents = 0;
        delete paymentState.lastOrderDetails.zelleStatus;
        delete paymentState.lastOrderDetails.zelleAccount;
        delete paymentState.lastOrderDetails.zellePhone;
        delete paymentState.lastOrderDetails.zellePhoneDigits;
        paymentState.lastOrderBaseSubtotal = baseCents/100;
        if(IS_POS1 && paymentState.lastDisplayPayload){
          const payload = Object.assign({}, paymentState.lastDisplayPayload, {
            paymentMethod:'Cash',
            total: baseValue,
            subtotal: baseValue,
            zelleAccount:null,
            zelleFeeEnabled:false,
            zelleFeeCents:0
          });
          paymentState.lastDisplayPayload = payload;
          db.ref('currentOrder').update(payload).catch(err=>{
            console.error('Unable to update display order', err);
          });
        }
        updatePaymentStatusUI();
        showPaymentToast(`✅ Payment updated: Cash (Order #${paymentState.lastOrderNumber})`);
      }).catch(err=>{
        console.error('Unable to switch to Cash', err);
        paymentState.processing = false;
        paymentState.processingMessage = '';
        updatePaymentStatusUI();
        showPaymentToast("Couldn't update payment. Try again.", 'error');
      });
    }

    function openZellePhoneModal(onComplete){
      if(typeof onComplete !== 'function'){ onComplete = ()=>{}; }
      if(!zellePhoneModalEl){ zellePhoneModalEl = document.getElementById('zelle-phone-modal'); }
      if(!zellePhoneModalEl){
        onComplete('', '');
        return;
      }
      pendingZellePhoneCallback = onComplete;
      if(!zellePhoneInputEl){ zellePhoneInputEl = document.getElementById('zelle-phone-input'); }
      lastFocusBeforeZelleModal = document.activeElement;
      zellePhoneModalEl.style.display='block';
      if(zellePhoneInputEl){
        zellePhoneInputEl.value = '';
        setTimeout(()=>zellePhoneInputEl.focus(),0);
      }
      zellePhoneModalEl.addEventListener('keydown', handleZellePhoneModalKeydown);
    }

    function closeZellePhoneModal(){
      if(!zellePhoneModalEl){ zellePhoneModalEl = document.getElementById('zelle-phone-modal'); }
      const modal = zellePhoneModalEl;
      if(!modal) return;
      modal.style.display='none';
      modal.removeEventListener('keydown', handleZellePhoneModalKeydown);
      if(!zellePhoneInputEl){ zellePhoneInputEl = document.getElementById('zelle-phone-input'); }
      if(zellePhoneInputEl) zellePhoneInputEl.blur();
      if(lastFocusBeforeZelleModal && typeof lastFocusBeforeZelleModal.focus === 'function'){
        lastFocusBeforeZelleModal.focus();
      }
      lastFocusBeforeZelleModal = null;
    }

    function completeZellePhoneFlow(value, digits){
      closeZellePhoneModal();
      const callback = pendingZellePhoneCallback;
      pendingZellePhoneCallback = null;
      if(typeof callback === 'function'){
        callback(value, digits);
      }
    }

    function handleZellePhoneSave(){
      if(!pendingZellePhoneCallback){
        closeZellePhoneModal();
        return;
      }
      if(!zellePhoneInputEl){ zellePhoneInputEl = document.getElementById('zelle-phone-input'); }
      const rawValue = zellePhoneInputEl ? zellePhoneInputEl.value : '';
      const normalized = normalizeZellePhoneInput(rawValue);
      completeZellePhoneFlow(normalized.value, normalized.digits);
    }

    function handleZellePhoneSkip(){
      if(!pendingZellePhoneCallback){
        closeZellePhoneModal();
        return;
      }
      completeZellePhoneFlow('', '');
    }

    function handleZellePhoneModalKeydown(event){
      if(event.key === 'Escape'){
        event.preventDefault();
        handleZellePhoneSkip();
      }else if(event.key === 'Enter'){
        event.preventDefault();
        handleZellePhoneSave();
      }
    }

    function normalizeZellePhoneInput(rawInput){
      const raw = (rawInput || '').trim();
      if(!raw){ return { value:'', digits:'' }; }
      const digitsOnly = raw.replace(/\D/g,'');
      if(digitsOnly.length===10){
        return { value:`+1${digitsOnly}`, digits:digitsOnly };
      }
      if(digitsOnly.length===11 && digitsOnly.startsWith('1')){
        const lastTen = digitsOnly.slice(1);
        return { value:`+1${lastTen}`, digits:lastTen };
      }
      return { value:raw, digits:digitsOnly };
    }

    /* ==========================
       Edit Total
       ========================== */
    function openEditTotalModal(){
      document.getElementById('new-total-price').value = total.toFixed(2);
      document.getElementById('edit-total-modal').style.display='block';
    }
    function closeEditTotalModal(){ document.getElementById('edit-total-modal').style.display='none'; }
    function updateTotalPrice(){
      const newTotal = parseFloat(document.getElementById('new-total-price').value);
      if(!isNaN(newTotal) && newTotal>=0){
        total = round2(newTotal);
        updateOrderSummary();
        isTotalOverwritten = true;
        closeEditTotalModal();
      }else{
        alert('Please enter a valid amount.');
      }
    }

    /* ==========================
       Save / Load Orders
       ========================== */
    function ordersPath(){ return `orders/${SEASON}/${DAY}`; }
    function posCounterPath(){ return `counters/${SEASON}/${DAY}/${POS_ID}`; }

    function saveOrderToFirebase(orderDetails){
      return new Promise((resolve, reject)=>{
        const counterRef = db.ref(posCounterPath());
        counterRef.transaction(currentValue=>{
          const currentNumber = Number(currentValue) || 0;
          return currentNumber + 1;
        }, (error, committed, snapshot)=>{
          if(error || !committed){
            console.error('Unable to increment POS counter', error);
            reject(error || new Error('Counter not committed'));
            return;
          }
          const snapshotValue = snapshot && typeof snapshot.val === 'function' ? snapshot.val() : null;
          const numericPos = Number(snapshotValue);
          const posOrderNumber = Number.isFinite(numericPos) && numericPos > 0 ? numericPos : null;
          if(posOrderNumber === null){
            console.warn('POS counter returned unexpected value:', snapshotValue);
          }
          const payload = Object.assign({}, orderDetails, {
            pos: POS_ID,
            posOrderNumber
          });
          const ref = db.ref(ordersPath()).push();
          ref.set(payload).then(()=>{
            resolve({ key: ref.key, payload });
          }).catch(err=>{
            console.error('Error saving order:', err);
            reject(err);
          });
        }, false);
      });
    }

    function deleteOrder(orderKey){
      if(!orderKey) return;
      if(confirm('Are you sure you want to delete this order?')){
        const ref = db.ref(`${ordersPath()}/${orderKey}`);
        ref.remove().then(()=>{
          delete orderHistory[orderKey];
          const row = document.querySelector(`#order-log tr[data-order-key="${orderKey}"]`);
          if(row && row.parentNode){ row.parentNode.removeChild(row); }
          const remainingNumbers = Object.values(orderHistory)
            .map(o=>Number(o.orderNumber))
            .filter(n=>!isNaN(n));
          orderNumber = remainingNumbers.length ? Math.max(...remainingNumbers) : 0;
          refreshOrderMetaUI();
          applyOrderTrackingFilter();
        }).catch(err=>{
          console.error('Error deleting order:', err);
          alert('An error occurred while deleting the order.');
        });
      }
    }

    function loadOrdersFromFirebase(){
      if(ordersRef) ordersRef.off();
      const dayKey = DAY;
      ordersRef = db.ref(ordersPath());
      ordersRef.on('value',(snapshot)=>{
        const orders = snapshot.val();
        orderHistory = {};
        const normalized = {};
        const tbody = document.getElementById('order-log');
        tbody.innerHTML = '';
        if(orders){
          // Build dynamic item columns header (only once)
          buildDynamicHeader();

          Object.keys(orders).forEach(key=>{
            const order = orders[key];
            logOrder(key, order);
            normalized[key] = normalizeOrderForSnapshot(order);
          });
          const numbers = Object.values(orders).map(o=>Number(o.orderNumber)).filter(n=>!isNaN(n));
          orderNumber = numbers.length>0 ? Math.max(...numbers) : 0;
        }else{
          orderNumber = 0;
        }
        latestOrdersSnapshot[dayKey] = normalized;
        refreshOrderMetaUI();
        applyOrderTrackingFilter();
      });
      attachOrderDeltaListeners();
    }

    function attachOrderDeltaListeners(){
      if(ordersDeltaListener && ordersDeltaListener.ref){
        ordersDeltaListener.ref.off();
        ordersDeltaListener = null;
      }
      if(!IS_POS1){
        return;
      }
      const dayKey = DAY;
      const ref = db.ref(ordersPath());
      ref.on('child_changed', snapshot=>{
        const key = snapshot.key;
        if(!key) return;
        handleOrderInventoryChange(dayKey, key, snapshot.val());
      });
      ref.on('child_removed', snapshot=>{
        const key = snapshot.key;
        if(!key) return;
        handleOrderInventoryRemoval(dayKey, key, snapshot.val());
      });
      ordersDeltaListener = { ref, day: dayKey };
    }

    function handleOrderInventoryChange(dayKey, orderKey, newOrder){
      if(!IS_POS1) return;
      const snapshotMap = latestOrdersSnapshot[dayKey] || {};
      const previous = snapshotMap[orderKey];
      const normalized = normalizeOrderForSnapshot(newOrder);
      snapshotMap[orderKey] = normalized;
      latestOrdersSnapshot[dayKey] = snapshotMap;
      if(!previous){
        return;
      }
      const prevQty = mapOrderItemsQuantities(previous.items);
      const nextQty = mapOrderItemsQuantities(normalized.items);
      const deltaMap = {};
      const codes = new Set([...Object.keys(prevQty), ...Object.keys(nextQty)]);
      codes.forEach(code=>{
        const diff = (nextQty[code] || 0) - (prevQty[code] || 0);
        if(diff !== 0){
          deltaMap[code] = -diff;
        }
      });
      if(Object.keys(deltaMap).length === 0) return;
      applyInventoryTransactionDelta(dayKey, deltaMap, { skipRender:false }).catch(err=>{
        console.error('Inventory adjustment failed after order edit', err);
        showPaymentToast('Inventory sync issue after edit.', 'error');
      });
    }

    function handleOrderInventoryRemoval(dayKey, orderKey, removedOrder){
      if(!IS_POS1) return;
      const snapshotMap = latestOrdersSnapshot[dayKey] || {};
      const previous = snapshotMap[orderKey] || normalizeOrderForSnapshot(removedOrder);
      delete snapshotMap[orderKey];
      latestOrdersSnapshot[dayKey] = snapshotMap;
      const qtyMap = mapOrderItemsQuantities(previous.items);
      const deltaMap = {};
      Object.keys(qtyMap).forEach(code=>{
        const qty = qtyMap[code];
        if(qty) deltaMap[code] = qty;
      });
      if(Object.keys(deltaMap).length === 0) return;
      applyInventoryTransactionDelta(dayKey, deltaMap, { skipRender:false }).catch(err=>{
        console.error('Inventory adjustment failed after order removal', err);
        showPaymentToast('Inventory sync issue after deletion.', 'error');
      });
    }

    function buildDynamicHeader(){
      // Rebuild the header cells for item codes based on current menu
      const theadRow = document.querySelector('#order-tracking thead tr');
      const codes = currentMenu().map(i=>i.code);
      theadRow.innerHTML = `
        <th>Order #</th>
        <th>POS</th>
        <th>POS Order #</th>
        <th>Time</th>
        <th>Name</th>
        ${codes.map(c=>`<th>${c}</th>`).join('')}
        <th>Total</th>
        <th>Zelle Phone</th>
        <th>Payment Method</th>
        <th>Pass Fee</th>
        <th>Fee</th>
        <th>Delete</th>
      `;
    }

    function logOrder(orderKey, order){
      const tbody = document.getElementById('order-log');
      const tr = document.createElement('tr');
      tr.setAttribute('data-order-key', orderKey);

      if(order.overwritten){ tr.classList.add('order-overwritten'); }

      const timeString = new Date(order.timestamp || Date.now()).toLocaleTimeString();

      const itemQuantities = {};
      currentMenu().forEach(i => itemQuantities[i.code] = '');

      if(order.items){
        order.items.forEach(it=>{
          const code = it.code || itemCodeMap[it.name];
          if(code) itemQuantities[code] = it.quantity;
        });
      }

      const codes = currentMenu().map(i=>i.code);
      const displayName = escapeHTML(order && order.name ? order.name : '');
      const zellePhoneDisplay = order && order.method === 'Zelle' ? escapeHTML(order.zellePhone ?? '') : '';
      const normalizedPos = normalizePosValue(order && order.pos);
      const posDisplay = escapeHTML(normalizedPos);
      const hasPosOrderNumber = order && order.posOrderNumber !== undefined && order.posOrderNumber !== null && order.posOrderNumber !== 0;
      const posOrderNumberValue = hasPosOrderNumber ? order.posOrderNumber : '';
      const posOrderDisplay = posOrderNumberValue === '' ? '' : escapeHTML(String(posOrderNumberValue));
      tr.setAttribute('data-pos-id', normalizedPos);
      tr.innerHTML = `
        <td>${order.orderNumber ?? ''}</td>
        <td>${posDisplay}</td>
        <td>${posOrderDisplay}</td>
        <td>${timeString}</td>
        <td>${displayName}</td>
        ${codes.map(c=>`<td>${itemQuantities[c] ?? ''}</td>`).join('')}
        <td>$${(order.total ?? '0.00')}</td>
        <td>${zellePhoneDisplay}</td>
        <td>${order.method ?? ''}</td>
        <td>${order.passFee ? 'Yes' : 'No'}</td>
        <td>${order.fee ? ('$'+order.fee) : ''}</td>
        <td><button class="delete-order-button" onclick="deleteOrder('${orderKey}')">&times;</button></td>
      `;
      tbody.appendChild(tr);
      orderHistory[orderKey] = Object.assign({}, order, { pos: normalizedPos });
    }

    function downloadCSV(){
      let csv = "data:text/csv;charset=utf-8,";
      const codes = currentMenu().map(i=>i.code);
      csv += "Order #,POS,POS Order #,Time,Name," + codes.join(',') + ",Total,Zelle Phone,Payment Method,Pass Fee,Fee,Overwritten\n";
      Object.values(orderHistory).forEach(o=>{
        const timeString = new Date(o.timestamp || Date.now()).toLocaleString();
        const qty = {};
        currentMenu().forEach(i=>qty[i.code]='');
        if(o.items){ o.items.forEach(it=>{ const c = it.code || itemCodeMap[it.name]; if(c) qty[c]=it.quantity; }); }
        const nameValue = o.name ? String(o.name).replace(/"/g,'""') : '';
        const zellePhoneValue = (o.method === 'Zelle' && o.zellePhone) ? String(o.zellePhone) : '';
        const zellePhoneCell = zellePhoneValue ? `"${zellePhoneValue.replace(/"/g,'""')}"` : '';
        const posValue = normalizePosValue(o.pos);
        const posOrderValue = (o.posOrderNumber !== undefined && o.posOrderNumber !== null && o.posOrderNumber !== 0) ? String(o.posOrderNumber) : '';

        const row = [
          o.orderNumber ?? '',
          posValue,
          posOrderValue,
          `"${timeString}"`,
          `"${nameValue}"`,
          ...codes.map(c=>qty[c] ?? ''),
          o.total ?? '',
          zellePhoneCell,
          o.method ?? '',
          o.passFee ? 'Yes' : 'No',
          o.fee ?? '',
          o.overwritten ? 'Yes' : 'No'
        ];
        csv += row.join(',') + "\n";
      });
      const link = document.createElement('a');
      link.setAttribute('href', encodeURI(csv));
      link.setAttribute('download', `order_log_${SEASON}_${DAY}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function applyOrderTrackingFilter(){
      const rows = document.querySelectorAll('#order-log tr');
      rows.forEach(row=>{
        if(!row) return;
        const raw = row.getAttribute('data-pos-id');
        const rowPos = normalizePosValue(raw);
        const shouldShow = orderTrackingFilter === 'ALL' || orderTrackingFilter === rowPos;
        row.style.display = shouldShow ? '' : 'none';
      });
    }

    function setOrderTrackingFilter(filter){
      const normalized = (filter === 'ALL' || POS_IDS.includes(filter)) ? filter : 'ALL';
      orderTrackingFilter = normalized;
      const map = {
        'ALL':'pos-filter-all',
        'POS1':'pos-filter-pos1',
        'POS2':'pos-filter-pos2',
        'POS3':'pos-filter-pos3'
      };
      Object.entries(map).forEach(([key,id])=>{
        const btn = document.getElementById(id);
        if(btn){
          btn.classList.toggle('active', normalized === key);
        }
      });
      applyOrderTrackingFilter();
    }

    function clearAllOrders(){
      if(confirm('Are you sure you want to clear all orders for this day? This cannot be undone.')){
        db.ref(ordersPath()).remove().then(()=>{
          alert('All orders have been cleared for ' + DAY + '.');
          orderHistory = {};
          orderNumber = 0;
          document.getElementById('order-log').innerHTML='';
          refreshOrderMetaUI();
        }).catch(err=>{
          console.error('Error clearing orders:', err);
          alert('An error occurred while clearing orders.');
        });
      }
    }

    /* ==========================
       Zelle Confirmations (per-day)
       ========================== */
    function zellePathDay(){ return `orders/${SEASON}/${DAY}`; } // orders carry zelleStatus
    function zelleControlPath(){ return `zelle/${SEASON}/${DAY}`; }
    function zelleConfigPath(){ return `zelle/${SEASON}/config/accounts`; }
    function zelleCurrentAccountPath(){ return `${zelleControlPath()}/currentAccount`; }
    function zelleFeeConfigPath(){ return `${zelleControlPath()}/config/fee`; }

    function defaultZelleFeeConfig(){ return { enabled:false, amountCents:0 }; }

    function sanitizeZelleFeeConfig(raw){
      const base = defaultZelleFeeConfig();
      if(raw && typeof raw === 'object'){
        base.enabled = Boolean(raw.enabled);
        const amt = Number(raw.amountCents);
        if(Number.isFinite(amt) && amt>=0){
          const normalized = Math.round(amt);
          base.amountCents = Math.min(2000, Math.max(0, normalized));
        }
      }
      return base;
    }

    function applyZelleFeeConfig(raw){
      zelleFeeConfig = sanitizeZelleFeeConfig(raw);
      updateZelleFeeForm(zelleFeeConfig);
    }

    function getZelleFeeSnapshot(){
      return sanitizeZelleFeeConfig(zelleFeeConfig);
    }

    function updateZelleFeeForm(config){
      const toggle = document.getElementById('zelle-fee-toggle');
      const amount = document.getElementById('zelle-fee-amount');
      if(toggle) toggle.checked = Boolean(config && config.enabled);
      if(amount){
        const dollars = Number(config && config.amountCents ? config.amountCents : 0)/100;
        amount.value = dollars.toFixed(2);
      }
      handleZelleFeeToggleChange();
    }

    function handleZelleFeeToggleChange(){
      const toggle = document.getElementById('zelle-fee-toggle');
      const amount = document.getElementById('zelle-fee-amount');
      if(!toggle || !amount) return;
      amount.disabled = !toggle.checked;
    }

    function refreshZelleFeeListener(){
      if(!db) return;
      if(zelleFeeRef) zelleFeeRef.off();
      zelleFeeRef = db.ref(zelleFeeConfigPath());
      applyZelleFeeConfig(null);
      zelleFeeRef.on('value', snapshot=>{
        applyZelleFeeConfig(snapshot.val());
      }, error=>{
        console.error('Unable to load Zelle fee config', error);
        applyZelleFeeConfig(null);
        showPriceToast("Couldn't load Zelle fee; using $0.00");
      });
    }

    function saveZelleFeeSettings(){
      const toggle = document.getElementById('zelle-fee-toggle');
      const amountInput = document.getElementById('zelle-fee-amount');
      if(!toggle || !amountInput) return;
      const enabled = Boolean(toggle.checked);
      let amountValue = parseFloat(amountInput.value);
      if(isNaN(amountValue)) amountValue = 0;
      amountValue = Math.max(0, Math.min(20, amountValue));
      let amountCents = Math.round(amountValue * 100);
      amountCents = Math.max(0, Math.min(2000, amountCents));
      amountValue = amountCents/100;
      amountInput.value = amountValue.toFixed(2);
      const payload = { enabled, amountCents };
      db.ref(zelleFeeConfigPath()).set(payload)
        .then(()=>{
          zelleFeeConfig = sanitizeZelleFeeConfig(payload);
          showPriceToast('Zelle fee saved.');
        })
        .catch(err=>{
          console.error('Unable to save Zelle fee', err);
          const message = err && err.message ? err.message : 'Please try again.';
          alert('Unable to save Zelle fee: ' + message);
        });
    }
    function zelleSwitchLogPath(){ return `${zelleControlPath()}/switchLog`; }

    const ZELLE_ACCOUNT_CODES = ['AR','SKD','SC','PD'];
    const ZELLE_ACCOUNT_PLACEHOLDERS = {
      AR:{qr:'https://i.postimg.cc/3WyQRYtg/ar-test.jpg', label:'AR'},
      PD:{qr:'https://i.postimg.cc/c6Vyt2zP/pd-test.jpg', label:'PD'},
      SC:{qr:'https://i.postimg.cc/jLPVHv02/sc-test.jpg', label:'SC'},
      SKD:{qr:'https://i.postimg.cc/18QkJ6sH/skd-test.jpg', label:'SKD'}
    };
    const DEFAULT_ZELLE_ACCOUNT = 'AR';

    function firstAvailableZelleAccount(){
      return ZELLE_ACCOUNT_CODES.find(code=>getZelleAccountInfo(code)) || null;
    }

    function getZelleAccountInfo(account){
      if(!account) return null;
      const infoFromConfig = (zelleAccountConfig && zelleAccountConfig[account]) ? zelleAccountConfig[account] : null;
      return infoFromConfig || ZELLE_ACCOUNT_PLACEHOLDERS[account] || null;
    }

    function renderZelleAccountButtons(){
      const container = document.getElementById('zelle-account-buttons');
      if(!container) return;
      container.innerHTML = '';
      ZELLE_ACCOUNT_CODES.forEach(account=>{
        const btn = document.createElement('button');
        btn.type='button';
        btn.className='zelle-account-button';
        btn.setAttribute('data-zelle-account-button', account);
        btn.onclick = ()=>changeZelleAccount(account);
        container.appendChild(btn);
      });
      updateZelleAccountDisplay();
    }

    function updateZelleAccountDisplay(){
      const labelEl = document.getElementById('current-zelle-account');
      if(labelEl) labelEl.innerText = activeZelleAccount || '—';
      const detailEl = document.getElementById('current-zelle-account-detail');
      if(detailEl){
        const info = getZelleAccountInfo(activeZelleAccount) || {};
        const parts = [];
        if(info.label && info.label!==activeZelleAccount) parts.push(info.label);
        if(info.handle) parts.push(info.handle);
        if(parts.length){
          detailEl.innerText = parts.join(' • ');
          detailEl.style.display='inline';
        }else{
          detailEl.innerText='';
          detailEl.style.display='none';
        }
      }
      updateZelleAccountButtonsState();
      updateZelleAccountTotalsDisplay();
    }

    function updateZelleAccountButtonsState(){
      document.querySelectorAll('[data-zelle-account-button]').forEach(btn=>{
        const acct = btn.getAttribute('data-zelle-account-button');
        const info = getZelleAccountInfo(acct) || {};
        const isActive = acct===activeZelleAccount;
        const labelText = info.label && info.label!==acct ? info.label : '';
        const actionText = isActive ? 'Current' : 'Change';
        btn.innerHTML = `
          <span class="account-code">${acct}</span>
          ${labelText ? `<span class="account-label">${labelText}</span>` : ''}
          <span class="account-action">${actionText}</span>
        `;
        btn.classList.toggle('active', isActive);
        btn.disabled = isActive;
      });
    }

    function updateZelleAccountTotalsDisplay(totals){
      if(totals) latestZelleAccountTotals = totals;
      const source = latestZelleAccountTotals || {};
      const container = document.getElementById('zelle-account-totals');
      if(!container) return;
      container.innerHTML='';
      ZELLE_ACCOUNT_CODES.forEach(account=>{
        const info = getZelleAccountInfo(account) || {};
        const totalsForAccount = source[account] || { count:0, sum:0 };
        const count = totalsForAccount.count || 0;
        const sumRounded = round2(Number(totalsForAccount.sum || 0));
        const label = info.label && info.label!==account ? `${account} — ${info.label}` : account;
        const card = document.createElement('div');
        card.className = 'account-total-card' + (account===activeZelleAccount ? ' active' : '');
        card.innerHTML = `
          <strong>${label}</strong>
          <span>${count} order${count===1?'':'s'}</span>
          <span>$${sumRounded.toFixed(2)}</span>
        `;
        container.appendChild(card);
      });
    }

    function ensureZelleConfigSeeded(){
      db.ref(zelleConfigPath()).once('value').then(snap=>{
        if(!snap.exists()){
          db.ref(zelleConfigPath()).set(ZELLE_ACCOUNT_PLACEHOLDERS).catch(err=>{
            console.error('Error seeding Zelle config', err);
          });
        }
      }).catch(err=>{
        console.error('Error checking Zelle config', err);
      });
    }

    function persistZelleAccount(nextAccount, shouldLog){
      if(!nextAccount) return;
      const prev = activeZelleAccount;
      activeZelleAccount = nextAccount;
      updateZelleAccountDisplay();
      db.ref(zelleCurrentAccountPath()).set(nextAccount);
      if(shouldLog){
        db.ref(zelleSwitchLogPath()).push({
          from: prev || null,
          to: nextAccount,
          ts: firebase.database.ServerValue.TIMESTAMP
        });
      }
    }

    function changeZelleAccount(nextAccount){
      if(!nextAccount || nextAccount===activeZelleAccount) return;
      persistZelleAccount(nextAccount, true);
    }

    function loadZelleConfig(){
      if(zelleConfigRef) zelleConfigRef.off();
      zelleConfigRef = db.ref(zelleConfigPath());
      zelleConfigRef.on('value',(snap)=>{
        zelleAccountConfig = snap.val() || {};
        renderZelleAccountButtons();
        const fallback = firstAvailableZelleAccount() || DEFAULT_ZELLE_ACCOUNT;
        if(!activeZelleAccount && fallback){
          persistZelleAccount(fallback, false);
        }else{
          updateZelleAccountDisplay();
        }
      });
    }

    function refreshZelleCurrentAccountListener(){
      if(zelleCurrentAccountRef) zelleCurrentAccountRef.off();
      zelleCurrentAccountRef = db.ref(zelleCurrentAccountPath());
      zelleCurrentAccountRef.on('value',(snap)=>{
        const value = snap.val();
        if(value){
          activeZelleAccount = value;
          updateZelleAccountDisplay();
        }else{
          const fallback = firstAvailableZelleAccount() || DEFAULT_ZELLE_ACCOUNT;
          if(fallback) persistZelleAccount(fallback, false);
          else {
            activeZelleAccount = null;
            updateZelleAccountDisplay();
          }
        }
      });
    }

    let zelleRef = null;
    let zelleSwitchLogRef = null;

    function attachZelleListener(){
      if(zelleRef) zelleRef.off();
      const tbody = document.getElementById('zelle-body');
      tbody.innerHTML = '';

      zelleRef = db.ref(zellePathDay());
      zelleRef.on('value', (snap)=>{
        const orders = snap.val() || {};
        const zelleOrders = Object.entries(orders)
          .map(([key, o])=>({key, ...o}))
          .filter(o=>o.method==='Zelle');

        tbody.innerHTML='';
        if(zelleOrders.length===0){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="8" style="text-align:center;color:#666;">No Zelle orders yet.</td>`;
          tbody.appendChild(tr);
          updateZelleAccountTotalsDisplay({});
          return;
        }

        zelleOrders.sort((a,b)=>(a.orderNumber||0)-(b.orderNumber||0));

        const totals = {};
        ZELLE_ACCOUNT_CODES.forEach(code=>{ totals[code] = { count:0, sum:0 }; });

        zelleOrders.forEach(o=>{
          const tr = document.createElement('tr');
          const timeString = new Date(o.timestamp || Date.now()).toLocaleString();
          const status = o.zelleStatus || 'PENDING';
          const normalizedAccount = ZELLE_ACCOUNT_CODES.includes(o.zelleAccount) ? o.zelleAccount : null;
          if(normalizedAccount){
            totals[normalizedAccount].count += 1;
            totals[normalizedAccount].sum += Number(o.total || 0);
          }
          const accountDisplay = normalizedAccount || (o.zelleAccount || '—');
          const posDisplay = normalizePosValue(o.pos);
          tr.innerHTML = `
            <td>${timeString}</td>
            <td>${o.orderNumber || ''}</td>
            <td>${posDisplay}</td>
            <td>$${(o.total||'0.00')}</td>
            <td>${o.customerName || ''}</td>
            <td>${o.zellePhone || ''}</td>
            <td>${accountDisplay}</td>
            <td>${status}</td>
            <td>
              <button class="btn-small btn-ok" onclick="markZelleStatus('${o.key}','CONFIRMED')">Confirm</button>
              <button class="btn-small btn-warn" onclick="markZelleStatus('${o.key}','MISSING')">Missing</button>
              <button class="btn-small btn-muted" onclick="markZelleStatus('${o.key}','PENDING')">Reset</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        updateZelleAccountTotalsDisplay(totals);
      });
    }

    function attachZelleSwitchLogListener(){
      if(zelleSwitchLogRef) zelleSwitchLogRef.off();
      const listEl = document.getElementById('zelle-switch-log');
      const clearBtn = document.getElementById('switch-log-clear-button');
      if(clearBtn) clearBtn.style.display='none';
      if(listEl) listEl.innerHTML = '<div class="switch-log-empty">No switches yet.</div>';
      if(!listEl) return;
      zelleSwitchLogRef = db.ref(zelleSwitchLogPath());
      zelleSwitchLogRef.on('value',(snap)=>{
        const list = document.getElementById('zelle-switch-log');
        const clear = document.getElementById('switch-log-clear-button');
        if(!list) return;
        const value = snap.val() || {};
        const entries = Object.keys(value).map(key=>({ key, ...(value[key]||{}) }));
        entries.sort((a,b)=>(b.ts||0)-(a.ts||0));
        list.innerHTML='';
        if(entries.length===0){
          list.innerHTML = '<div class="switch-log-empty">No switches yet.</div>';
          if(clear) clear.style.display='none';
          return;
        }
        if(clear) clear.style.display='inline-flex';
        entries.forEach(entry=>{
          const row = document.createElement('div');
          row.className = 'switch-log-row';
          const timeSpan = document.createElement('span');
          timeSpan.className = 'switch-log-time';
          timeSpan.textContent = entry.ts ? new Date(entry.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
          const arrowSpan = document.createElement('span');
          arrowSpan.className = 'switch-log-arrow';
          const from = entry.from || '—';
          const to = entry.to || '—';
          arrowSpan.textContent = `${from} → ${to}`;
          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.className = 'switch-log-delete';
          delBtn.textContent = '×';
          delBtn.addEventListener('click',(evt)=>{
            evt.stopPropagation();
            deleteZelleSwitchLogEntry(entry.key);
          });
          row.appendChild(timeSpan);
          row.appendChild(arrowSpan);
          row.appendChild(delBtn);
          list.appendChild(row);
        });
      });
    }

    function deleteZelleSwitchLogEntry(id){
      if(!id) return;
      db.ref(`${zelleSwitchLogPath()}/${id}`).remove().catch(err=>{
        console.error('Error deleting switch log entry', err);
        alert('Unable to delete log entry: ' + err.message);
      });
    }

    function clearZelleSwitchLog(){
      if(!confirm('Clear the entire switch log for this day?')) return;
      db.ref(zelleSwitchLogPath()).remove().catch(err=>{
        console.error('Error clearing switch log', err);
        alert('Unable to clear switch log: ' + err.message);
      });
    }

    function markZelleStatus(orderKey, status){
      db.ref(`${zellePathDay()}/${orderKey}`).update({ zelleStatus: status, zelleCheckedTs: firebase.database.ServerValue.TIMESTAMP });
    }

    function downloadZelleCSV(){
      db.ref(zellePathDay()).once('value').then(snap=>{
        const orders = snap.val() || {};
        const rows = Object.values(orders).filter(o=>o.method==='Zelle');
        let csv = "data:text/csv;charset=utf-8,Time,Order #,POS,Total,Customer Name,Zelle Phone,Account,Status\n";
        rows.forEach(o=>{
          const t = new Date(o.timestamp || Date.now()).toLocaleString();
          const account = ZELLE_ACCOUNT_CODES.includes(o.zelleAccount) ? o.zelleAccount : (o.zelleAccount || '');
          const customerName = (o.customerName || '').replace(/"/g, '""');
          const zellePhone = (o.zellePhone || '').replace(/"/g, '""');
          const posValue = normalizePosValue(o.pos);
          csv += `"${t}",${o.orderNumber||''},${posValue},${o.total||''},"${customerName}","${zellePhone}",${account},${(o.zelleStatus||'PENDING')}\n`;
        });
        const link = document.createElement('a');
        link.setAttribute('href', encodeURI(csv));
        link.setAttribute('download', `zelle_${SEASON}_${DAY}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    }

    /* ==========================
       Inventory helpers + state sync
       ========================== */
    function sanitizeInventoryValue(raw){
      const value = Number(raw);
      if(!Number.isFinite(value) || value < 0) return 0;
      return Math.round(value);
    }

    function defaultInventoryRecord(){
      return { initial:0, current:0, updatedAt:null, track:true };
    }

    function getInventoryStateForDay(day){
      if(!inventoryState[day]) inventoryState[day] = {};
      return inventoryState[day];
    }

    function setInventoryRecordFromSnapshot(day, code, snapshot){
      const record = defaultInventoryRecord();
      if(snapshot && typeof snapshot === 'object'){
        record.initial = sanitizeInventoryValue(snapshot.initial);
        if(Object.prototype.hasOwnProperty.call(snapshot,'current')){
          record.current = sanitizeInventoryValue(snapshot.current);
        }else{
          record.current = record.initial;
        }
        if(Object.prototype.hasOwnProperty.call(snapshot,'updatedAt')){
          record.updatedAt = snapshot.updatedAt;
        }
        if(Object.prototype.hasOwnProperty.call(snapshot,'track')){
          record.track = Boolean(snapshot.track !== false);
        }
      }
      const state = getInventoryStateForDay(day);
      state[code] = record;
      return record;
    }

    function mergeInventoryRecord(day, code, partial){
      const state = getInventoryStateForDay(day);
      const existing = Object.assign({}, defaultInventoryRecord(), state[code]);
      if(partial && Object.prototype.hasOwnProperty.call(partial,'initial')){
        existing.initial = sanitizeInventoryValue(partial.initial);
      }
      if(partial && Object.prototype.hasOwnProperty.call(partial,'current')){
        existing.current = sanitizeInventoryValue(partial.current);
      }
      if(partial && Object.prototype.hasOwnProperty.call(partial,'updatedAt')){
        existing.updatedAt = partial.updatedAt;
      }
      if(partial && Object.prototype.hasOwnProperty.call(partial,'track')){
        existing.track = Boolean(partial.track);
      }
      if(existing.current < 0) existing.current = 0;
      state[code] = existing;
      return existing;
    }

    function inventoryItemPathForDay(day, code){
      return `stock/${SEASON}/${day}/${code}/inventory`;
    }

    function inventoryDayPathForDay(day){
      return `stock/${SEASON}/${day}`;
    }

    function getInventoryRecordForCode(code, day=DAY){
      const state = getInventoryStateForDay(day);
      if(!state[code]){
        state[code] = defaultInventoryRecord();
      }
      return state[code];
    }

    function computeInventoryPercent(initial, current){
      const safeInitial = Number(initial) || 0;
      const safeCurrent = Number(current) || 0;
      if(safeInitial <= 0){
        return safeCurrent > 0 ? 100 : 0;
      }
      const ratio = safeCurrent / safeInitial;
      if(ratio <= 0) return 0;
      if(ratio >= 1) return 100;
      return Math.round(ratio * 100);
    }

    function getInventoryAvailableForCode(code, day=DAY){
      const record = getInventoryRecordForCode(code, day);
      const current = Number(record.current) || 0;
      if(record.track === false){
        return Infinity;
      }
      return current;
    }

    function ensureInventoryAvailability(quantityMap){
      const insufficient = [];
      Object.keys(quantityMap || {}).forEach(code=>{
        const need = Number(quantityMap[code]) || 0;
        if(need <= 0) return;
        const available = getInventoryAvailableForCode(code);
        if(available < need){
          insufficient.push({ code, available: Math.max(0, available) });
        }
      });
      return { ok: insufficient.length === 0, insufficient };
    }

    function mapOrderItemsQuantities(source){
      const map = {};
      if(!source) return map;
      const list = Array.isArray(source) ? source : (Array.isArray(source.items) ? source.items : []);
      list.forEach(item=>{
        if(!item) return;
        const code = item.code || itemCodeMap[item.name];
        const qty = Number(item.quantity) || 0;
        if(!code || qty <= 0) return;
        map[code] = (map[code] || 0) + qty;
      });
      return map;
    }

    function buildInventoryDeltaFromQuantities(quantityMap, multiplier){
      const delta = {};
      Object.keys(quantityMap || {}).forEach(code=>{
        const qty = Number(quantityMap[code]) || 0;
        if(!qty) return;
        delta[code] = (delta[code] || 0) + qty * multiplier;
      });
      return delta;
    }

    function invertDeltaMap(deltaMap){
      const inverted = {};
      Object.keys(deltaMap || {}).forEach(code=>{
        const value = Number(deltaMap[code]) || 0;
        if(!value) return;
        inverted[code] = -value;
      });
      return inverted;
    }

    function normalizeOrderForSnapshot(order){
      if(!order || typeof order !== 'object') return { items: [] };
      const items = Array.isArray(order.items) ? order.items.map(it=>({
        code: it && (it.code || itemCodeMap[it.name]),
        quantity: Number(it && it.quantity) || 0
      })) : [];
      return { items };
    }

    function buildInventoryDom(dayKey, menu){
      const gridEl = document.getElementById('inventory-items-grid');
      if(!gridEl) return;
      gridEl.innerHTML = '';
      inventoryDomCache.day = dayKey;
      inventoryDomCache.items = {};
      inventoryDomCache.totalItems = menu.length;

      const emptyEl = document.createElement('div');
      emptyEl.id = 'inventory-empty-state';
      emptyEl.className = 'inventory-empty';
      emptyEl.textContent = inventoryLoaded[dayKey] ? (menu.length === 0 ? 'No items configured for this day.' : 'No items match filters.') : 'Loading inventory…';
      emptyEl.style.display = 'none';
      gridEl.appendChild(emptyEl);
      inventoryDomCache.emptyEl = emptyEl;

      menu.forEach(item=>{
        const rowDay = dayKey;
        const card = document.createElement('div');
        card.className = 'inventory-item-card';
        card.setAttribute('data-code', item.code);
        const searchText = `${item.name} ${item.code}`.toLowerCase();
        card.setAttribute('data-search-text', searchText);

        const header = document.createElement('div');
        header.className = 'inventory-card-header';

        const nameBlock = document.createElement('div');
        nameBlock.className = 'inventory-item-name';
        const nameEl = document.createElement('strong');
        nameEl.textContent = item.name;
        const codeBadge = document.createElement('span');
        codeBadge.className = 'inventory-item-code';
        codeBadge.textContent = item.code;
        nameBlock.appendChild(nameEl);
        nameBlock.appendChild(codeBadge);

        const toggleLabel = document.createElement('label');
        toggleLabel.className = 'inventory-track-toggle';
        toggleLabel.title = 'Toggle inventory tracking';
        const toggleInput = document.createElement('input');
        toggleInput.type = 'checkbox';
        toggleInput.addEventListener('change', event=>{
          handleInventoryTrackToggle(rowDay, item.code, event.target.checked);
        });
        const toggleText = document.createElement('span');
        toggleText.textContent = 'Track inventory';
        toggleLabel.appendChild(toggleInput);
        toggleLabel.appendChild(toggleText);

        header.appendChild(nameBlock);
        header.appendChild(toggleLabel);

        const metaRow = document.createElement('div');
        metaRow.className = 'inventory-card-meta';
        const soldSpan = document.createElement('span');
        soldSpan.innerHTML = 'Sold so far: <strong>0</strong>';
        const soldValue = soldSpan.querySelector('strong');
        const remainingSpan = document.createElement('span');
        remainingSpan.innerHTML = 'Current: <strong>0</strong>';
        const remainingValue = remainingSpan.querySelector('strong');
        metaRow.appendChild(soldSpan);
        metaRow.appendChild(remainingSpan);

        const barWrapper = document.createElement('div');
        barWrapper.className = 'inline-inventory-bar';
        const barTrack = document.createElement('div');
        barTrack.className = 'inline-inventory-track';
        const barFill = document.createElement('div');
        barFill.className = 'inline-inventory-fill';
        barTrack.appendChild(barFill);
        barWrapper.appendChild(barTrack);
        barWrapper.addEventListener('click', event=>{
          event.stopPropagation();
          const message = barWrapper.getAttribute('data-tooltip-message') || '';
          showInlineInventoryTooltip(card, message);
        });
        barWrapper.addEventListener('pointerdown', event=>{
          if(event.pointerType === 'touch' || event.pointerType === 'pen'){
            event.stopPropagation();
            const message = barWrapper.getAttribute('data-tooltip-message') || '';
            showInlineInventoryTooltip(card, message);
          }
        });

        const body = document.createElement('div');
        body.className = 'inventory-card-body';

        const inputGrid = document.createElement('div');
        inputGrid.className = 'inventory-input-grid';

        const initialGroup = document.createElement('div');
        initialGroup.className = 'inventory-input-group';
        const initialLabel = document.createElement('label');
        initialLabel.textContent = 'Initial';
        const initialInput = document.createElement('input');
        initialInput.type = 'number';
        initialInput.min = '0';
        initialInput.inputMode = 'numeric';
        initialInput.addEventListener('input', event=>{
          handleInventoryInputChange(rowDay, item.code, 'initial', event.target.value);
        });
        initialGroup.appendChild(initialLabel);
        initialGroup.appendChild(initialInput);

        const currentGroup = document.createElement('div');
        currentGroup.className = 'inventory-input-group';
        const currentLabel = document.createElement('label');
        currentLabel.textContent = 'Current';
        const currentInput = document.createElement('input');
        currentInput.type = 'number';
        currentInput.min = '0';
        currentInput.inputMode = 'numeric';
        currentInput.addEventListener('input', event=>{
          handleInventoryInputChange(rowDay, item.code, 'current', event.target.value);
        });
        currentGroup.appendChild(currentLabel);
        currentGroup.appendChild(currentInput);

        inputGrid.appendChild(initialGroup);
        inputGrid.appendChild(currentGroup);

        const quickRow = document.createElement('div');
        quickRow.className = 'inventory-quick-buttons';
        [-10, -1, 1, 10].forEach(delta=>{
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'inventory-quick-button';
          btn.textContent = delta > 0 ? `+${delta}` : `${delta}`;
          btn.addEventListener('click', ()=>handleInventoryQuickAdjust(rowDay, item.code, delta));
          quickRow.appendChild(btn);
        });

        const untrackedLabel = document.createElement('div');
        untrackedLabel.className = 'inventory-untracked-label';
        untrackedLabel.textContent = 'Untracked';

        const zeroWarning = document.createElement('div');
        zeroWarning.className = 'inventory-zero-warning';
        zeroWarning.textContent = '0 left';

        body.appendChild(inputGrid);
        body.appendChild(quickRow);
        body.appendChild(untrackedLabel);
        body.appendChild(zeroWarning);

        card.appendChild(header);
        card.appendChild(metaRow);
        card.appendChild(barWrapper);
        card.appendChild(body);

        gridEl.appendChild(card);

        inventoryDomCache.items[item.code] = {
          code: item.code,
          card,
          searchText,
          barWrapper,
          barFill,
          soldValue,
          remainingValue,
          initialInput,
          currentInput,
          inputGrid,
          quickRow,
          trackToggle: toggleInput,
          untrackedLabel,
          zeroWarning
        };
      });
    }

    function updateInventoryRowDisplay(dayKey, item, record){
      const cache = inventoryDomCache.items[item.code];
      if(!cache) return;
      const tracked = record.track !== false;
      const initial = Number(record.initial) || 0;
      const current = Number(record.current) || 0;
      const soldUnits = Math.max(0, initial - current);
      const percent = computeInventoryPercent(initial, current);
      cache.trackToggle.checked = tracked;
      cache.initialInput.value = initial;
      cache.currentInput.value = current;
      cache.initialInput.disabled = !tracked;
      cache.currentInput.disabled = !tracked;
      cache.soldValue.textContent = tracked ? soldUnits : '—';
      cache.remainingValue.textContent = tracked ? current : '—';

      if(tracked){
        cache.inputGrid.style.display = '';
        cache.quickRow.style.display = '';
        cache.barWrapper.style.display = '';
        cache.untrackedLabel.style.display = 'none';
        const message = current > 0 ? `${current} left` : 'No stock';
        cache.barWrapper.setAttribute('data-tooltip-message', message);
        cache.barWrapper.title = message;
        cache.barFill.style.width = `${percent}%`;
        cache.zeroWarning.style.display = current <= 0 ? 'inline-flex' : 'none';
      }else{
        cache.inputGrid.style.display = 'none';
        cache.quickRow.style.display = 'none';
        cache.barWrapper.style.display = 'none';
        cache.untrackedLabel.style.display = 'inline-flex';
        cache.zeroWarning.style.display = 'none';
        cache.barWrapper.removeAttribute('data-tooltip-message');
        cache.barWrapper.title = '';
      }

      const manual = Boolean(manualOosMap[item.code]);
      const isZero = tracked && current <= 0 && (initial > 0 || current === 0);
      const isLow = tracked && initial > 0 && percent > 0 && percent < 20;
      cache.card.classList.toggle('is-oos', manual);
      cache.card.classList.toggle('is-zero', isZero);
      cache.card.classList.toggle('is-low', isLow);
      cache.card.classList.toggle('is-untracked', !tracked);
      cache.card.setAttribute('data-percent', percent);
      cache.card.setAttribute('data-remaining', current);
      cache.card.setAttribute('data-tracked', tracked ? '1' : '0');
    }

    function renderInventoryView(){
      const gridEl = document.getElementById('inventory-items-grid');
      if(!gridEl) return;
      const dayKey = DAY;
      const menu = activeMenuForDay(DAY);

      const shouldRebuild = inventoryDomCache.day !== dayKey || menu.length !== inventoryDomCache.totalItems || menu.some(item=>!inventoryDomCache.items[item.code]);
      if(shouldRebuild){
        buildInventoryDom(dayKey, menu);
      }else{
        inventoryDomCache.totalItems = menu.length;
        if(inventoryDomCache.emptyEl){
          inventoryDomCache.emptyEl.style.display = 'none';
        }
      }

      let totalInitial = 0;
      let totalRemaining = 0;
      let totalSold = 0;
      let lowCount = 0;
      let zeroCount = 0;


      menu.forEach(item=>{
        const record = getInventoryRecordForCode(item.code, dayKey);
        updateInventoryRowDisplay(dayKey, item, record);
        if(record.track === false){

          return;
        }
        const initial = Number(record.initial) || 0;
        const current = Number(record.current) || 0;
        const soldUnits = Math.max(0, initial - current);
        const percent = computeInventoryPercent(initial, current);
        totalInitial += initial;
        totalRemaining += current;
        totalSold += soldUnits;
        if(initial > 0 && percent > 0 && percent < 20){
          lowCount++;

        }
        if(current <= 0){
          zeroCount++;
        }
      });

      if(inventoryDomCache.emptyEl){
        if(menu.length === 0){
          inventoryDomCache.emptyEl.textContent = inventoryLoaded[dayKey] ? 'No items configured for this day.' : 'Loading inventory…';
        }else if(inventoryLoaded[dayKey]){
          inventoryDomCache.emptyEl.textContent = 'No items match filters.';
        }else{
          inventoryDomCache.emptyEl.textContent = 'Loading inventory…';
        }
      }

      const totalInitialEl = document.getElementById('inventory-total-initial');
      if(totalInitialEl) totalInitialEl.textContent = totalInitial;
      const totalRemainingEl = document.getElementById('inventory-total-remaining');
      if(totalRemainingEl) totalRemainingEl.textContent = totalRemaining;
      const totalSoldEl = document.getElementById('inventory-total-sold');
      if(totalSoldEl) totalSoldEl.textContent = totalSold;
      const lowCountEl = document.getElementById('inventory-low-count');
      if(lowCountEl) lowCountEl.textContent = lowCount;
      const zeroCountEl = document.getElementById('inventory-zero-count');
      if(zeroCountEl) zeroCountEl.textContent = zeroCount;


      applyInventoryFilters();
    }


    function setInventorySearch(value){
      inventoryFilterState.search = (value || '').toString().trim().toLowerCase();
      applyInventoryFilters();
    }

    function setInventoryFilter(filter){
      const allowed = ['ALL','LOW','ZERO','UNTRACKED','TRACKED'];
      const normalized = allowed.includes(filter) ? filter : 'ALL';
      if(inventoryFilterState.pill === normalized) return;
      inventoryFilterState.pill = normalized;
      syncInventoryFilterButtons();
      applyInventoryFilters();
    }

    function syncInventoryFilterButtons(){
      const buttons = document.querySelectorAll('[data-inventory-filter]');
      buttons.forEach(btn=>{
        const filter = btn.getAttribute('data-inventory-filter');
        btn.classList.toggle('active', filter === inventoryFilterState.pill);
      });
    }

    function syncInventoryDayButtons(){
      const satBtn = document.getElementById('inventory-day-sat');
      const sunBtn = document.getElementById('inventory-day-sun');
      if(satBtn) satBtn.classList.toggle('active', DAY === 'SAT');
      if(sunBtn) sunBtn.classList.toggle('active', DAY === 'SUN');
    }

    function applyInventoryFilters(){
      const dayKey = inventoryDomCache.day || DAY;
      const entries = Object.values(inventoryDomCache.items || {});
      const searchTerm = inventoryFilterState.search;
      let visibleCount = 0;
      entries.forEach(cache=>{
        const record = getInventoryRecordForCode(cache.code, dayKey);
        const tracked = record.track !== false;
        const initial = Number(record.initial) || 0;
        const current = Number(record.current) || 0;
        const percent = computeInventoryPercent(initial, current);
        const searchValue = cache.searchText || '';
        const matchesSearch = !searchTerm || searchValue.includes(searchTerm);
        let matchesFilter = true;
        switch(inventoryFilterState.pill){
          case 'LOW':
            matchesFilter = tracked && initial > 0 && percent > 0 && percent < 20;
            break;
          case 'ZERO':
            matchesFilter = tracked && current <= 0;
            break;
          case 'UNTRACKED':
            matchesFilter = !tracked;
            break;
          case 'TRACKED':
            matchesFilter = tracked;
            break;
          default:
            matchesFilter = true;
        }
        const shouldShow = matchesSearch && matchesFilter;
        cache.card.style.display = shouldShow ? '' : 'none';
        if(shouldShow) visibleCount++;
      });

      const totalItems = inventoryDomCache.totalItems || entries.length;
      const dayLoaded = inventoryLoaded[dayKey];
      if(inventoryDomCache.emptyEl){
        if(totalItems === 0){
          inventoryDomCache.emptyEl.textContent = dayLoaded ? 'No items configured for this day.' : 'Loading inventory…';
          if(!dayLoaded){
            inventoryDomCache.emptyEl.textContent = 'Loading inventory…';
          }
          inventoryDomCache.emptyEl.style.display = 'block';
        }else if(visibleCount === 0){
          inventoryDomCache.emptyEl.textContent = dayLoaded ? 'No items match filters.' : 'Loading inventory…';
          inventoryDomCache.emptyEl.style.display = 'block';
        }else{
          inventoryDomCache.emptyEl.style.display = 'none';
        }
      }
    }

    function handleInventoryInputChange(dayKey, code, field, rawValue){
      const record = getInventoryRecordForCode(code, dayKey);
      if(record.track === false) return;
      const value = sanitizeInventoryValue(rawValue);
      mergeInventoryRecord(dayKey, code, { [field]: value });
      handleInventoryStateUpdate(dayKey, { skipRender:true });
      if(dayKey === DAY){
        renderInventoryView();
        updateItemCardInventoryBars();
      }
      scheduleInventoryWrite(dayKey, code);
    }

    function handleInventoryQuickAdjust(dayKey, code, delta){
      if(!Number.isFinite(delta)) return;
      const record = getInventoryRecordForCode(code, dayKey);
      if(record.track === false) return;
      const next = Math.max(0, (record.current || 0) + delta);
      mergeInventoryRecord(dayKey, code, { current: next });
      handleInventoryStateUpdate(dayKey, { skipRender:true });
      if(dayKey === DAY){
        renderInventoryView();
        updateItemCardInventoryBars();
      }
      scheduleInventoryWrite(dayKey, code);
    }

    function handleInventoryTrackToggle(dayKey, code, shouldTrack){
      mergeInventoryRecord(dayKey, code, { track: shouldTrack });
      handleInventoryStateUpdate(dayKey, { skipRender:true });
      if(dayKey === DAY){
        renderInventoryView();
        updateItemCardInventoryBars();
      }
      scheduleInventoryWrite(dayKey, code);
    }

    function scheduleInventoryWrite(dayKey, code){
      const key = `${dayKey}|${code}`;
      if(inventoryInputTimers[key]){
        clearTimeout(inventoryInputTimers[key]);
      }
      inventoryInputTimers[key] = setTimeout(()=>flushInventoryWrite(dayKey, code), 450);
    }

    function flushInventoryWrite(dayKey, code){
      const key = `${dayKey}|${code}`;
      if(inventoryInputTimers[key]){
        clearTimeout(inventoryInputTimers[key]);
        delete inventoryInputTimers[key];
      }
      const record = getInventoryRecordForCode(code, dayKey);
      const payload = {
        initial: record.initial || 0,
        current: record.current || 0,
        track: record.track === false ? false : true,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      };
      db.ref(inventoryItemPathForDay(dayKey, code)).update(payload).catch(err=>{
        console.error('Error updating inventory', err);
      });
    }

    function computeOosStateForDay(dayKey){
      const menu = menuForDay(dayKey);
      const result = {};
      menu.forEach(item=>{
        result[item.code] = Boolean(manualOosMap[item.code]);
      });
      return result;
    }

    function applyOosState(dayKey, nextState){
      let changed = false;
      if(dayKey !== DAY){
        Object.keys(nextState).forEach(code=>{
          oosMap[code] = nextState[code];
        });
        return changed;
      }
      Object.keys(nextState).forEach(code=>{
        const value = nextState[code];
        if(oosMap[code] !== value){
          changed = true;
        }
        oosMap[code] = value;
      });
      return changed;
    }

    function handleInventoryStateUpdate(dayKey, options={}){
      const next = computeOosStateForDay(dayKey);
      const changed = applyOosState(dayKey, next);
      if(dayKey === DAY){
        if(!options.skipRender){
          renderInventoryView();
        }
        if(changed){
          initializeMenuItems();
          searchItems();
        }else{
          updateItemCardInventoryBars();
        }
      }
    }

    function refreshInventoryListener(){
      if(inventoryListenerRef){
        inventoryListenerRef.off();
        inventoryListenerRef = null;
      }
      const dayKey = DAY;
      const ref = db.ref(inventoryDayPathForDay(dayKey));
      inventoryListenerRef = ref;
      ref.on('value', snapshot=>{
        const node = snapshot.val() || {};
        const menu = menuForDay(dayKey);
        menu.forEach(item=>{
          const codeNode = node[item.code] || {};
          const recordSnapshot = (codeNode && typeof codeNode === 'object' && codeNode.inventory && typeof codeNode.inventory === 'object') ? codeNode.inventory : null;
          setInventoryRecordFromSnapshot(dayKey, item.code, recordSnapshot);
        });
        inventoryLoaded[dayKey] = true;
        handleInventoryStateUpdate(dayKey);
      });
    }

    function runInventoryTransaction(dayKey, code, delta, options={}){
      const path = inventoryItemPathForDay(dayKey, code);
      let previousValue = 0;
      return new Promise((resolve, reject)=>{
        db.ref(path).transaction(current=>{
          const snapshotRecord = current && typeof current === 'object' ? current : null;
          const base = snapshotRecord ? Object.assign({}, snapshotRecord) : {};
          const initial = sanitizeInventoryValue(base.initial);
          const hasCurrent = Object.prototype.hasOwnProperty.call(base,'current');
          const currentValue = hasCurrent ? sanitizeInventoryValue(base.current) : initial;
          previousValue = currentValue;
          const nextValue = currentValue + delta;
          if(nextValue < 0){
            return;
          }
          const nextRecord = Object.assign({}, base, {
            initial,
            current: sanitizeInventoryValue(nextValue),
            updatedAt: firebase.database.ServerValue.TIMESTAMP
          });
          return nextRecord;
        }, (error, committed, snapshot)=>{
          if(error){
            reject(error);
            return;
          }
          if(!committed){
            resolve({ committed:false, available: previousValue });
            return;
          }
          const value = snapshot && snapshot.val ? snapshot.val() : null;
          setInventoryRecordFromSnapshot(dayKey, code, value);
          if(dayKey === DAY && !options.skipRender){
            renderInventoryView();
            updateItemCardInventoryBars();
          }
          resolve({ committed:true, available: previousValue, value });
        }, false);
      });
    }

    async function applyInventoryTransactionDelta(dayKey, deltaMap, options={}){
      const entries = Object.entries(deltaMap || {}).filter(([code, delta])=>{
        if(!Number(delta)) return false;
        const record = getInventoryRecordForCode(code, dayKey);
        return record.track !== false;
      });
      if(entries.length === 0){
        if(dayKey === DAY && !options.skipRender){
          renderInventoryView();
          updateItemCardInventoryBars();
        }
        return;
      }
      const applied = [];
      try{
        for(const [code, delta] of entries){
          const result = await runInventoryTransaction(dayKey, code, delta, { skipRender:true });
          if(!result.committed){
            const available = Math.max(0, result.available || 0);
            const error = new Error(`Only ${available} left`);
            error.code = code;
            error.available = available;
            throw error;
          }
          applied.push({ code, delta });
        }
      }catch(err){
        for(let i = applied.length-1; i>=0; i--){
          const entry = applied[i];
          try{
            await runInventoryTransaction(dayKey, entry.code, -entry.delta, { skipRender:true });
          }catch(revertErr){
            console.error('Inventory revert failed', revertErr);
          }
        }
        throw err;
      }finally{
        if(dayKey === DAY && !options.skipRender){
          renderInventoryView();
          updateItemCardInventoryBars();
        }
      }
    }

    function updateItemCardInventoryBars(){
      const cards = document.querySelectorAll('.item-box');
      cards.forEach(card=>{
        const code = card.getAttribute('data-code');
        if(!code) return;
        const record = getInventoryRecordForCode(code, DAY);
        const tracked = record.track !== false;
        const percent = computeInventoryPercent(record.initial, record.current);
        const fill = card.querySelector('.inline-inventory-fill');
        const bar = card.querySelector('.inline-inventory-bar');
        const chip = card.querySelector('.inventory-chip');
        if(tracked){
          if(fill) fill.style.width = `${percent}%`;
          if(bar){
            const message = record.current > 0 ? `${record.current} left` : 'No stock';
            bar.setAttribute('data-tooltip-message', message);
            bar.title = message;
            bar.style.display = '';
          }
          if(chip) chip.style.display = 'none';
        }else{
          if(fill) fill.style.width = '0%';
          if(bar){
            bar.style.display = 'none';
            bar.removeAttribute('data-tooltip-message');
            bar.title = '';
          }
          if(chip) chip.style.display = 'inline-flex';
        }
        const manual = Boolean(manualOosMap[code]);
        const isOut = Boolean(oosMap[code]);
        card.classList.toggle('is-oos', isOut);
        const titleEl = card.querySelector('strong');
        if(titleEl){
          let badge = titleEl.querySelector('.oos-tag');
          if(isOut){
            if(!badge){
              badge = document.createElement('span');
              badge.className = 'oos-tag';
              badge.textContent = 'OOS';
              titleEl.appendChild(badge);
            }
          }else if(badge){
            badge.remove();
          }
        }
        const oosBtn = card.querySelector('.oos-btn');
        if(oosBtn){
          oosBtn.textContent = manual ? 'RESTOCK' : 'OOS';
        }
      });
    }

    function showInlineInventoryTooltip(container, message){
      hideInlineInventoryTooltip();
      if(!container) return;
      const tooltip = document.createElement('div');
      tooltip.className = 'inventory-tooltip';
      tooltip.textContent = message || '';
      container.appendChild(tooltip);
      activeInventoryTooltip = tooltip;
      if(activeInventoryTooltipTimeout){
        clearTimeout(activeInventoryTooltipTimeout);
      }
      activeInventoryTooltipTimeout = setTimeout(()=>{
        hideInlineInventoryTooltip();
      }, 1600);
    }

    function hideInlineInventoryTooltip(){
      if(activeInventoryTooltip && activeInventoryTooltip.parentNode){
        activeInventoryTooltip.parentNode.removeChild(activeInventoryTooltip);
      }
      activeInventoryTooltip = null;
      if(activeInventoryTooltipTimeout){
        clearTimeout(activeInventoryTooltipTimeout);
        activeInventoryTooltipTimeout = null;
      }
    }

    /* ==========================
       Out-of-Stock tracking + Stock Log helpers (fixed)
       ========================== */
    function stockPath(code){ return `stock/${SEASON}/${DAY}/${code}`; }
    function stockPathDay(){ return `stock/${SEASON}/${DAY}`; }

    // Keep a live listener for the Stock Log so the table stays in sync.
    // We also clean it up when switching days/tabs.
    let stockListenerRef = null;

    function toggleOOS(item){
      if(!IS_POS1){
        alert('Only POS1 can update stock status.');
        return;
      }
      const code = item.code;
      const newVal = !manualOosMap[code];
      manualOosMap[code] = newVal;
      handleInventoryStateUpdate(DAY);

      const ref = db.ref(stockPath(code)).push();
      ref.set({
        status: newVal ? 'OOS' : 'RESTOCKED',
        code,
        itemName: item.name,
        ts: firebase.database.ServerValue.TIMESTAMP
      });

      updateItemCardInventoryBars();
    }

    function loadOOSMap(){
      const path = stockPathDay();
      db.ref(path).once('value',(snap)=>{
        const node = snap.val() || {};
        currentMenu().forEach(item=>{ manualOosMap[item.code] = false; });
        Object.keys(node).forEach(code=>{
          const entries = node[code] || {};
          const logs = Object.keys(entries).map(key=>entries[key]).filter(entry=>entry && entry.status);
          if(logs.length){
            logs.sort((a,b)=>(a.ts||0)-(b.ts||0));
            const last = logs[logs.length-1];
            manualOosMap[code] = !!(last && last.status === 'OOS');
          }else{
            manualOosMap[code] = false;
          }
        });
        handleInventoryStateUpdate(DAY);
      });
    }

    /* ==========================
       Stock Log view (per-day, live)
       ========================== */
    function mapCodeToName(){
      const m = {};
      currentMenu().forEach(i=>{ m[i.code] = i.name; });
      return m;
    }

    function attachStockLogListener(){
      // Detach any previous listener (e.g., when switching days)
      if(stockListenerRef){ stockListenerRef.off(); stockListenerRef = null; }

      const tbody = document.getElementById('stock-log-body');
      if(!tbody) return;

      stockListenerRef = db.ref(stockPathDay());
      stockListenerRef.on('value', (snap)=>{
        const byCode = snap.val() || {};
        const rows = [];

        Object.keys(byCode).forEach(code=>{
          const entries = byCode[code] || {};
          Object.keys(entries).forEach(key=>{
            if(key === 'inventory') return;
            const e = entries[key] || {};
            rows.push({
              code: e.code || code,
              key,
              status: e.status || '',
              ts: e.ts || 0,
              itemName: e.itemName || e.item || ''
            });
          });
        });

        // Render
        tbody.innerHTML = '';
        if(rows.length === 0){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="5" style="text-align:center;color:#666;">No stock activity yet.</td>`;
          tbody.appendChild(tr);
          return;
        }

        rows.sort((a,b)=>(b.ts||0)-(a.ts||0));
        const codeNameMap = mapCodeToName();

        rows.forEach(row=>{
          const tr = document.createElement('tr');
          const timeString = row.ts ? new Date(row.ts).toLocaleString() : '';
          tr.innerHTML = `
            <td>${timeString}</td>
            <td>${row.code}</td>
            <td>${row.itemName || codeNameMap[row.code] || ''}</td>
            <td>${row.status}</td>
            <td><button class="delete-order-button" onclick="deleteStockEvent('${row.code}','${row.key}')">&times;</button></td>
          `;
          tbody.appendChild(tr);
        });
      });
    }

    // Keep the old name for compatibility with switchTab()
    function loadStockLogFromFirebase(){
      attachStockLogListener();
    }

    function deleteStockEvent(code, key){
      if(!IS_POS1){
        alert('Only POS1 can manage the stock log.');
        return;
      }
      if(!confirm('Delete this stock entry? This may change the current OOS/RESTOCKED state if it was the latest entry.')) return;
      db.ref(`${stockPathDay()}/${code}/${key}`).remove().then(()=>{
        // No manual refresh needed; live listener will redraw.
        loadOOSMap();
      }).catch(err=>{
        console.error('Error deleting stock entry:', err);
        alert('An error occurred while deleting this entry.');
      });
    }

    function downloadStockCSV(){
      db.ref(stockPathDay()).once('value',(snap)=>{
        const byCode = snap.val() || {};
        const codeNameMap = mapCodeToName();
        const rows = [];

        Object.keys(byCode).forEach(code=>{
          const entries = byCode[code] || {};
          Object.keys(entries).forEach(key=>{
            if(key === 'inventory') return;
            const e = entries[key] || {};
            rows.push([
              new Date(e.ts||Date.now()).toLocaleString(),
              e.code || code,
              e.itemName || e.item || codeNameMap[e.code || code] || '',
              e.status || ''
            ]);
          });
        });

        rows.sort((a,b)=> new Date(b[0]) - new Date(a[0]) );

        let csv = "data:text/csv;charset=utf-8,Time,Code,Item,Status\n";
        rows.forEach(r=>{
          csv += r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',') + "\n";
        });

        const link = document.createElement('a');
        link.setAttribute('href', encodeURI(csv));
        link.setAttribute('download', `stock_log_${SEASON}_${DAY}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    }

    function clearAllStockLog(){
      if(!IS_POS1){
        alert('Only POS1 can manage the stock log.');
        return;
      }
      if(!confirm('Clear the entire stock log for this day? This cannot be undone.')) return;
      db.ref(stockPathDay()).once('value').then(snap=>{
        const node = snap.val() || {};
        const updates = {};
        Object.keys(node).forEach(code=>{
          const entries = node[code] || {};
          Object.keys(entries).forEach(key=>{
            if(key === 'inventory') return;
            updates[`${code}/${key}`] = null;
          });
        });
        if(Object.keys(updates).length===0){
          return;
        }
        return db.ref(stockPathDay()).update(updates);
      }).then(()=>{
        alert('Stock log cleared for ' + DAY + '.');
        loadOOSMap();
      }).catch(err=>{
        console.error('Error clearing stock log:', err);
        alert('An error occurred while clearing the stock log.');
      });
    }

    /* ==========================
       POS UI helpers
       ========================== */
    function applyPosModeUI(){
      if(document && document.body){
        document.body.setAttribute('data-pos-id', POS_ID);
      }
      const indicator = document.getElementById('pos-indicator');
      if(indicator){
        indicator.textContent = POS_ID;
      }
      const posChip = document.getElementById('current-pos-chip');
      if(posChip){
        posChip.textContent = POS_ID;
      }
      const posSwitcher = document.getElementById('pos-switcher-select');
      if(posSwitcher){
        posSwitcher.value = POS_ID;
      }

      const paymentButtons = document.getElementById('payment-buttons');
      const zelleButton = document.getElementById('zelle-payment-button');
      const modeRow = document.getElementById('mode-switch-row');
      if(IS_POS1){
        if(zelleButton) zelleButton.style.display='inline-block';
        if(paymentButtons) paymentButtons.classList.remove('cash-only');
        if(modeRow) modeRow.style.display='flex';
      }else{
        if(zelleButton) zelleButton.style.display='none';
        if(paymentButtons) paymentButtons.classList.add('cash-only');
        if(modeRow) modeRow.style.display='none';
      }
      updateCurrentOrderHeading();
    }

    function handlePosSwitchChange(event){
      const nextValue = (event && event.target) ? event.target.value : null;
      if(!nextValue || !POS_IDS.includes(nextValue)){
        if(event && event.target){ event.target.value = POS_ID; }
        return;
      }
      if(nextValue === POS_ID){
        return;
      }
      const params = new URLSearchParams(window.location.search);
      const mapped = POS_QUERY_VALUE[nextValue] || '1';
      params.set('pos', mapped);
      const newQuery = params.toString();
      const suffix = newQuery ? `?${newQuery}` : '';
      const newUrl = `${window.location.pathname}${suffix}${window.location.hash}`;
      window.location.href = newUrl;
    }


    function searchItems(){
      const q = (document.getElementById('search-input').value||'').toLowerCase();
      document.querySelectorAll('.item-box').forEach(box=>{
        const name = (box.getAttribute('data-name')||'').toLowerCase();
        const code = (box.getAttribute('data-code')||'').toLowerCase();
        const matches = !q || name.includes(q) || code.includes(q);
        box.style.display = matches ? 'flex' : 'none';
      });
    }

    function initializeMenuItems(){
      rebuildItemCodeMap();
      const grid = document.getElementById('item-grid');
      if(!grid) return;
      grid.innerHTML = '';
      const state = menuState[DAY];
      if(!state || !state.loaded){
        const loading = document.createElement('div');
        loading.className = 'menu-empty';
        loading.textContent = 'Loading menu…';
        grid.appendChild(loading);
        return;
      }
      const menu = currentMenu();
      if(menu.length === 0){
        const empty = document.createElement('div');
        empty.className = 'menu-empty';
        const message = document.createElement('div');
        message.textContent = 'No active items configured for this day.';
        const button = document.createElement('button');
        button.type = 'button';
        button.textContent = 'Open Items (Admin)';
        button.onclick = ()=>{ setItemsAdminDay(DAY); switchTab('Items Admin'); };
        empty.appendChild(message);
        empty.appendChild(button);
        grid.appendChild(empty);
        return;
      }
      menu.forEach(item=>{
        const effectivePrice = getEffectivePriceFor(item);
        const ticketColorLabel = getEffectiveTicketColorLabel(item);
        const record = getInventoryRecordForCode(item.code, DAY);
        const tracked = record.track !== false;
        const card = document.createElement('div');
        card.className='item-box';
        card.setAttribute('data-code', item.code);
        card.setAttribute('data-name', item.name);
        if(oosMap[item.code]) card.classList.add('is-oos');
        card.onclick = ()=>{
          if(!oosMap[item.code]){
            addItem({
              code: item.code,
              name: item.name,
              price: effectivePrice,
              ticketColor: ticketColorLabel,
              image: item.image
            });
          }
        };

        const title = document.createElement('strong');
        title.textContent = item.name;
        if(oosMap[item.code]){
          const badge = document.createElement('span');
          badge.className = 'oos-tag';
          badge.textContent = 'OOS';
          title.appendChild(badge);
        }
        card.appendChild(title);

        const priceEl = document.createElement('span');
        priceEl.className = 'price';
        priceEl.textContent = `$${effectivePrice.toFixed(2)}`;
        card.appendChild(priceEl);

        const barWrapper = document.createElement('div');
        barWrapper.className = 'inline-inventory-bar';
        const track = document.createElement('div');
        track.className = 'inline-inventory-track';
        const fill = document.createElement('div');
        fill.className = 'inline-inventory-fill';
        const percent = tracked ? computeInventoryPercent(record.initial, record.current) : 0;
        fill.style.width = `${percent}%`;
        track.appendChild(fill);
        barWrapper.appendChild(track);
        if(tracked){
          const message = record.current > 0 ? `${record.current} left` : 'No stock';
          barWrapper.setAttribute('data-tooltip-message', message);
          barWrapper.title = message;
        }else{
          barWrapper.style.display = 'none';
        }
        barWrapper.addEventListener('click', event=>{
          event.stopPropagation();
          const message = barWrapper.getAttribute('data-tooltip-message') || '';
          if(message) showInlineInventoryTooltip(card, message);
        });
        barWrapper.addEventListener('pointerdown', event=>{
          if(event.pointerType === 'touch' || event.pointerType === 'pen'){
            event.stopPropagation();
            const message = barWrapper.getAttribute('data-tooltip-message') || '';
            if(message) showInlineInventoryTooltip(card, message);
          }
        });
        card.appendChild(barWrapper);

        const untrackedChip = document.createElement('span');
        untrackedChip.className = 'inventory-chip';
        untrackedChip.textContent = 'Untracked';
        untrackedChip.style.display = tracked ? 'none' : 'inline-flex';
        card.appendChild(untrackedChip);

        const img = document.createElement('img');
        img.src = item.image || 'https://via.placeholder.com/150?text=Menu';
        img.alt = item.name;
        card.appendChild(img);

        if(IS_POS1){
          const actions = document.createElement('div');
          actions.className='item-actions';
          const editBtn = document.createElement('button');
          editBtn.type='button';
          editBtn.className='edit-price-btn';
          editBtn.innerHTML='✏️ Edit';
          editBtn.setAttribute('aria-label', `Edit item ${item.name}`);
          editBtn.onclick = (e)=>{ e.stopPropagation(); openEditPriceModal(item); };
          actions.appendChild(editBtn);
          const oosBtn = document.createElement('button');
          oosBtn.className='oos-btn';
          oosBtn.textContent = manualOosMap[item.code] ? 'RESTOCK' : 'OOS';
          oosBtn.onclick = (e)=>{ e.stopPropagation(); toggleOOS(item); };
          actions.appendChild(oosBtn);
          card.appendChild(actions);
        }
        grid.appendChild(card);
      });
    }

    /* ==========================
       Items Admin Helpers
       ========================== */
    function setItemsAdminDay(day){
      if(!MENU_DAYS.includes(day)) return;
      itemsAdminDay = day;
      const satBtn = document.getElementById('items-admin-sat');
      if(satBtn) satBtn.classList.toggle('active', day === 'SAT');
      const sunBtn = document.getElementById('items-admin-sun');
      if(sunBtn) sunBtn.classList.toggle('active', day === 'SUN');
      renderItemsAdminTable();
    }

    function renderItemsAdminTable(){
      const tbody = document.getElementById('items-admin-table-body');
      if(!tbody) return;
      const state = menuState[itemsAdminDay];
      if(!state || !state.loaded){
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Loading items…</td></tr>';
        return;
      }
      const searchBox = document.getElementById('items-admin-search');
      const query = (searchBox && searchBox.value ? searchBox.value : '').toLowerCase();
      const ordered = getOrderedMenu(itemsAdminDay);
      const items = ordered.filter(item=>{
        if(!query) return true;
        const name = (item.name || '').toLowerCase();
        const code = (item.code || '').toLowerCase();
        return name.includes(query) || code.includes(query);
      });
      if(items.length === 0){
        const message = ordered.length === 0 ? 'No items configured yet.' : 'No items match the search.';
        tbody.innerHTML = `<tr><td colspan="8" class="empty-state">${message}</td></tr>`;
        return;
      }
      tbody.innerHTML = '';
      items.forEach(item=>{
        const tr = document.createElement('tr');
        const effectivePrice = getEffectivePriceFor(item);

        const codeTd = document.createElement('td');
        codeTd.textContent = item.code || '';
        tr.appendChild(codeTd);

        const nameTd = document.createElement('td');
        nameTd.textContent = item.name || '';
        tr.appendChild(nameTd);

        const priceTd = document.createElement('td');
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.step = '0.01';
        priceInput.min = '0';
        priceInput.className = 'inline-number';
        priceInput.value = effectivePrice.toFixed(2);
        priceInput.addEventListener('change', ()=>handleInlinePriceChange(itemsAdminDay, item.code, priceInput.value));
        priceTd.appendChild(priceInput);
        tr.appendChild(priceTd);

        const ticketTd = document.createElement('td');
        const ticketSelect = document.createElement('select');
        ticketSelect.className = 'inline-select';
        ticketSelect.setAttribute('data-selected', item.ticketColor || '');
        populateTicketColorSelect(ticketSelect, item.ticketColor || '');
        ticketSelect.addEventListener('change', ()=>handleInlineTicketChange(itemsAdminDay, item.code, ticketSelect.value));
        ticketTd.appendChild(ticketSelect);
        tr.appendChild(ticketTd);

        const imageTd = document.createElement('td');
        const img = document.createElement('img');
        img.className = 'thumbnail';
        img.src = item.image || 'https://via.placeholder.com/64?text=No';
        img.alt = item.name || item.code;
        imageTd.appendChild(img);
        tr.appendChild(imageTd);

        const activeTd = document.createElement('td');
        const activeInput = document.createElement('input');
        activeInput.type = 'checkbox';
        activeInput.className = 'inline-checkbox';
        activeInput.checked = item.active !== false;
        activeInput.addEventListener('change', ()=>handleInlineActiveToggle(itemsAdminDay, item.code, activeInput.checked));
        activeTd.appendChild(activeInput);
        tr.appendChild(activeTd);

        const sortTd = document.createElement('td');
        sortTd.textContent = item.sort !== undefined ? item.sort : '';
        const sortButtons = document.createElement('div');
        sortButtons.className = 'sort-buttons';
        const position = ordered.findIndex(entry=>entry.code === item.code);
        const upBtn = document.createElement('button');
        upBtn.type = 'button';
        upBtn.innerHTML = '▲';
        upBtn.disabled = position <= 0;
        upBtn.addEventListener('click', ()=>moveItem(itemsAdminDay, item.code, -1));
        sortButtons.appendChild(upBtn);
        const downBtn = document.createElement('button');
        downBtn.type = 'button';
        downBtn.innerHTML = '▼';
        downBtn.disabled = position === ordered.length - 1;
        downBtn.addEventListener('click', ()=>moveItem(itemsAdminDay, item.code, 1));
        sortButtons.appendChild(downBtn);
        sortTd.appendChild(sortButtons);
        tr.appendChild(sortTd);

        const actionsTd = document.createElement('td');
        actionsTd.className = 'actions';
        const editButton = document.createElement('button');
        editButton.type = 'button';
        editButton.className = 'table-button';
        editButton.textContent = 'Edit';
        editButton.addEventListener('click', ()=>openItemModal('edit', item.code));
        actionsTd.appendChild(editButton);
        const softDeleteButton = document.createElement('button');
        softDeleteButton.type = 'button';
        softDeleteButton.className = item.active === false ? 'table-button primary' : 'table-button danger';
        softDeleteButton.textContent = item.active === false ? 'Restore' : 'Soft Delete';
        softDeleteButton.addEventListener('click', ()=>{
          handleInlineActiveToggle(itemsAdminDay, item.code, item.active === false);
        });
        actionsTd.appendChild(softDeleteButton);
        tr.appendChild(actionsTd);

        tbody.appendChild(tr);
      });
    }

    function handleInlinePriceChange(day, code, value){
      const price = parseFloat(value);
      if(isNaN(price) || price < 0){
        alert('Enter a valid price.');
        renderItemsAdminTable();
        return;
      }
      updateMenuItem(day, code, { price: round2(price) }, 'Price updated.').catch(()=>{
        renderItemsAdminTable();
      });
    }

    function handleInlineTicketChange(day, code, value){
      const normalized = normalizeTicketColorValue(value);
      updateMenuItem(day, code, { ticketColor: normalized }, 'Ticket color updated.').catch(()=>{
        renderItemsAdminTable();
      });
    }

    function handleInlineActiveToggle(day, code, isActive){
      updateMenuItem(day, code, { active: !!isActive }, isActive ? 'Item restored.' : 'Item hidden.').catch(()=>{
        renderItemsAdminTable();
      });
    }

    function moveItem(day, code, delta){
      const ordered = getOrderedMenu(day).slice();
      const index = ordered.findIndex(item=>item.code === code);
      if(index < 0) return;
      const nextIndex = index + delta;
      if(nextIndex < 0 || nextIndex >= ordered.length) return;
      const [entry] = ordered.splice(index,1);
      ordered.splice(nextIndex, 0, entry);
      const updates = {};
      ordered.forEach((item, idx)=>{
        updates[`${item.code}/sort`] = (idx + 1) * 10;
      });
      db.ref(menuPathForDay(day)).update(updates)
        .then(()=>{ showPriceToast('Sort order updated.'); })
        .catch(err=>{
          console.error('Unable to update sort order', err);
          alert('Unable to update sort order. Please try again.');
          renderItemsAdminTable();
        });
    }

    function updateMenuItem(day, code, updates, message){
      if(!code) return Promise.resolve();
      const payload = Object.assign({}, updates);
      if(payload.day === undefined) payload.day = day;
      return db.ref(`${menuPathForDay(day)}/${code}`).update(payload).then(()=>{
        if(message) showPriceToast(message);
      }).catch(err=>{
        console.error('Unable to update item', err);
        alert('Unable to update item: ' + (err && err.message ? err.message : 'Please try again.'));
        throw err;
      });
    }

    function openItemModal(mode, code){
      const modal = document.getElementById('item-editor-modal');
      if(!modal) return;
      const title = document.getElementById('item-editor-title');
      const nameInput = document.getElementById('item-name-input');
      const codeInput = document.getElementById('item-code-input');
      const priceInput = document.getElementById('item-price-input');
      const ticketSelect = document.getElementById('item-ticket-select');
      const imageInput = document.getElementById('item-image-input');
      const activeInput = document.getElementById('item-active-input');
      const sortInput = document.getElementById('item-sort-input');
      const day = itemsAdminDay;
      let item = null;
      if(mode === 'edit' && code){
        item = getMenuItemByCode(day, code);
        if(!item){
          alert('Item not found.');
          return;
        }
      }
      currentItemModal = { mode, day, code: item ? item.code : null };
      if(title) title.textContent = mode === 'edit' && item ? `Edit Item — ${item.name}` : 'Add Item';
      if(nameInput) nameInput.value = item ? item.name || '' : '';
      if(codeInput){
        codeInput.value = item ? item.code || '' : '';
        codeInput.disabled = mode === 'edit';
      }
      if(priceInput) priceInput.value = item ? getEffectivePriceFor(item).toFixed(2) : '';
      if(ticketSelect){
        ticketSelect.setAttribute('data-selected', item ? item.ticketColor || '' : '');
        populateTicketColorSelect(ticketSelect, item ? item.ticketColor || '' : '');
      }
      if(imageInput) imageInput.value = item ? item.image || '' : '';
      if(activeInput) activeInput.checked = !item || item.active !== false;
      if(sortInput){
        const defaultSort = (getOrderedMenu(day).length + 1) * 10;
        sortInput.value = item && item.sort !== undefined ? item.sort : defaultSort;
      }
      modal.style.display = 'block';
      setTimeout(()=>{
        if(nameInput) nameInput.focus();
      }, 0);
    }

    function closeItemModal(){
      const modal = document.getElementById('item-editor-modal');
      if(modal) modal.style.display = 'none';
      currentItemModal = null;
      const fields = ['item-name-input','item-code-input','item-price-input','item-image-input','item-sort-input'];
      fields.forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.value = '';
      });
      const activeInput = document.getElementById('item-active-input');
      if(activeInput) activeInput.checked = true;
    }

    function saveItemFromModal(){
      if(!currentItemModal) return;
      const mode = currentItemModal.mode;
      const day = currentItemModal.day || itemsAdminDay;
      const nameInput = document.getElementById('item-name-input');
      const codeInput = document.getElementById('item-code-input');
      const priceInput = document.getElementById('item-price-input');
      const ticketSelect = document.getElementById('item-ticket-select');
      const imageInput = document.getElementById('item-image-input');
      const activeInput = document.getElementById('item-active-input');
      const sortInput = document.getElementById('item-sort-input');
      const name = nameInput ? nameInput.value.trim() : '';
      if(!name){
        alert('Name is required.');
        if(nameInput) nameInput.focus();
        return;
      }
      let code = codeInput ? codeInput.value.trim().toUpperCase() : '';
      if(mode === 'edit'){ code = currentItemModal.code; }
      if(!code){
        alert('Code is required.');
        if(codeInput) codeInput.focus();
        return;
      }
      if(mode === 'create' && menuState[day] && menuState[day].map && menuState[day].map[code]){
        alert('An item with that code already exists.');
        if(codeInput) codeInput.focus();
        return;
      }
      const price = parseFloat(priceInput ? priceInput.value : '');
      if(isNaN(price) || price < 0){
        alert('Enter a valid price.');
        if(priceInput) priceInput.focus();
        return;
      }
      const ticketColor = ticketSelect ? normalizeTicketColorValue(ticketSelect.value) : '';
      const image = imageInput ? imageInput.value.trim() : '';
      const active = activeInput ? activeInput.checked : true;
      let sort = parseInt(sortInput ? sortInput.value : '', 10);
      if(!Number.isFinite(sort)){
        const base = getOrderedMenu(day).length + (mode === 'create' ? 1 : 0);
        sort = base * 10;
      }
      const payload = {
        name,
        price: round2(price),
        ticketColor,
        image,
        active,
        sort,
        day
      };
      const ref = db.ref(`${menuPathForDay(day)}/${code}`);
      const promise = mode === 'edit' ? ref.update(payload) : ref.set(payload);
      promise.then(()=>{
        showPriceToast('Item saved.');
        closeItemModal();
      }).catch(err=>{
        console.error('Unable to save item', err);
        alert('Unable to save item: ' + (err && err.message ? err.message : 'Please try again.'));
      });
    }

    function renderTicketColorManager(){
      const list = document.getElementById('ticket-color-list');
      if(!list) return;
      list.innerHTML = '';
      if(ticketColors.length === 0){
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.textContent = 'No ticket colors yet.';
        list.appendChild(empty);
        return;
      }
      ticketColors.forEach((color, index)=>{
        const row = document.createElement('div');
        row.className = 'ticket-color-row';
        const input = document.createElement('input');
        input.value = color;
        input.addEventListener('keydown', event=>{
          if(event.key === 'Enter'){
            event.preventDefault();
            handleRenameTicketColor(index, input.value);
          }
        });
        input.addEventListener('blur', ()=>handleRenameTicketColor(index, input.value, { silent:true }));
        const renameBtn = document.createElement('button');
        renameBtn.className = 'secondary';
        renameBtn.textContent = 'Rename';
        renameBtn.addEventListener('click', ()=>handleRenameTicketColor(index, input.value));
        const removeBtn = document.createElement('button');
        removeBtn.className = 'danger';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', ()=>handleRemoveTicketColor(index));
        row.appendChild(input);
        row.appendChild(renameBtn);
        row.appendChild(removeBtn);
        list.appendChild(row);
      });
    }

    function handleAddTicketColor(){
      const input = document.getElementById('ticket-color-new');
      if(!input) return;
      const value = normalizeTicketColorValue(input.value);
      if(!value){
        alert('Enter a color name.');
        return;
      }
      if(ticketColors.some(color=>color.toLowerCase() === value.toLowerCase())){
        alert('That color already exists.');
        return;
      }
      db.ref(`tickets/${SEASON}/colors`).set(ticketColors.concat([value]))
        .then(()=>{
          showPriceToast('Color added.');
          input.value = '';
        })
        .catch(err=>{
          console.error('Unable to add color', err);
          alert('Unable to add color: ' + (err && err.message ? err.message : 'Please try again.'));
        });
    }

    function handleRenameTicketColor(index, rawValue, options={}){
      const current = ticketColors[index];
      if(current === undefined) return;
      const nextValue = normalizeTicketColorValue(rawValue);
      if(nextValue === ''){
        if(!options.silent) alert('Color name cannot be empty.');
        renderTicketColorManager();
        return;
      }
      if(nextValue.toLowerCase() === current.toLowerCase()){
        if(current !== nextValue){
          // Case change only
        }else{
          return;
        }
      }
      if(ticketColors.some((color, idx)=>idx!==index && color.toLowerCase() === nextValue.toLowerCase())){
        if(!options.silent) alert('That color already exists.');
        renderTicketColorManager();
        return;
      }
      const nextColors = ticketColors.slice();
      nextColors[index] = nextValue;
      const updates = {};
      MENU_DAYS.forEach(day=>{
        const state = menuState[day];
        if(!state || !state.map) return;
        Object.values(state.map).forEach(item=>{
          const value = normalizeTicketColorValue(item.ticketColor);
          if(value && value.toLowerCase() === current.toLowerCase()){
            updates[`menu/${SEASON}/${day}/${item.code}/ticketColor`] = nextValue;
          }
        });
      });
      updates[`tickets/${SEASON}/colors`] = nextColors;
      db.ref().update(updates)
        .then(()=>{ if(!options.silent) showPriceToast('Color renamed.'); })
        .catch(err=>{
          console.error('Unable to rename color', err);
          alert('Unable to rename color: ' + (err && err.message ? err.message : 'Please try again.'));
          renderTicketColorManager();
        });
    }

    function handleRemoveTicketColor(index){
      const color = ticketColors[index];
      if(color === undefined) return;
      if(ticketColors.length <= 1){
        alert('Keep at least one ticket color before removing this one.');
        return;
      }
      const available = ticketColors.filter((_, idx)=>idx!==index);
      const affected = [];
      MENU_DAYS.forEach(day=>{
        const state = menuState[day];
        if(!state || !state.map) return;
        Object.values(state.map).forEach(item=>{
          const value = normalizeTicketColorValue(item.ticketColor);
          if(value && value.toLowerCase() === color.toLowerCase()){
            affected.push({ day, code:item.code });
          }
        });
      });
      let replacement = '';
      if(affected.length){
        const options = available.join(', ');
        const promptValue = window.prompt(`"${color}" is used by ${affected.length} item(s). Choose a replacement color (${options}):`, available[0] || '');
        if(!promptValue){
          renderTicketColorManager();
          return;
        }
        const normalized = normalizeTicketColorValue(promptValue);
        const match = available.find(opt=>opt.toLowerCase() === normalized.toLowerCase());
        if(!match){
          alert('Please type one of the listed colors exactly.');
          renderTicketColorManager();
          return;
        }
        replacement = match;
      }
      const updates = {};
      updates[`tickets/${SEASON}/colors`] = available;
      if(affected.length){
        affected.forEach(entry=>{
          updates[`menu/${SEASON}/${entry.day}/${entry.code}/ticketColor`] = replacement;
        });
      }
      db.ref().update(updates)
        .then(()=>{ showPriceToast('Color removed.'); })
        .catch(err=>{
          console.error('Unable to remove color', err);
          alert('Unable to remove color: ' + (err && err.message ? err.message : 'Please try again.'));
          renderTicketColorManager();
        });
    }

    function getPriceModalFocusableElements(){
      const modal = document.getElementById('edit-price-modal');
      if(!modal) return [];
      return Array.from(modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))
        .filter(el=>!el.hasAttribute('disabled') && el.offsetParent !== null);
    }

    function handleEditPriceModalKeydown(event){
      if(event.key === 'Escape'){
        event.preventDefault();
        closeEditPriceModal();
        return;
      }
      if(event.key === 'Tab'){
        const focusable = getPriceModalFocusableElements();
        if(focusable.length===0) return;
        const first = focusable[0];
        const last = focusable[focusable.length-1];
        if(event.shiftKey){
          if(document.activeElement === first){
            event.preventDefault();
            last.focus();
          }
        }else if(document.activeElement === last){
          event.preventDefault();
          first.focus();
        }
      }
    }

    function openEditPriceModal(item){
      if(!item) return;
      if(!IS_POS1){
        alert('Only POS1 can edit items.');
        return;
      }
      currentPriceEdit = { code:item.code, day:item.day || DAY };
      const modal = document.getElementById('edit-price-modal');
      const title = document.getElementById('edit-price-title');
      const input = document.getElementById('edit-price-input');
      const ticketSelect = document.getElementById('edit-ticket-color-select');
      if(title) title.innerText = `Edit Item — ${item.name}`;
      if(input){
        const price = getEffectivePriceFor(item);
        input.value = price.toFixed(2);
      }
      if(ticketSelect){
        ticketSelect.setAttribute('data-selected', item.ticketColor || '');
        populateTicketColorSelect(ticketSelect, item.ticketColor || '');
      }
      lastFocusBeforePriceModal = document.activeElement;
      if(modal){
        modal.style.display='block';
        modal.removeEventListener('keydown', handleEditPriceModalKeydown);
        modal.addEventListener('keydown', handleEditPriceModalKeydown);
      }
      setTimeout(()=>{
        if(input) input.focus();
      }, 0);
    }

    function closeEditPriceModal(){
      const modal = document.getElementById('edit-price-modal');
      if(modal){
        modal.style.display='none';
        modal.removeEventListener('keydown', handleEditPriceModalKeydown);
      }
      currentPriceEdit = null;
      const input = document.getElementById('edit-price-input');
      if(input) input.value = '';
      const ticketSelect = document.getElementById('edit-ticket-color-select');
      if(ticketSelect){
        ticketSelect.setAttribute('data-selected', '');
        populateTicketColorSelect(ticketSelect, '');
      }
      if(lastFocusBeforePriceModal && typeof lastFocusBeforePriceModal.focus === 'function'){
        lastFocusBeforePriceModal.focus();
      }
      lastFocusBeforePriceModal = null;
    }

    function savePriceOverride(){
      if(!currentPriceEdit) return;
      if(!IS_POS1){
        alert('Only POS1 can edit items.');
        return;
      }
      const input = document.getElementById('edit-price-input');
      if(!input) return;
      const value = parseFloat(input.value);
      if(isNaN(value) || value < 0){
        alert('Please enter a valid price.');
        return;
      }
      const code = currentPriceEdit.code;
      const day = currentPriceEdit.day || DAY;
      const ticketSelect = document.getElementById('edit-ticket-color-select');
      const ticketColorValue = ticketSelect ? normalizeTicketColorValue(ticketSelect.value) : '';
      const payload = {
        price: round2(value),
        ticketColor: ticketColorValue,
        day
      };
      db.ref(`${menuPathForDay(day)}/${code}`).update(payload)
        .then(()=>{
          showPriceToast('Item updated.');
          closeEditPriceModal();
          updateOrderSummary();
          syncTicketCounters();
        })
        .catch(err=>{
          console.error('Unable to update item', err);
          const message = err && err.message ? err.message : 'Please try again.';
          alert('Unable to Update Item: ' + message);
        });
    }

    function showPriceToast(message){
      const toast = document.getElementById('price-toast');
      if(!toast) return;
      toast.textContent = message;
      toast.classList.add('show');
      if(priceToastTimeout) clearTimeout(priceToastTimeout);
      priceToastTimeout = setTimeout(()=>{
        toast.classList.remove('show');
      }, 2400);
    }

    function clearOrder(){
      total=0;
      orderList=[]; updateOrderSummary();
      syncTicketCounters();
      isTotalOverwritten=false;
      resetPaymentState();
      applyCustomerName('', { skipBroadcast:true });
      if(IS_POS1){
        db.ref('currentOrder').remove();
      }
    }

    /* ==========================
       Tabs + Day Subtabs
       ========================== */
      function switchTab(tab){
        const posView = document.querySelector('.container');
        const orderTrackingView = document.getElementById('order-tracking');
      const zelleView = document.getElementById('zelle-confirmations');
      const stockLogView = document.getElementById('stock-log');
      const inventoryView = document.getElementById('inventory-view');
      const analyticsView = document.getElementById('analytics');
      const itemsAdminView = document.getElementById('items-admin-view');

      // reset all
      posView.style.display='none';
      orderTrackingView.style.display='none';
      if(zelleView) zelleView.style.display='none';
        analyticsView.style.display='none';
        if(inventoryView) inventoryView.style.display='none';
      if(stockLogView) stockLogView.style.display='none';
      if(itemsAdminView) itemsAdminView.style.display='none';

      document.getElementById('pos-tab-button').classList.remove('active');
      document.getElementById('order-tracking-tab-button').classList.remove('active');
      document.getElementById('zelle-tab-button').classList.remove('active');
      if(document.getElementById('stock-tab-button')) document.getElementById('stock-tab-button').classList.remove('active');
        document.getElementById('analytics-tab-button').classList.remove('active');
        const inventoryTabButton = document.getElementById('inventory-tab-button');
        if(inventoryTabButton) inventoryTabButton.classList.remove('active');
      const itemsAdminTabButton = document.getElementById('items-admin-tab-button');
      if(itemsAdminTabButton) itemsAdminTabButton.classList.remove('active');

      if(tab==='POS'){
        posView.style.display='flex';
        document.getElementById('pos-tab-button').classList.add('active');
      }else if(tab==='Order Tracking'){
        orderTrackingView.style.display='block';
        document.getElementById('order-tracking-tab-button').classList.add('active');
        loadOrdersFromFirebase();
      }else if(tab==='Zelle'){
        if(zelleView){
          zelleView.style.display='block';
          document.getElementById('zelle-tab-button').classList.add('active');
          updateZelleAccountDisplay();
          attachZelleListener();
          attachZelleSwitchLogListener();
        }
        }else if(tab==='Stock Log'){
          if(stockLogView){
            stockLogView.style.display='block';
            document.getElementById('stock-tab-button').classList.add('active');
            loadStockLogFromFirebase();
          }
        }else if(tab==='Inventory'){
          if(inventoryView){
            inventoryView.style.display='block';
            if(inventoryTabButton) inventoryTabButton.classList.add('active');
            renderInventoryView();
          }
        }else if(tab==='Analytics'){
          analyticsView.style.display='block';
          document.getElementById('analytics-tab-button').classList.add('active');
          generateAnalytics();
        }else if(tab==='Items Admin'){
          if(itemsAdminView){
            itemsAdminView.style.display='block';
            if(itemsAdminTabButton) itemsAdminTabButton.classList.add('active');
            setItemsAdminDay(itemsAdminDay);
          }
        }
      }

    function setDay(next){
      if(DAY===next) return;
      DAY = next;

      // Toggle active states in top bar
      document.getElementById('btn-day-sat').classList.toggle('active', DAY==='SAT');
      document.getElementById('btn-day-sun').classList.toggle('active', DAY==='SUN');
      syncInventoryDayButtons();

      // Toggle active states in subtabs, if present
      const otSat = document.getElementById('ot-sat'); if(otSat) otSat.classList.toggle('active', DAY==='SAT');
      const otSun = document.getElementById('ot-sun'); if(otSun) otSun.classList.toggle('active', DAY==='SUN');
      const anSat = document.getElementById('an-sat'); if(anSat) anSat.classList.toggle('active', DAY==='SAT');
      const anSun = document.getElementById('an-sun'); if(anSun) anSun.classList.toggle('active', DAY==='SUN');
      const slSat = document.getElementById('sl-sat'); if(slSat) slSat.classList.toggle('active', DAY==='SAT');
      const slSun = document.getElementById('sl-sun'); if(slSun) slSun.classList.toggle('active', DAY==='SUN');
      const zeSat = document.getElementById('ze-sat'); if(zeSat) zeSat.classList.toggle('active', DAY==='SAT');
      const zeSun = document.getElementById('ze-sun'); if(zeSun) zeSun.classList.toggle('active', DAY==='SUN');

      const itemsAdminView = document.getElementById('items-admin-view');
      if(itemsAdminView && itemsAdminView.style.display === 'block'){
        setItemsAdminDay(DAY);
      }

      refreshDisplayNameListener();
      orderNumber = 0;
      resetPaymentState();
      applyCustomerName('', { skipBroadcast:true });
      refreshOrderMetaUI();

      latestZelleAccountTotals = {};
      updateZelleAccountTotalsDisplay({});
      refreshZelleCurrentAccountListener();
      refreshZelleFeeListener();

      // Immediately rebuild the item grid for the new day
      initializeMenuItems();

      // Then load OOS map to update badges/buttons from Firebase
      loadOOSMap();
      refreshInventoryListener();
      renderInventoryView();

      // Refresh other views if currently visible
      if(document.getElementById('order-tracking').style.display==='block'){
        buildDynamicHeader();
        loadOrdersFromFirebase();
      }
      if(document.getElementById('zelle-confirmations') && document.getElementById('zelle-confirmations').style.display==='block'){
        attachZelleListener();
        attachZelleSwitchLogListener();
      }
      if(document.getElementById('analytics').style.display==='block'){ generateAnalytics(); }
      if(document.getElementById('stock-log') && document.getElementById('stock-log').style.display==='block'){ loadStockLogFromFirebase(); }
    }

    function switchDaySubtab(next, where){
      if(DAY===next) return;
      DAY = next;

      refreshDisplayNameListener();
      orderNumber = 0;
      applyCustomerName('', { skipBroadcast:true });
      refreshOrderMetaUI();
      refreshZelleCurrentAccountListener();
      refreshZelleFeeListener();

      // Mark the active subtab
      if(where==='ot'){
        document.getElementById('ot-sat').classList.toggle('active', DAY==='SAT');
        document.getElementById('ot-sun').classList.toggle('active', DAY==='SUN');
        buildDynamicHeader();
        loadOrdersFromFirebase();
      }else if(where==='an'){
        document.getElementById('an-sat').classList.toggle('active', DAY==='SAT');
        document.getElementById('an-sun').classList.toggle('active', DAY==='SUN'); generateAnalytics();
      }else if(where==='sl'){
        document.getElementById('sl-sat').classList.toggle('active', DAY==='SAT');
        document.getElementById('sl-sun').classList.toggle('active', DAY==='SUN');
        loadStockLogFromFirebase();
      }else if(where==='ze'){
        document.getElementById('ze-sat').classList.toggle('active', DAY==='SAT');
        document.getElementById('ze-sun').classList.toggle('active', DAY==='SUN');
        latestZelleAccountTotals = {};
        updateZelleAccountTotalsDisplay({});
        refreshZelleCurrentAccountListener();
        attachZelleListener();
        attachZelleSwitchLogListener();
      }

      // Sync top bar buttons
      document.getElementById('btn-day-sat').classList.toggle('active', DAY==='SAT');
      document.getElementById('btn-day-sun').classList.toggle('active', DAY==='SUN');
      syncInventoryDayButtons();

      const itemsAdminView = document.getElementById('items-admin-view');
      if(itemsAdminView && itemsAdminView.style.display === 'block'){
        setItemsAdminDay(DAY);
      }

      // Rebuild POS grid and refresh OOS state
      initializeMenuItems();
      loadOOSMap();
    }

    /* ==========================
       Analytics (per-day)
       ========================== */
    function generateAnalytics(){
      db.ref(ordersPath()).once('value',(snapshot)=>{
        const orders = snapshot.val() || {};
        const list = Object.values(orders);
        renderAnalyticsItemsTable(list);
        renderAnalyticsPaymentSplit(list);
        renderAnalyticsExpectedPanel(list);
        renderAnalyticsHourlyChart(list);
      });
    }

    // Reusable chart killer (avoid stacking multiple instances)
    const chartStore = {};
    function killChart(id){ if(chartStore[id]){ chartStore[id].destroy(); chartStore[id]=null; } }

    function renderAnalyticsItemsTable(orderList){
      const tbody = document.getElementById('analytics-items-body');
      if(!tbody) return;
      const summary = new Map();
      currentMenu().forEach(item=>{
        const key = item.code || item.name;
        if(key) summary.set(key, { name:item.name, units:0, grossCents:0 });
      });
      orderList.forEach(order=>{
        (order.items || []).forEach(it=>{
          const quantity = Number(it.quantity) || 0;
          if(quantity<=0) return;
          const code = it.code || itemCodeMap[it.name];
          const entryKey = code || it.name || `unknown-${summary.size}`;
          const entryName = it.name || code || 'Item';
          if(!summary.has(entryKey)){
            summary.set(entryKey, { name: entryName, units:0, grossCents:0 });
          }
          const entry = summary.get(entryKey);
          entry.units += quantity;
          const priceCents = Math.round((Number(it.price) || 0) * 100);
          entry.grossCents += priceCents * quantity;
        });
      });
      const rows = Array.from(summary.values());
      rows.sort((a,b)=>{
        if(b.units !== a.units) return b.units - a.units;
        return a.name.localeCompare(b.name);
      });
      tbody.innerHTML='';
      if(rows.length===0){
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="3" style="text-align:center;color:#666;padding:18px;">No items to display.</td>';
        tbody.appendChild(tr);
        return;
      }
      rows.forEach(row=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHTML(row.name)}</td>
          <td>${row.units}</td>
          <td>$${(row.grossCents/100).toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderAnalyticsPaymentSplit(orderList){
      const methodLabels = ['Cash','Zelle'];
      const totals = { Cash:{ count:0, revenue:0 }, Zelle:{ count:0, revenue:0 } };
      orderList.forEach(order=>{
        const method = order.method === 'Zelle' ? 'Zelle' : 'Cash';
        const totalValue = Number(order.total) || 0;
        if(!totals[method]) totals[method] = { count:0, revenue:0 };
        totals[method].count += 1;
        totals[method].revenue += totalValue;
      });
      const totalOrders = methodLabels.reduce((sum,label)=>sum + (totals[label]?.count || 0), 0);
      const totalRevenue = methodLabels.reduce((sum,label)=>sum + (totals[label]?.revenue || 0), 0);
      const ordersEl = document.getElementById('analytics-total-orders');
      const revenueEl = document.getElementById('analytics-total-revenue');
      if(ordersEl) ordersEl.textContent = totalOrders;
      if(revenueEl) revenueEl.textContent = `$${totalRevenue.toFixed(2)}`;

      const countData = methodLabels.map(label=>totals[label]?.count || 0);
      const revenueData = methodLabels.map(label=>round2(totals[label]?.revenue || 0));
      renderPaymentDoughnutChart('paymentCount','payment-count-chart', methodLabels, countData, { currency:false });
      renderPaymentDoughnutChart('paymentRevenue','payment-revenue-chart', methodLabels, revenueData, { currency:true });
    }

    function renderAnalyticsExpectedPanel(orderList){
      const tbody = document.getElementById('analytics-expected-body');
      if(!tbody) return;
      const menu = currentMenu();
      const soldByCode = {};
      orderList.forEach(order=>{
        (order.items || []).forEach(it=>{
          const code = it && (it.code || itemCodeMap[it.name]);
          const qty = Number(it && it.quantity) || 0;
          if(!code || qty <= 0) return;
          soldByCode[code] = (soldByCode[code] || 0) + qty;
        });
      });
      let expectedRevenue = 0;
      let actualRevenue = 0;
      let shrinkUnitsTotal = 0;
      let shrinkDollarsTotal = 0;
      const rows = [];
      menu.forEach(item=>{
        const code = item.code;
        const record = getInventoryRecordForCode(code, DAY);
        const price = getEffectivePriceFor(item);
        const initial = record.initial || 0;
        const current = record.current || 0;
        const soldFromInventory = Math.max(0, initial - current);
        const soldActual = soldByCode[code] || 0;
        const unaccountedUnits = soldFromInventory - soldActual;
        const expectedItemRevenue = soldFromInventory * price;
        const unaccountedDollars = unaccountedUnits * price;
        expectedRevenue += expectedItemRevenue;
        shrinkUnitsTotal += unaccountedUnits;
        shrinkDollarsTotal += unaccountedDollars;
        rows.push({
          name: item.name,
          initial,
          current,
          soldActual,
          unaccountedUnits,
          unaccountedDollars
        });
      });
      actualRevenue = orderList.reduce((sum, order)=>sum + (Number(order.total) || 0), 0);
      const expectedEl = document.getElementById('analytics-expected-revenue');
      if(expectedEl) expectedEl.textContent = `$${expectedRevenue.toFixed(2)}`;
      const actualEl = document.getElementById('analytics-actual-revenue');
      if(actualEl) actualEl.textContent = `$${actualRevenue.toFixed(2)}`;
      const shrinkUnitsEl = document.getElementById('analytics-shrinkage-units');
      if(shrinkUnitsEl) shrinkUnitsEl.textContent = shrinkUnitsTotal.toFixed(0);
      const shrinkDollarsEl = document.getElementById('analytics-shrinkage-dollars');
      if(shrinkDollarsEl) shrinkDollarsEl.textContent = `$${shrinkDollarsTotal.toFixed(2)}`;
      tbody.innerHTML = '';
      if(rows.length === 0){
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" style="text-align:center;color:#666;padding:18px;">No data yet.</td>';
        tbody.appendChild(tr);
        return;
      }
      rows.sort((a,b)=> b.unaccountedUnits - a.unaccountedUnits);
      rows.forEach(row=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHTML(row.name)}</td>
          <td>${row.initial}</td>
          <td>${row.current}</td>
          <td>${row.soldActual}</td>
          <td>${row.unaccountedUnits}</td>
          <td>$${row.unaccountedDollars.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderPaymentDoughnutChart(storeKey, canvasId, labels, data, options={}){
      const canvas = document.getElementById(canvasId);
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      killChart(storeKey);
      const colorMap = {
        Cash: 'rgba(184,16,13,0.85)',
        Zelle: 'rgba(79,70,229,0.85)'
      };
      const borderColorMap = {
        Cash: 'rgba(184,16,13,1)',
        Zelle: 'rgba(79,70,229,1)'
      };
      const backgroundColors = labels.map(label=>colorMap[label] || 'rgba(107,114,128,0.8)');
      const borderColors = labels.map(label=>borderColorMap[label] || 'rgba(107,114,128,1)');
      chartStore[storeKey] = new Chart(ctx,{
        type:'doughnut',
        data:{
          labels,
          datasets:[{
            data,
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth:1
          }]
        },
        options:{
          cutout:'58%',
          plugins:{
            legend:{ position:'bottom', labels:{ usePointStyle:true } },
            tooltip:{
              callbacks:{
                label:(context)=>{
                  const value = Number(context.parsed) || 0;
                  if(options.currency){
                    return `${context.label}: $${value.toFixed(2)}`;
                  }
                  return `${context.label}: ${value}`;
                }
              }
            }
          }
        }
      });
    }

    function renderAnalyticsHourlyChart(orderList){
      const hourly = new Array(24).fill(0);
      orderList.forEach(order=>{
        const amount = Number(order.total) || 0;
        const timestamp = Number(order.timestamp);
        const hour = Number.isFinite(timestamp) ? new Date(timestamp).getHours() : new Date().getHours();
        hourly[hour] += amount;
      });
      const labels = hourly.map((_,idx)=>`${idx}:00`);
      const data = hourly.map(value=>round2(value));
      const canvas = document.getElementById('hourly-sales-chart');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      killChart('hourly');
      chartStore['hourly'] = new Chart(ctx,{
        type:'bar',
        data:{
          labels,
          datasets:[{
            label:'Revenue ($)',
            data,
            backgroundColor:'rgba(184,16,13,0.75)',
            borderRadius:6,
            maxBarThickness:32
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{ display:false },
            tooltip:{
              callbacks:{
                label:(context)=>`$${(context.parsed.y || 0).toFixed(2)}`,
                title:(context)=> context[0] && context[0].label ? `Hour ${context[0].label}` : ''
              }
            }
          },
          scales:{
            x:{ grid:{ display:false } },
            y:{ beginAtZero:true, ticks:{ callback:(value)=>`$${value}` } }
          }
        }
      });
    }

    /* ==========================
       Day Init + App Init
       ========================== */
    const editPriceModalEl = document.getElementById('edit-price-modal');
    if(editPriceModalEl){
      editPriceModalEl.addEventListener('click', event=>{
        if(event.target === editPriceModalEl) closeEditPriceModal();
      });
    }
    customerNameModalEl = document.getElementById('customer-name-modal');
    if(customerNameModalEl){
      customerNameModalEl.addEventListener('click', event=>{
        if(event.target === customerNameModalEl) closeCustomerNameModal();
      });
    }
    document.addEventListener('pointerdown', event=>{
      if(activeInventoryTooltip && !activeInventoryTooltip.contains(event.target)){
        hideInlineInventoryTooltip();
      }
    });
    zellePhoneModalEl = document.getElementById('zelle-phone-modal');
    zellePhoneInputEl = document.getElementById('zelle-phone-input');
    if(zellePhoneModalEl){
      zellePhoneModalEl.addEventListener('click', event=>{
        if(event.target === zellePhoneModalEl){
          handleZellePhoneSkip();
        }
      });
    }
    const paymentChangeLinkEl = document.getElementById('payment-change-link');
    if(paymentChangeLinkEl){
      paymentChangeLinkEl.addEventListener('click', handlePaymentChangeClick);
    }
    const inventorySearchInput = document.getElementById('inventory-filter-input');
    if(inventorySearchInput){
      inventorySearchInput.addEventListener('input', event=>{
        setInventorySearch(event.target.value);
      });
      setInventorySearch(inventorySearchInput.value);
    }
    document.querySelectorAll('[data-inventory-filter]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const filter = btn.getAttribute('data-inventory-filter');
        setInventoryFilter(filter);
      });
    });
    function initApp(){
      renderTicketCounters();
      renderTicketColorManager();
      attachTicketColorsListener();
      attachMenuListeners();
      refreshDisplayNameListener();
      initializeMenuItems();
      renderItemsAdminTable();
      syncTicketCounters();
      resetPaymentState();
      refreshOrderMetaUI();
      setMode('POS');
      ensureZelleConfigSeeded();
      renderZelleAccountButtons();
      loadZelleConfig();
      refreshZelleCurrentAccountListener();
      refreshZelleFeeListener();
      loadOOSMap();
      refreshInventoryListener();
      renderInventoryView();
      syncInventoryFilterButtons();
      syncInventoryDayButtons();
      setItemsAdminDay(itemsAdminDay);
      loadOrdersFromFirebase();
    }
    applyPosModeUI();
    setOrderTrackingFilter(orderTrackingFilter);
    initApp();

    /* ==========================
       Utilities
       ========================== */
    function escapeHTML(value){
      if(value === null || value === undefined) return '';
      return String(value)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function round2(x){ return Math.round((x + Number.EPSILON) * 100)/100; }
  </script>
</body>
</html>





