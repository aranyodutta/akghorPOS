<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AK Ghor POS System — 2025</title>

  <!-- Firebase SDK v8 (compatible with your current project) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+Bengali:400,700|Roboto:400,700&display=swap" rel="stylesheet">

  <style>
    /* ========== Base Styles ========== */
    :root{
      --brand:#b8100d;
      --brand-dark:#a50e0c;
      --ink:#333;
      --bg:#ffffff;
      --panel:#f7f7f7;
      --muted:#f0f0f0;
      --ok:#17803d;
      --warn:#b26a00;
      --danger:#b8100d;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Roboto',sans-serif;
      background-color:var(--bg);
      margin:0;
      color:var(--ink);
    }
    .hide{display:none !important;}

    /* Top bar */
    .top-section{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 20px;
      background-color:var(--brand);
      color:#fff;
      gap:16px;
      flex-wrap:wrap;
    }
    .search{min-width:220px;flex:1 1 260px;max-width:420px}
    .search input{
      width:100%;
      padding:8px 10px;
      border-radius:6px;
      border:none;
      font-size:16px;
    }
    .day-switch{
      display:flex; gap:8px; align-items:center;
    }
    .day-switch button{
      padding:8px 12px;
      border:none; border-radius:6px; cursor:pointer;
      font-weight:bold;
      background:#fff2; color:#fff;
    }
    .day-switch button.active{ background:#fff; color:var(--brand); }

    .ticket-section{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    .ticket{display:flex;align-items:center;gap:6px}
    .ticket-label{
      background:#eee;color:#333;padding:6px 10px;border-radius:6px;font-weight:bold;font-size:14px
    }
    .ticket-label.ticket-purple{background:#6f42c1;color:#fff}
    .ticket-label.ticket-red{background:#d6336c;color:#fff}
    .ticket-label.ticket-green{background:#2f9e44;color:#fff}
    .ticket-label.ticket-blue{background:#1c7ed6;color:#fff}
    .ticket-count{font-size:16px;color:#fff}

    /* Layout */
    .container{display:flex}
    .item-grid{
      flex:1;padding:20px;display:flex;flex-wrap:wrap;gap:12px;
      justify-content:flex-start;background:#f9f9f9;min-height:calc(100vh - 140px);
    }
    .order-summary{
      width:360px;background:var(--panel);padding:20px;border-left:1px solid #ddd;position:relative;
    }
    .order-summary h2{margin:0 0 12px;font-size:22px}
    .order-item{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:10px;padding:8px 0;border-bottom:1px solid #e9e9e9
    }
    .order-item .delete-item{
      background:transparent;border:none;color:var(--danger);font-size:18px;cursor:pointer;padding:0 5px;
    }
    .total-amount{
      font-size:32px;font-weight:bold;color:var(--brand);margin-top:12px;text-align:center;
      display:flex;align-items:center;justify-content:center;gap:10px
    }
    .edit-total-icon{cursor:pointer;font-size:18px;color:#333}

    .payment-buttons{display:flex;gap:10px;margin-top:18px}
    .payment-button{
      flex:1;padding:14px;background:var(--brand);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-size:18px
    }
    .payment-button:hover{background:var(--brand-dark)}
    .next-button{
      margin-top:14px;padding:14px;background:#333;color:#fff;cursor:pointer;border:none;border-radius:6px;
      text-align:center;width:100%;font-size:18px;font-weight:bold
    }
    .next-button:hover{background:#555}

    /* Item cards */
    .item-box{
      background:#fff;padding:10px;width:160px;border:1px solid #ddd;text-align:center;cursor:pointer;border-radius:8px;
      transition:transform .1s ease, background-color .2s; box-shadow:0 2px 5px rgba(0,0,0,.06);
      display:flex;flex-direction:column;align-items:center
    }
    .item-box:hover{background:#f7f7f7; transform:translateY(-2px)}
    .item-box strong{font-size:14px;color:#333}
    .item-box .price{font-size:14px;color:var(--brand);font-weight:bold;margin-top:2px}
    .item-box img{max-width:100%;height:auto;margin-top:6px;flex-grow:1;object-fit:contain}
    .item-actions{display:flex;gap:6px;margin-top:8px}
    .edit-price-btn{
      padding:6px 8px;font-size:12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:4px
    }
    .edit-price-btn:hover{background:#f1f5f9}
    .oos-btn{
      padding:6px 8px;font-size:12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer
    }
    .modal-actions{display:flex;justify-content:center;gap:12px;margin-top:18px}
    .modal-button{
      padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:16px
    }
    .modal-button.primary{background:var(--brand);color:#fff}
    .modal-button.primary:hover{background:var(--brand-dark)}
    .modal-button.secondary{background:#e5e7eb;color:#111}
    .modal-button.secondary:hover{background:#d1d5db}
    .modal-label{display:block;text-align:left;font-size:14px;font-weight:600;color:#333;margin-bottom:6px}
    .modal-reset{margin-top:12px;font-size:13px;color:var(--brand);background:none;border:none;cursor:pointer;text-decoration:underline}
    .modal-reset:hover{color:var(--brand-dark)}
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:rgba(17,24,39,.92);color:#fff;padding:10px 18px;border-radius:999px;font-size:14px;box-shadow:0 10px 25px rgba(0,0,0,.18);z-index:2000;opacity:0;pointer-events:none;transition:opacity .2s ease}
    .toast.show{opacity:1}
    .oos-tag{
      font-size:11px;color:#fff;background:#777;border-radius:6px;padding:2px 6px;margin-left:6px
    }
    .is-oos{opacity:.45; outline:2px dashed #aaa; outline-offset:-6px}

    /* Bottom tabs */
    .bottom-tabs{
      position:fixed;bottom:0;left:0;width:100%;background:var(--brand);
      display:flex;justify-content:center;gap:12px;padding:10px
    }
    .tab-button{
      padding:10px 16px;margin:0;border:none;border-radius:6px;font-weight:bold;color:#fff;background:var(--brand);
      cursor:pointer
    }
    .tab-button.active{background:var(--brand-dark)}

    /* Display Mode */
    .display-mode .top-section, .display-mode .bottom-tabs{display:none}
    .qr-section{
      background:#f9f9f9;position:relative;overflow:hidden;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh
    }
    .display-mode .qr-section{
      background-image:url('https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/durga_puja_background.jpg');
      background-size:cover;background-position:center;
    }
    .logo{width:260px;margin-bottom:10px;z-index:2;position:relative}
    .display-container{
      display:none;grid-template-columns:1.1fr 0.9fr;gap:24px;max-width:1280px;margin:auto;padding:24px;width:100%;z-index:2
    }
    .display-left{
      background:#fff;border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.06);display:flex;flex-direction:column;gap:16px;max-height:calc(100vh - 160px);overflow:auto
    }
    .display-right{
      background:#fff;border-radius:16px;padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;box-shadow:0 4px 12px rgba(0,0,0,.06);max-height:calc(100vh - 160px);overflow:auto
    }
    .brand-badge{display:inline-flex;gap:8px;align-items:center;font-size:12px;color:#6b7280;background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .brand-badge img{height:16px;width:16px;object-fit:contain;border-radius:4px}
    .brand-ghost{opacity:.8}
    .display-brand{position:fixed;right:14px;bottom:12px;z-index:1000}
    @media (max-width:900px){.display-brand{right:8px;bottom:8px}}
    .display-order-header{font-size:24px;font-weight:700;color:var(--brand)}
    .display-order-items{display:flex;flex-direction:column;gap:12px}
    .display-order-row{display:flex;justify-content:space-between;align-items:flex-start;gap:16px}
    .display-order-info{display:flex;flex-direction:column;gap:4px}
    .display-order-name{font-size:18px;font-weight:600;color:#222}
    .display-order-meta{font-size:14px;color:#666}
    .display-order-line-total{font-size:18px;font-weight:700;color:#222}
    .display-left-totals{display:flex;flex-direction:column;gap:8px;margin-top:auto;padding-top:16px;border-top:1px solid #e5e5e5}
    .display-left-total-row{display:flex;justify-content:space-between;align-items:center;font-size:20px;font-weight:700;color:var(--brand)}
    .display-left-total-row.subtotal{font-size:18px;font-weight:600;color:#111}
    .display-left-total-row.fee{font-size:18px;font-weight:600;color:var(--warn)}
    .display-left-total-row.grand{font-size:24px;font-weight:800;color:var(--brand)}
    .display-left-empty{font-size:18px;color:#555;text-align:center;padding:40px 0}
    .display-total{font-size:clamp(36px,6vw,64px);font-weight:800;color:var(--brand)}
    .display-memo{font-size:clamp(16px,2.6vw,24px);color:#333}
    .display-qr{max-width:360px;width:100%;height:auto}
    .display-right-logo{width:240px;max-width:100%;height:auto}
    .qr-missing{font-size:20px;color:var(--danger);font-weight:bold;text-align:center}
    .display-zelle-logo{height:64px;object-fit:contain}
    .quote-container{
      position:absolute;bottom:20px;width:80%;text-align:center;background:rgba(255,255,255,.72);
      padding:10px;border-radius:10px;font-family:'Noto Sans Bengali',sans-serif;font-size:22px;color:#333;animation:fadeInOut 10s infinite
    }
    .fullscreen-button{
      position:fixed;bottom:10px;right:10px;padding:10px;background:#333;color:#fff;border:none;border-radius:6px;z-index:1000;font-weight:bold;cursor:pointer
    }

    @keyframes fadeInOut{
      0%{opacity:0}10%{opacity:1}90%{opacity:1}100%{opacity:0}
    }

    /* Order Tracking */
    .order-tracking{display:none;padding:20px}
    .order-tracking h2{margin:0 0 10px}
    .subtabs{display:flex;gap:8px;margin:8px 0 12px}
    .subtabs button{padding:8px 12px;border:none;border-radius:6px;background:#eee;cursor:pointer;font-weight:bold}
    .subtabs button.active{background:var(--brand);color:#fff}
    .order-tracking table{width:100%;border-collapse:collapse;overflow-x:auto}
    .order-tracking th, .order-tracking td{border:1px solid #ddd;padding:6px;text-align:center;font-size:12px}
    .order-tracking tr:nth-child(even){background:#f7f7f7}
    .order-tracking th{background:#4CAF50;color:#fff;position:sticky;top:0;z-index:1}
    .order-overwritten td{background:#fff3cd}
    #download-csv{margin-top:10px;padding:10px;background:#333;color:#fff;border:none;border-radius:6px;font-weight:bold;cursor:pointer}
    .delete-order-button{background:transparent;border:none;color:var(--danger);font-size:18px;cursor:pointer}
    .controls-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    /* Zelle confirmations small buttons */
    .btn-small{padding:6px 10px;border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:bold}
    .btn-ok{background:var(--ok)}
    .btn-warn{background:var(--warn)}
    .btn-muted{background:#6b7280}

    .zelle-account-control{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    .current-account-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .current-account-row strong{font-size:16px}
    .current-account-detail{font-size:14px;color:#555}
    .zelle-account-buttons{display:flex;flex-wrap:wrap;gap:8px}
    .zelle-account-button{
      padding:8px 14px;border:1px solid var(--brand);border-radius:6px;background:#fff;color:var(--brand);
      font-weight:bold;cursor:pointer;transition:background .2s,color .2s;display:flex;flex-direction:column;align-items:center;
      gap:4px;min-width:86px
    }
    .zelle-account-button:hover{background:var(--brand);color:#fff}
    .zelle-account-button.active{background:var(--brand);color:#fff;box-shadow:0 0 0 1px #fff inset}
    .zelle-account-button:disabled{cursor:default;opacity:.9}
    .zelle-account-button .account-code{font-size:16px}
    .zelle-account-button .account-label{font-size:12px;color:#555;font-weight:500}
    .zelle-account-button .account-action{font-size:12px;font-weight:bold;color:inherit}
    .zelle-account-totals{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .zelle-fee-card{background:#fff;border:1px solid rgba(184,16,13,.25);border-radius:12px;padding:14px;box-shadow:0 6px 16px rgba(0,0,0,.05);display:flex;flex-direction:column;gap:12px}
    .zelle-fee-card h3{margin:0;font-size:15px;color:#b0100d}
    .zelle-fee-row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .zelle-fee-toggle{display:flex;align-items:center;gap:8px;font-weight:600;color:#333}
    .zelle-fee-toggle input[type="checkbox"]{width:20px;height:20px}
    .zelle-fee-amount-input{width:120px;padding:8px;border-radius:8px;border:1px solid #d1d5db;font-size:14px}
    .zelle-fee-save{align-self:flex-start;padding:8px 14px;border:none;border-radius:6px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
    .zelle-fee-save:disabled{opacity:.6;cursor:default}
    .account-total-card{
      background:#fff;border:1px solid #ddd;border-radius:8px;padding:10px 14px;display:flex;
      flex-direction:column;gap:4px;min-width:140px
    }
    .account-total-card.active{border-color:var(--brand);box-shadow:0 0 0 2px rgba(184,16,13,.15)}
    .zelle-top-layout{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;margin-top:16px}
    .zelle-left-stack{flex:1 1 460px;min-width:320px;display:flex;flex-direction:column;gap:12px}
    .switch-log-card{
      flex:0 0 260px;max-width:320px;background:#fff;border:1px solid rgba(184,16,13,.25);
      border-radius:12px;padding:14px;box-shadow:0 6px 16px rgba(0,0,0,.05)
    }
    .switch-log-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .switch-log-header h3{margin:0;font-size:15px;color:#b0100d}
    .switch-log-clear{
      background:transparent;border:none;color:#b0100d;font-size:12px;font-weight:600;cursor:pointer;
      padding:4px 6px;border-radius:6px
    }
    .switch-log-clear:hover{background:rgba(184,16,13,.1)}
    .switch-log-list{display:flex;flex-direction:column;gap:4px;max-height:280px;overflow-y:auto}
    .switch-log-row{
      display:grid;grid-template-columns:1fr 1.1fr auto;gap:8px;align-items:center;font-size:12px;
      padding:6px 8px;border-radius:8px;background:#fff;border:1px solid rgba(0,0,0,.06);
      box-shadow:0 1px 2px rgba(0,0,0,.05)
    }
    .switch-log-row:hover{background:rgba(184,16,13,.06)}
    .switch-log-time{color:#4b5563;font-weight:600}
    .switch-log-arrow{text-align:right;color:#b0100d;font-weight:600}
    .switch-log-delete{
      background:transparent;border:none;color:#b0100d;font-size:14px;cursor:pointer;line-height:1;padding:2px 4px;
      border-radius:50%
    }
    .switch-log-delete:hover{background:rgba(184,16,13,.1)}
    .switch-log-empty{font-size:12px;color:#666;padding:6px 0}

    /* Analytics */
    .analytics{display:none;padding:20px}
    .analytics-summary{display:flex;justify-content:center;margin-bottom:20px}
    .total-sales{font-size:44px;font-weight:bold;color:var(--brand)}
    .charts-container{display:flex;flex-wrap:wrap;justify-content:center}
    .chart-wrapper{width:45%;min-width:320px;margin:18px}
    .charts-container canvas{max-width:100%;height:auto}
    @media (max-width:900px){.chart-wrapper{width:100%}}

    /* Modals */
    .modal{display:none;position:fixed;z-index:1001;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,.4)}
    .modal-content{
      background:#fff;margin:8% auto;padding:20px;border:1px solid #888;width:420px;max-width:92%;
      text-align:center;border-radius:12px;position:relative
    }
    .close-modal-button{
      position:absolute;top:10px;right:16px;background:transparent;border:none;color:#999;font-size:28px;font-weight:bold;cursor:pointer
    }
    .close-modal-button:hover{color:#000}
    .payment-option-button{
      width:85%;padding:14px;margin:10px 0;background:var(--brand);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:18px
    }
    .payment-option-button:hover{background:var(--brand-dark)}
    .row{display:flex;justify-content:space-between;align-items:center;margin:10px 0}
    .pill{
      border:1px solid #ccc;border-radius:20px;padding:6px 10px;display:inline-flex;gap:6px;align-items:center
    }
    .pill button{
      border:none;background:#eee;border-radius:14px;padding:4px 8px;cursor:pointer;font-weight:bold
    }
    .pill button.active{background:var(--brand);color:#fff}
    .name-button{
      padding:8px 12px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;
      background:rgba(255,255,255,.2);color:#fff;transition:background .2s ease,transform .2s ease
    }
    .name-button:hover{background:rgba(255,255,255,.3);transform:translateY(-1px)}
    .name-button:focus{outline:2px solid #fff;outline-offset:2px}
    .order-summary-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .order-number-display{
      font-size:20px;font-weight:700;color:var(--brand);margin-bottom:14px;padding:8px 12px;border-radius:10px;
      background:#fff;border:1px solid rgba(184,16,13,.2);display:inline-flex;gap:6px;align-items:center
    }
    .display-name-banner{
      display:none;position:relative;margin-bottom:16px;padding:10px 20px;border-radius:12px;
      background:rgba(255,255,255,.9);color:#111;font-size:clamp(20px,3vw,34px);font-weight:700;
      box-shadow:0 10px 24px rgba(0,0,0,.12);backdrop-filter:blur(4px);z-index:3
    }
    .display-name-banner.active{display:inline-flex;animation:displayNameEnter .35s ease forwards}
    @keyframes displayNameEnter{from{opacity:0;transform:translateY(-12px);}to{opacity:1;transform:translateY(0);}}
    .display-order-number{font-size:clamp(30px,5vw,52px);font-weight:800;color:var(--brand);text-align:center}
    .display-order-number-inline{font-size:clamp(20px,3.4vw,32px);text-align:left}
    .customer-name-input{width:100%;padding:10px;font-size:18px;border-radius:8px;border:1px solid #d1d5db}
  </style>
</head>
<body>

  <!-- Top: Search + Day switch + Tickets -->
  <div class="top-section">
    <div class="search">
      <input type="text" placeholder="Search" id="search-input" onkeyup="searchItems()" />
    </div>

    <div class="day-switch">
      <span style="font-weight:bold;">Day:</span>
      <button id="btn-day-sat" class="active" onclick="setDay('SAT')">Saturday</button>
      <button id="btn-day-sun" onclick="setDay('SUN')">Sunday</button>
      <span class="oos-tag">2025</span>
    </div>

    <button id="customer-name-button" class="name-button" type="button" onclick="openCustomerNameModal()">Name</button>

    <div class="ticket-section">
      <div class="ticket"><div class="ticket-label ticket-purple">Purple</div><span class="ticket-count" id="ticket-purple-count">0</span></div>
      <div class="ticket"><div class="ticket-label ticket-red">Red</div><span class="ticket-count" id="ticket-red-count">0</span></div>
      <div class="ticket"><div class="ticket-label ticket-green">Green</div><span class="ticket-count" id="ticket-green-count">0</span></div>
      <div class="ticket"><div class="ticket-label ticket-blue">Blue</div><span class="ticket-count" id="ticket-blue-count">0</span></div>
    </div>
  </div>
  <!-- Mode Switch -->
  <div style="padding:10px 20px;display:flex;gap:10px;align-items:center;">
    <button onclick="setMode('POS')">POS Mode (iPad/Computer)</button>
    <button onclick="setMode('Display')">Display Mode (Phone)</button>
  </div>
  <!-- Main -->
  <div class="container">
    <div class="item-grid" id="item-grid"></div>

    <div class="order-summary">
      <div class="order-summary-header">
        <h2 id="current-order-heading">Current Order</h2>
      </div>
      <div id="order-list"></div>
      <div id="current-order-number-display" class="order-number-display">Order #<span id="current-order-number">1</span></div>
      <div class="total-amount">
        $<span id="total-price-summary">0.00</span>
        <span class="edit-total-icon" title="Edit Total" onclick="openEditTotalModal()">&#9998;</span>
      </div>
      <div class="payment-buttons">
        <button class="payment-button" onclick="processPayment('Cash')">Cash</button>
        <button class="payment-button" onclick="processPayment('Zelle')">Zelle</button>
      </div>
      <button class="next-button" onclick="clearOrder()">Next Customer</button>
    </div>
  </div>

  <!-- Display Section (for Display Mode) -->
  <div class="qr-section">
    <img src="https://assets.cdn.filesafe.space/slWdpqUTRhMfisMySSJ0/media/66f7050f5b684e16ab132d41.jpeg" alt="Company Logo" class="logo">
    <div class="display-name-banner" id="display-name-banner"></div>
    <div class="display-container" id="display-container">
      <div class="display-left" id="display-order-list"></div>
      <div class="display-right" id="display-payment-panel"></div>
    </div>
    <div class="quote-container" id="quote-container"></div>
  </div>

  <!-- Fullscreen -->
  <button class="fullscreen-button" onclick="toggleFullscreen()">Fullscreen</button>



  <!-- Order Tracking -->
  <div class="order-tracking" id="order-tracking">
    <div class="controls-row">
      <h2 style="margin-right:auto">Order Log</h2>
      <div class="subtabs">
        <button id="ot-sat" class="active" onclick="switchDaySubtab('SAT','ot')">Saturday</button>
        <button id="ot-sun" onclick="switchDaySubtab('SUN','ot')">Sunday</button>
      </div>
    </div>
    <div class="controls-row">
      <button id="download-csv" onclick="downloadCSV()">Download CSV</button>
      <button id="clear-orders" onclick="clearAllOrders()">Clear Orders</button>
    </div>
    <div style="overflow-x:auto; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Order #</th>
            <th>Time</th>
            <th>Name</th>
            <!-- Item Codes will be auto headers from menuItems -->
            <th id="th-dynamic-start" colspan="1"></th>
            <th>Total</th>
            <th>Payment Method</th>
            <th>Pass Fee</th>
            <th>Fee</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="order-log"></tbody>
      </table>
    </div>
  </div>

  <!-- Zelle Confirmations -->
  <div class="order-tracking" id="zelle-confirmations">
    <div class="controls-row">
      <h2 style="margin-right:auto">Zelle Control</h2>
      <div class="subtabs">
        <button id="ze-sat" class="active" onclick="switchDaySubtab('SAT','ze')">Saturday</button>
        <button id="ze-sun" onclick="switchDaySubtab('SUN','ze')">Sunday</button>
      </div>
    </div>
    <div class="zelle-top-layout">
      <div class="zelle-left-stack">
        <div class="zelle-account-control">
          <div class="current-account-row">
            <strong>Current Account:</strong>
            <span id="current-zelle-account">—</span>
            <span id="current-zelle-account-detail" class="current-account-detail" style="display:none"></span>
          </div>
          <div id="zelle-account-buttons" class="zelle-account-buttons"></div>
        </div>
        <div class="zelle-fee-card" aria-labelledby="zelle-fee-heading">
          <h3 id="zelle-fee-heading">Zelle Fee</h3>
          <div class="zelle-fee-row">
            <label class="zelle-fee-toggle" for="zelle-fee-toggle">
              <input type="checkbox" id="zelle-fee-toggle" onchange="handleZelleFeeToggleChange()" />
              Enable processing fee
            </label>
          </div>
          <div class="zelle-fee-row">
            <label for="zelle-fee-amount" style="font-weight:600;color:#333">Fee amount ($)</label>
            <input type="number" id="zelle-fee-amount" class="zelle-fee-amount-input" min="0" max="20" step="0.50" />
          </div>
          <button type="button" class="zelle-fee-save" onclick="saveZelleFeeSettings()">Save</button>
        </div>
        <div class="controls-row" style="margin-top:12px">
          <button onclick="downloadZelleCSV()">Download CSV</button>
        </div>
        <div id="zelle-account-totals" class="zelle-account-totals"></div>
      </div>
      <div class="switch-log-card">
        <div class="switch-log-header">
          <h3>Switch Log</h3>
          <button type="button" id="switch-log-clear-button" class="switch-log-clear" onclick="clearZelleSwitchLog()" style="display:none">Clear log</button>
        </div>
        <div id="zelle-switch-log" class="switch-log-list"></div>
      </div>
    </div>
    <div style="overflow-x:auto; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Order #</th>
            <th>Total</th>
            <th>Account</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="zelle-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Stock Log -->
  <div class="order-tracking" id="stock-log">
    <div class="controls-row">
      <h2 style="margin-right:auto">Stock Log</h2>
      <div class="subtabs">
        <button id="sl-sat" class="active" onclick="switchDaySubtab('SAT','sl')">Saturday</button>
        <button id="sl-sun" onclick="switchDaySubtab('SUN','sl')">Sunday</button>
      </div>
    </div>

    <div class="controls-row">
      <button id="stock-download-csv" onclick="downloadStockCSV()">Download CSV</button>
      <button id="stock-clear" onclick="clearAllStockLog()">Clear Stock Log</button>
    </div>

    <div style="overflow-x:auto; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Code</th>
            <th>Item</th>
            <th>Status</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="stock-log-body"></tbody>
      </table>
    </div>
  </div>


  <!-- Analytics -->
  <div class="analytics" id="analytics">
    <div class="controls-row">
      <h2 style="margin-right:auto">Sales Analytics</h2>
      <div class="subtabs">
        <button id="an-sat" class="active" onclick="switchDaySubtab('SAT','an')">Saturday</button>
        <button id="an-sun" onclick="switchDaySubtab('SUN','an')">Sunday</button>
      </div>
    </div>
    <div class="analytics-summary">
      <div class="total-sales">Total Sales: $<span id="grand-total-sales">0.00</span></div>
    </div>
    <div class="charts-container">
      <div class="chart-wrapper"><canvas id="sales-over-time-chart"></canvas></div>
      <div class="chart-wrapper"><canvas id="best-selling-items-chart"></canvas></div>
      <div class="chart-wrapper"><canvas id="payment-methods-chart"></canvas></div>
      <div class="chart-wrapper"><canvas id="orders-over-time-chart"></canvas></div>
      <div class="chart-wrapper"><canvas id="hourly-sales-chart"></canvas></div>
      <!-- OOS analytics could go here in the future -->
    </div>
  </div>

  <!-- Footer Tabs -->
   <div class="bottom-tabs">
    <button id="pos-tab-button" class="tab-button active" onclick="switchTab('POS')">POS</button>
    <button id="order-tracking-tab-button" class="tab-button" onclick="switchTab('Order Tracking')">Order Tracking</button>
    <button id="zelle-tab-button" class="tab-button" onclick="switchTab('Zelle')">Zelle Control</button>
    <button id="stock-tab-button" class="tab-button" onclick="switchTab('Stock Log')">Stock Log</button>
    <button id="analytics-tab-button" class="tab-button" onclick="switchTab('Analytics')">Analytics</button>
  </div>

  <!-- Edit Total Modal -->
  <div id="edit-total-modal" class="modal">
    <div class="modal-content">
      <button class="close-modal-button" onclick="closeEditTotalModal()">&times;</button>
      <h2>Edit Total Price</h2>
      <input type="number" id="new-total-price" step="0.01" min="0" style="width: 80%; padding: 10px; font-size: 18px;">
      <button class="payment-option-button" style="margin-top: 20px;" onclick="updateTotalPrice()">Update</button>
    </div>
  </div>

  <!-- Edit Price Modal -->
  <div id="edit-price-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-price-title">
    <div class="modal-content" role="document">
      <button class="close-modal-button" onclick="closeEditPriceModal()" aria-label="Close edit price dialog">&times;</button>
      <h2 id="edit-price-title">Edit Price</h2>
      <div style="margin:18px 0 0;text-align:left">
        <label for="edit-price-input" class="modal-label">Price</label>
        <input type="number" id="edit-price-input" step="0.01" min="0" style="width:100%;padding:10px;font-size:18px;">
      </div>
      <div style="margin:16px 0 0;text-align:left">
        <label for="edit-ticket-color-select" class="modal-label">Ticket Color</label>
        <select id="edit-ticket-color-select" style="width:100%;padding:10px;font-size:16px;border-radius:8px;border:1px solid #d1d5db;">
          <option value="na">N/A</option>
          <option value="purple">Purple</option>
          <option value="red">Red</option>
          <option value="green">Green</option>
          <option value="blue">Blue</option>
        </select>
      </div>
      <div class="modal-actions">
        <button type="button" class="modal-button secondary" onclick="closeEditPriceModal()">Cancel</button>
        <button type="button" class="modal-button primary" onclick="savePriceOverride()">Save</button>
      </div>
      <button type="button" id="reset-price-button" class="modal-reset" onclick="resetPriceOverride()">Reset to default</button>
    </div>
  </div>

  <!-- Customer Name Modal -->
  <div id="customer-name-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="customer-name-title">
    <div class="modal-content" role="document">
      <button class="close-modal-button" onclick="closeCustomerNameModal()" aria-label="Close customer name dialog">&times;</button>
      <h2 id="customer-name-title">Customer Name</h2>
      <div style="margin:18px 0 0;text-align:left">
        <label for="customer-name-input" class="modal-label">Name</label>
        <input type="text" id="customer-name-input" class="customer-name-input" placeholder="Enter name" maxlength="64">
      </div>
      <div class="modal-actions" style="margin-top:20px">
        <button type="button" class="modal-button secondary" onclick="skipCustomerName()">Skip</button>
        <button type="button" class="modal-button primary" onclick="saveCustomerName()">Save</button>
      </div>
    </div>
  </div>

  <div id="price-toast" class="toast" role="status" aria-live="polite"></div>

  <!-- (Stripe card modal removed for Zelle/Cash flow) -->

  <script>
    /* ==========================
       CONFIG + GLOBAL STATE
       ========================== */

    // Firebase configuration (same project)
    const firebaseConfig = {
      apiKey: "AIzaSyDHoasqENlnp0zSAsz-3HfMkx4tgG-oZhA",
      authDomain: "akghorpos.firebaseapp.com",
      databaseURL: "https://akghorpos-default-rtdb.firebaseio.com",
      projectId: "akghorpos",
      storageBucket: "akghorpos.appspot.com",
      messagingSenderId: "791887148716",
      appId: "1:791887148716:web:5c8fb06053dcd6e5799109",
      measurementId: "G-7DE60HHEK8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2025 Season + Day split
    const SEASON = '2025';
    let DAY = 'SAT'; // default; can switch to 'SUN'

    // Ticket display metadata (color -> element id)
    const TICKET_COLOR_META = {
      'Purple': { elementId:'ticket-purple-count' },
      'Red': { elementId:'ticket-red-count' },
      'Green': { elementId:'ticket-green-count' },
      'Blue': { elementId:'ticket-blue-count' }
    };
    const TICKET_COLOR_KEYS = Object.keys(TICKET_COLOR_META);

    const BRAND = {
      enabled: true,
      name: "Stratford Meridian",
      logoSquare: "https://i.postimg.cc/WdXhV0pN/SMALL-sm-logo-main-2.png",
      logoText: "https://i.postimg.cc/mhHz9cjj/SMALL-sm-logo-black-TEXT.png",
      link: null
    };

    // Menu overrides (price + ticket color)
    let menuOverrides = {};
    let menuOverridesRef = null;
    let currentPriceEdit = null;
    let lastFocusBeforePriceModal = null;
    let priceToastTimeout = null;
    let currentCustomerName = '';
    let customerNameModalEl = null;
    let lastFocusBeforeNameModal = null;
    let displayNameRef = null;

    // Zelle account state
    let activeZelleAccount = null;
    let zelleAccountConfig = {};
    let zelleConfigRef = null;
    let zelleCurrentAccountRef = null;
    let zelleFeeConfig = { enabled:false, amountCents:0 };
    let zelleFeeRef = null;
    let latestZelleAccountTotals = {};

    // App state
    let total = 0;
    let orderList = [];
    let orderNumber = 0; // per-day, as in original
    let currentOrderRef = null;
    let orderHistory = {};
    let ordersRef = null;
    let isTotalOverwritten = false;
    const oosMap = {}; // code -> boolean (true = OOS)
    let posBrandBadgeEl = null;
    let displayBrandFloatingEl = null;

   /* ==========================
       MENU (2025 — per day)
       ========================== */
// SATURDAY
const menuItemsSAT = [
  { name:'Vegetable Chop (2)', price:8.00, ticketColor:'Purple', code:'VC',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d07fa05f3c2e6fb4a6.png' },
  { name:'Mochar Chop (2)',    price:8.00, ticketColor:'Purple', code:'MCH',
    image:'https://i.ibb.co/svz40VyF/Mochar-Chop-02-removebg-preview.png' },
  { name:'Phuchka (6)',        price:8.00, ticketColor:'Purple', code:'PK',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d0b27ab06b35ca1f6a.png' },
  { name:'Chandrapouli (2)',   price:8.00, ticketColor:'Purple', code:'CP',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d07fa05f61a06fb4a5.png' },
  { name:'Kacha Golla',        price:8.00, ticketColor:'Purple', code:'KG',
    image:'https://i.postimg.cc/bGbLMVgS/download-removebg-preview-1.png' },
  { name:'Patisapta (2)',      price:10.00, ticketColor:'Red',    code:'PS',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d060741004166cbed6.png' },
  { name:'Jhal Muri',          price:7.00,  ticketColor:'Green',  code:'JM',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d05b2570a5a1cb27bb.png' },
  { name:'Misti Paan',         price:2.50,  ticketColor:null,     code:'MP',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d08c006b5d16abcfae.png' },
  { name:'Coffee',             price:5.00,  ticketColor:'Blue',   code:'MC',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d06074102d146cbed5.png' },
  { name:'Bengali Cha',        price:5.00,  ticketColor:'Blue',   code:'CHA',
    image:'https://i.ibb.co/gFFK4CzL/sddefault-removebg-preview.png' },
  { name:'Water',              price:1.00,  ticketColor:null,     code:'W',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d0ed66479dc3b42f76.png' },
  { name:'Coke',               price:2.00,  ticketColor:null,     code:'C',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d0a5ba95a7dbb6c7ba.png' },
  { name:'Pujor Mishti Box',   price:12.00, ticketColor:null,     code:'PMB',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d0a5ba95c546b6c7b8.png' },
  { name:'Sindoor',            price:2.00,  ticketColor:null,     code:'SND',
    image:'https://i.ibb.co/6R4YKNf6/40332013-3-1-pearlfiesta-red-sindoor-powder-each-box-contains-10-gm-each-removebg-preview.png' }
];


// SUNDAY
const menuItemsSUN = [
  { name:'Vegetable Chop (2)', price:8.00,  ticketColor:'Purple', code:'VC',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d07fa05f3c2e6fb4a6.png' },
  { name:'Mochar Chop (2)',    price:8.00,  ticketColor:'Purple', code:'MCH',
    image:'https://i.ibb.co/svz40VyF/Mochar-Chop-02-removebg-preview.png' },
  { name:'Phuchka (6)',        price:8.00,  ticketColor:'Purple', code:'PK',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d0b27ab06b35ca1f6a.png' },
  { name:'Chandrapouli (2)',   price:8.00,  ticketColor:'Purple', code:'CP',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d07fa05f61a06fb4a5.png' },
  { name:'Baked Sandesh (2)',  price:8.00,  ticketColor:'Purple', code:'BS',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d07fa05f83316fb4a4.png' },
  { name:'Kacha Golla',        price:8.00,  ticketColor:'Purple', code:'KG',
    image:'https://i.postimg.cc/bGbLMVgS/download-removebg-preview-1.png' },
  { name:'Patisapta (2)',      price:10.00, ticketColor:'Red',    code:'PS',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d060741004166cbed6.png' },
  { name:'Jhal Muri',          price:7.00,  ticketColor:'Green',  code:'JM',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d05b2570a5a1cb27bb.png' },
  { name:'Misti Paan',         price:2.50,  ticketColor:null,     code:'MP',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d08c006b5d16abcfae.png' },
  { name:'Coffee',             price:5.00,  ticketColor:'Blue',   code:'MC',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d06074102d146cbed5.png' },
  { name:'Bengali Cha',        price:5.00,  ticketColor:'Blue',   code:'CHA',
    image:'https://i.ibb.co/gFFK4CzL/sddefault-removebg-preview.png' },
  { name:'Water',              price:1.00,  ticketColor:null,     code:'W',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d0ed66479dc3b42f76.png' },
  { name:'Coke',               price:2.00,  ticketColor:null,     code:'C',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d0a5ba95a7dbb6c7ba.png' },
  { name:'Pujor Mishti Box',   price:12.00, ticketColor:null,     code:'PMB',
    image:'https://storage.googleapis.com/msgsndr/slWdpqUTRhMfisMySSJ0/media/66fe07d0a5ba95c546b6c7b8.png' },
  { name:'Sindoor',            price:2.00,  ticketColor:null,     code:'SND',
    image:'https://i.ibb.co/6R4YKNf6/40332013-3-1-pearlfiesta-red-sindoor-powder-each-box-contains-10-gm-each-removebg-preview.png' },
  { name:'Paan Leaves (2)',    price:1.00,  ticketColor:null,     code:'PL',
    image:'https://i.ibb.co/XkFsRwKL/download-removebg-preview.png' }
];

function currentMenu(){ return DAY === 'SAT' ? menuItemsSAT : menuItemsSUN; }

    // Map name -> code (rebuild when needed)
    const itemCodeMap = {};
    function rebuildItemCodeMap(){
      Object.keys(itemCodeMap).forEach(k=>delete itemCodeMap[k]);
      currentMenu().forEach(it => {
        itemCodeMap[it.name] = it.code;
      });
    }

    function menuOverridesPath(){ return `menu/${SEASON}/${DAY}`; }
    function menuOverrideItemPath(code){ return `${menuOverridesPath()}/${code}`; }

    function refreshMenuOverridesListener(){
      if(menuOverridesRef){ menuOverridesRef.off(); }
      menuOverrides = {};
      menuOverridesRef = db.ref(menuOverridesPath());
      menuOverridesRef.on('value', snapshot=>{
        const node = snapshot.val() || {};
        const next = {};
        Object.keys(node).forEach(code=>{
          const entry = node[code] || {};
          const override = {};
          if(Object.prototype.hasOwnProperty.call(entry,'price')){
            const raw = parseFloat(entry.price);
            if(!isNaN(raw)) override.price = raw;
          }
          if(Object.prototype.hasOwnProperty.call(entry,'ticketColor')){
            override.ticketColor = normalizeTicketColorValue(entry.ticketColor);
          }
          if(Object.keys(override).length){
            next[code] = override;
          }
        });
        menuOverrides = next;
        initializeMenuItems();
      });
    }

    function normalizeTicketColorValue(value){
      const raw = value === undefined || value === null ? '' : String(value).trim().toLowerCase();
      if(raw === '' || raw === 'na' || raw === 'n/a' || raw === 'none') return 'na';
      if(raw === 'purple' || raw === 'red' || raw === 'green' || raw === 'blue') return raw;
      return 'na';
    }

    function ticketColorValueToLabel(value){
      switch(value){
        case 'purple': return 'Purple';
        case 'red': return 'Red';
        case 'green': return 'Green';
        case 'blue': return 'Blue';
        default: return null;
      }
    }

    function getMenuOverride(code){
      if(!code) return null;
      return Object.prototype.hasOwnProperty.call(menuOverrides, code) ? menuOverrides[code] : null;
    }

    function hasMenuOverride(code){
      const override = getMenuOverride(code);
      if(!override) return false;
      return override.price !== undefined || override.ticketColor !== undefined;
    }

    function getOverrideTicketColorValue(code){
      const override = getMenuOverride(code);
      return override && override.ticketColor !== undefined ? override.ticketColor : null;
    }

    function getItemDefaultTicketColorValue(item){
      if(!item || !item.ticketColor) return 'na';
      return normalizeTicketColorValue(item.ticketColor);
    }

    function getEffectiveTicketColorValue(item){
      if(!item) return 'na';
      const code = item.code;
      const overrideValue = code ? getOverrideTicketColorValue(code) : null;
      if(overrideValue && overrideValue !== 'na') return overrideValue;
      if(overrideValue === 'na') return 'na';
      return getItemDefaultTicketColorValue(item);
    }

    function getEffectiveTicketColorLabel(item){
      const value = getEffectiveTicketColorValue(item);
      return ticketColorValueToLabel(value);
    }

    function getEffectivePriceFor(item){
      if(!item) return 0;
      const fallback = parseFloat(item.price) || 0;
      const override = item.code ? getMenuOverride(item.code) : null;
      if(override && override.price !== undefined){
        const raw = parseFloat(override.price);
        if(!isNaN(raw)) return raw;
      }
      return fallback;
    }

    /* ==========================
       Quotes (Display Mode)
       ========================== */
    const quotes = [
      'যদি তোর ডাক শুনে কেউ না আসে তবে একলা চলো রে',
      'আমার মুক্তি আলোয় আলোয় এই আকাশে',
      'প্রাণ ভরিয়ে, তৃষা হরিয়ে, মোরে আরো আরো আরো দাও প্রাণ',
      'আমার সকল রসের ধারা তুমি হরছো শুকায়ে',
      'দাও ফিরে সে অরণ্য লও এ নগর',
      'পুরানো সেই দিনের কথা ভুলবি কিরে হায়',
      'আমি চিরতরে দূরে চলে যাবো তবু আমারে দেবো না ভুলিতে',
      'তুমি সন্ধ্যার মেঘমালা তুমি তারার আলো',
      'তুমি রবে নীরবে হৃদয়ে মম',
      'হৃদয় আমার নাচেরে আজিকে ময়ূরের মত নাচেরে'
    ];
    let currentQuoteIndex = 0, quoteInterval;

    /* ==========================
       Mode: POS vs Display
       ========================== */
    function setMode(mode){
      if(mode==='POS'){
        document.body.classList.remove('display-mode');
        document.querySelector('.item-grid').style.display='flex';
        document.querySelector('.order-summary').style.display='block';
        document.querySelector('.top-section').style.display='flex';
        document.querySelector('.bottom-tabs').style.display='flex';
        document.querySelector('.qr-section').style.display='none';
        ensurePOSBrandBadge();
        refreshDisplayFloatingBrand(false);
        if(currentOrderRef){ currentOrderRef.off(); currentOrderRef=null; }
        resetDisplayPanels();
        clearInterval(quoteInterval);
      }else{
        document.body.classList.add('display-mode');
        document.querySelector('.item-grid').style.display='none';
        document.querySelector('.order-summary').style.display='none';
        document.querySelector('.top-section').style.display='none';
        document.querySelector('.bottom-tabs').style.display='none';
        document.querySelector('.qr-section').style.display='flex';
        refreshDisplayFloatingBrand(true);
        updateZelleAccountDisplay();
        resetDisplayPanels();

        currentOrderRef = firebase.database().ref('currentOrder');
        currentOrderRef.on('value',(snapshot)=>{
          renderDisplayState(snapshot.val());
        });
        rotateQuotes();
      }
    }

    function resetDisplayPanels(){
      const container = document.getElementById('display-container');
      const left = document.getElementById('display-order-list');
      const right = document.getElementById('display-payment-panel');
      if(left) left.innerHTML='';
      if(right){
        right.innerHTML='';
        right.style.display='none';
      }
      if(container) container.style.display='none';
      const quoteEl = document.getElementById('quote-container');
      if(quoteEl) quoteEl.style.display='block';
      const nameBanner = document.getElementById('display-name-banner');
      if(nameBanner){
        nameBanner.classList.remove('active');
        nameBanner.textContent='';
      }
    }

    function buildBrandBadge(options={}){
      if(!BRAND.enabled) return null;
      const tag = BRAND.link ? 'a' : 'div';
      const badge = document.createElement(tag);
      badge.className = 'brand-badge brand-ghost';
      if(BRAND.link){
        badge.href = BRAND.link;
        badge.target = '_blank';
        badge.rel = 'noopener noreferrer';
      }else{
        badge.style.pointerEvents = 'none';
      }
      const img = document.createElement('img');
      img.src = options.logo || BRAND.logoSquare;
      img.alt = `${BRAND.name} logo`;
      badge.appendChild(img);
      const text = document.createElement('span');
      text.textContent = `Powered by ${BRAND.name}`;
      badge.appendChild(text);
      if(options.small) badge.style.fontSize = '11px';
      return badge;
    }

    function ensurePOSBrandBadge(){
      const topSection = document.querySelector('.top-section');
      if(!topSection){
        if(posBrandBadgeEl){ posBrandBadgeEl.remove(); posBrandBadgeEl=null; }
        return;
      }
      if(!BRAND.enabled){
        if(posBrandBadgeEl){ posBrandBadgeEl.remove(); posBrandBadgeEl=null; }
        return;
      }
      if(posBrandBadgeEl && posBrandBadgeEl.parentElement===topSection) return;
      if(posBrandBadgeEl) posBrandBadgeEl.remove();
      const badge = buildBrandBadge({ logo:BRAND.logoText });
      if(badge){
        badge.style.marginLeft = 'auto';
        posBrandBadgeEl = badge;
        topSection.appendChild(posBrandBadgeEl);
      }
    }

    function refreshDisplayFloatingBrand(isDisplay){
      if(!BRAND.enabled){
        if(displayBrandFloatingEl){ displayBrandFloatingEl.remove(); displayBrandFloatingEl=null; }
        return;
      }
      if(!displayBrandFloatingEl){
        const badge = buildBrandBadge({ logo:BRAND.logoSquare, small:true });
        if(badge){
          badge.classList.add('display-brand');
          displayBrandFloatingEl = badge;
          document.body.appendChild(displayBrandFloatingEl);
        }
      }
      if(displayBrandFloatingEl) displayBrandFloatingEl.style.display = isDisplay ? 'inline-flex' : 'none';
    }

    function renderDisplayState(data){
      const container = document.getElementById('display-container');
      const left = document.getElementById('display-order-list');
      const right = document.getElementById('display-payment-panel');
      const quoteEl = document.getElementById('quote-container');
      const displayNameBanner = document.getElementById('display-name-banner');
      if(!container || !left || !right) return;

      const formatMoney = (value)=>{
        const num = Number(value);
        return Number.isFinite(num) ? num.toFixed(2) : '0.00';
      };

      const items = Array.isArray(data && data.items) ? data.items : [];
      const totalValue = formatMoney(data && data.total);
      const subtotalValue = formatMoney((data && data.subtotal!==undefined) ? data.subtotal : (data && data.total));
      const rawFeeCents = Number(data && data.zelleFeeCents);
      const feeCents = Number.isFinite(rawFeeCents) ? rawFeeCents : 0;
      const feeValue = (feeCents/100).toFixed(2);
      const hasItems = items.length>0;
      const paymentMethod = data && data.paymentMethod;
      const feeEnabled = Boolean(data && data.zelleFeeEnabled);
      const shouldShowFee = paymentMethod==='Zelle' && feeEnabled;
      const showRight = paymentMethod==='Zelle' || paymentMethod==='Cash';
      const displayName = data && typeof data.name === 'string' ? data.name.trim() : '';
      const orderNumberValue = Number(data && data.orderNumber);
      const nextOrderNumberValue = Number(data && data.nextOrderNumber);
      const hasOrderNumber = Number.isFinite(orderNumberValue) && orderNumberValue > 0;
      const hasNextOrderNumber = Number.isFinite(nextOrderNumberValue) && nextOrderNumberValue > 0;
      const effectiveOrderNumber = hasOrderNumber ? orderNumberValue : (hasNextOrderNumber ? nextOrderNumberValue : null);
      const shouldShow = hasItems || showRight || Boolean(displayName);

      if(displayNameBanner){
        displayNameBanner.classList.remove('active');
        displayNameBanner.textContent='';
      }

      if(!shouldShow){
        container.style.display='none';
        left.innerHTML='';
        right.innerHTML='';
        right.style.display='none';
        if(quoteEl) quoteEl.style.display='block';
        return;
      }

      container.style.display='grid';
      if(quoteEl) quoteEl.style.display='none';

      if(displayNameBanner){
        if(displayName){
          displayNameBanner.textContent = displayName;
          displayNameBanner.classList.remove('active');
          void displayNameBanner.offsetWidth;
          displayNameBanner.classList.add('active');
        }else{
          displayNameBanner.classList.remove('active');
        }
      }

      left.innerHTML='';
      const header = document.createElement('div');
      header.className='display-order-header';
      header.textContent='Current Order';
      left.appendChild(header);

      if(effectiveOrderNumber){
        const orderNumberInline = document.createElement('div');
        orderNumberInline.className='display-order-number display-order-number-inline';
        orderNumberInline.textContent = `Order #${effectiveOrderNumber}`;
        left.appendChild(orderNumberInline);
      }

      if(hasItems){
        const list = document.createElement('div');
        list.className='display-order-items';
        items.forEach(item=>{
          const qty = Number(item.quantity) || 0;
          const price = Number(item.price) || 0;
          const row = document.createElement('div');
          row.className='display-order-row';

          const info = document.createElement('div');
          info.className='display-order-info';
          const name = document.createElement('div');
          name.className='display-order-name';
          name.textContent = item.name || '';
          const meta = document.createElement('div');
          meta.className='display-order-meta';
          meta.textContent = `${qty} × $${formatMoney(price)}`;
          info.appendChild(name);
          info.appendChild(meta);

          const lineTotal = document.createElement('div');
          lineTotal.className='display-order-line-total';
          lineTotal.textContent = `$${formatMoney(qty * price)}`;

          row.appendChild(info);
          row.appendChild(lineTotal);
          list.appendChild(row);
        });
        left.appendChild(list);

        const totalsContainer = document.createElement('div');
        totalsContainer.className='display-left-totals';
        if(shouldShowFee){
          const subtotalRow = document.createElement('div');
          subtotalRow.className='display-left-total-row subtotal';
          subtotalRow.innerHTML = `<span>Subtotal</span><span>$${subtotalValue}</span>`;
          totalsContainer.appendChild(subtotalRow);

          const feeRow = document.createElement('div');
          feeRow.className='display-left-total-row fee';
          feeRow.innerHTML = `<span>Processing fee</span><span>$${feeValue}</span>`;
          totalsContainer.appendChild(feeRow);
        }
        const totalRow = document.createElement('div');
        totalRow.className='display-left-total-row grand';
        const totalLabel = shouldShowFee ? 'Grand Total' : 'Total';
        const totalAmount = shouldShowFee ? totalValue : subtotalValue;
        totalRow.innerHTML = `<span>${totalLabel}</span><span>$${totalAmount}</span>`;
        totalsContainer.appendChild(totalRow);
        left.appendChild(totalsContainer);
      }else{
        const empty = document.createElement('div');
        empty.className='display-left-empty';
        empty.textContent = 'No items yet.';
        left.appendChild(empty);
      }

      if(showRight){
        right.style.display='flex';
        right.innerHTML='';
        if(paymentMethod==='Zelle'){
          const logo = document.createElement('img');
          logo.src = 'https://i.postimg.cc/v4407Z6z/Zelle-payment-service-Logo-wine-1.png';
          logo.alt = 'Zelle logo';
          logo.className='display-zelle-logo';
          right.appendChild(logo);

          if(effectiveOrderNumber){
            const orderNumberEl = document.createElement('div');
            orderNumberEl.className='display-order-number';
            orderNumberEl.textContent = `Order #${effectiveOrderNumber}`;
            right.appendChild(orderNumberEl);
          }

          const totalEl = document.createElement('div');
          totalEl.className='display-total';
          totalEl.textContent = `$${totalValue}`;
          right.appendChild(totalEl);

          const memo = document.createElement('div');
          memo.className='display-memo';
          memo.textContent = `Memo: ${hasOrderNumber ? orderNumberValue : '—'}`;
          right.appendChild(memo);

          const accountCode = (data && data.zelleAccount) || activeZelleAccount;
          const info = getZelleAccountInfo(accountCode) || {};
          const qrUrl = info.qr;
          if(qrUrl){
            const qr = document.createElement('img');
            qr.src = qrUrl;
            qr.alt = 'Zelle QR';
            qr.className='display-qr';
            right.appendChild(qr);
          }else{
            const missing = document.createElement('div');
            missing.className='qr-missing';
            missing.textContent = 'QR not set';
            right.appendChild(missing);
          }
          if(BRAND.enabled){
            const badge = buildBrandBadge({ logo:BRAND.logoSquare, small:true });
            if(badge) right.appendChild(badge);
          }
        }else if(paymentMethod==='Cash'){
          const logo = document.createElement('img');
          logo.src = 'https://assets.cdn.filesafe.space/slWdpqUTRhMfisMySSJ0/media/66f7050f5b684e16ab132d41.jpeg';
          logo.alt = 'Company Logo';
          logo.className='logo display-right-logo';
          right.appendChild(logo);

          if(effectiveOrderNumber){
            const orderNumberEl = document.createElement('div');
            orderNumberEl.className='display-order-number';
            orderNumberEl.textContent = `Order #${effectiveOrderNumber}`;
            right.appendChild(orderNumberEl);
          }

          const totalEl = document.createElement('div');
          totalEl.className='display-total';
          totalEl.textContent = `$${totalValue}`;
          right.appendChild(totalEl);
        }
      }else{
        right.innerHTML='';
        right.style.display='none';
      }
    }

    function rotateQuotes(){
      const qc = document.getElementById('quote-container');
      qc.innerText = quotes[currentQuoteIndex];
      quoteInterval = setInterval(()=>{
        currentQuoteIndex = (currentQuoteIndex+1) % quotes.length;
        qc.innerText = quotes[currentQuoteIndex];
      },10000);
    }

    function toggleFullscreen(){
      const qrSection = document.querySelector('.qr-section');
      if(!document.fullscreenElement){
        if(qrSection.requestFullscreen) qrSection.requestFullscreen();
        else if(qrSection.webkitRequestFullscreen) qrSection.webkitRequestFullscreen();
        else if(qrSection.msRequestFullscreen) qrSection.msRequestFullscreen();
      }else{
        if(document.exitFullscreen) document.exitFullscreen();
        else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
        else if(document.msExitFullscreen) document.msExitFullscreen();
      }
    }

    /* ==========================
       POS: Add/Remove + Tickets
       ========================== */
    function addItem(item){
      if(!item) return;
      const code = item.code || itemCodeMap[item.name];
      if(oosMap[code]) return; // blocked when out of stock
      const existing = orderList.find(i=>i.code===code);
      if(existing) existing.quantity += 1;
      else orderList.push({
        code,
        name:item.name,
        price:item.price,
        ticketColor:item.ticketColor || null,
        quantity:1
      });
      total = round2(total + item.price);
      updateOrderSummary();
      syncTicketCounters();
    }

    function removeItem(code){
      const idx = orderList.findIndex(i=>i.code===code);
      if(idx>-1){
        const it = orderList[idx];
        total = Math.max(0, round2(total - (it.price*it.quantity)));
        orderList.splice(idx,1);
        updateOrderSummary();
        syncTicketCounters();
      }
    }

    function updateOrderSummary(){
      const listEl = document.getElementById('order-list');
      const totalEl = document.getElementById('total-price-summary');
      listEl.innerHTML='';
      orderList.forEach(item=>{
        const row = document.createElement('div');
        row.className='order-item';
        row.innerHTML = `<span>${item.name} x ${item.quantity}</span>
                         <span>$${(item.price*item.quantity).toFixed(2)}</span>`;
        const del = document.createElement('button');
        del.className='delete-item';
        del.innerHTML='&times;';
        del.onclick=()=>removeItem(item.code);
        row.appendChild(del);
        listEl.appendChild(row);
      });
      totalEl.innerText = total.toFixed(2);
      syncCurrentOrderBroadcast();
      refreshOrderMetaUI();
    }

    function syncTicketCounters(){
      const counts = { Purple:0, Red:0, Green:0, Blue:0 };
      orderList.forEach(item=>{
        const qty = Number(item.quantity)||0;
        if(item.ticketColor && counts.hasOwnProperty(item.ticketColor)){
          counts[item.ticketColor] += qty;
        }
      });
      TICKET_COLOR_KEYS.forEach(color=>{
        const meta = TICKET_COLOR_META[color];
        const el = document.getElementById(meta.elementId);
        if(el) el.innerText = counts[color] || 0;
      });
    }

    function getNextOrderNumber(){
      const base = Number(orderNumber);
      return Number.isFinite(base) ? base + 1 : 1;
    }

    function updateCurrentOrderHeading(){
      const heading = document.getElementById('current-order-heading');
      if(heading){
        heading.textContent = currentCustomerName ? `${currentCustomerName} — Order` : 'Current Order';
      }
    }

    function refreshOrderMetaUI(){
      updateCurrentOrderHeading();
      const numberEl = document.getElementById('current-order-number');
      if(numberEl){
        numberEl.textContent = getNextOrderNumber();
      }
    }

    function buildCurrentOrderItemsSnapshot(){
      return orderList.map(item=>({
        code:item.code,
        name:item.name,
        price:item.price,
        ticketColor:item.ticketColor || null,
        quantity:item.quantity
      }));
    }

    function syncCurrentOrderBroadcast(){
      if(!db) return;
      const subtotalString = round2(total).toFixed(2);
      const payload = {
        items: buildCurrentOrderItemsSnapshot(),
        total: subtotalString,
        subtotal: subtotalString,
        nextOrderNumber: getNextOrderNumber(),
        orderNumber: null,
        paymentMethod: null,
        zelleAccount: null
      };
      const feeSnapshot = getZelleFeeSnapshot();
      payload.zelleFeeEnabled = feeSnapshot.enabled;
      payload.zelleFeeCents = feeSnapshot.enabled ? feeSnapshot.amountCents : 0;
      payload.name = currentCustomerName ? currentCustomerName : null;
      db.ref('currentOrder').update(payload);
    }

    function displayCurrentNamePath(){ return `display/${SEASON}/${DAY}/current/name`; }

    function applyCustomerName(name, options={}){
      const normalized = typeof name === 'string' ? name.trim() : '';
      currentCustomerName = normalized;
      updateCurrentOrderHeading();
      if(!options.skipBroadcast){
        syncCurrentOrderBroadcast();
      }
      if(options.skipRemote) return;
      const ref = db.ref(displayCurrentNamePath());
      if(normalized){
        ref.set(normalized);
      }else{
        ref.remove();
      }
    }

    function openCustomerNameModal(){
      if(!customerNameModalEl){ customerNameModalEl = document.getElementById('customer-name-modal'); }
      const modal = customerNameModalEl;
      if(!modal) return;
      lastFocusBeforeNameModal = document.activeElement;
      modal.style.display='block';
      const input = document.getElementById('customer-name-input');
      if(input){
        input.value = currentCustomerName;
        setTimeout(()=>input.focus(),0);
      }
      modal.addEventListener('keydown', handleCustomerNameModalKeydown);
    }

    function closeCustomerNameModal(){
      if(!customerNameModalEl){ customerNameModalEl = document.getElementById('customer-name-modal'); }
      const modal = customerNameModalEl;
      if(!modal) return;
      modal.style.display='none';
      modal.removeEventListener('keydown', handleCustomerNameModalKeydown);
      const input = document.getElementById('customer-name-input');
      if(input) input.blur();
      if(lastFocusBeforeNameModal && typeof lastFocusBeforeNameModal.focus === 'function'){
        lastFocusBeforeNameModal.focus();
      }
      lastFocusBeforeNameModal = null;
    }

    function handleCustomerNameModalKeydown(event){
      if(event.key === 'Escape'){
        event.preventDefault();
        closeCustomerNameModal();
      }else if(event.key === 'Enter'){
        event.preventDefault();
        saveCustomerName();
      }
    }

    function saveCustomerName(){
      const input = document.getElementById('customer-name-input');
      if(!input) return;
      applyCustomerName(input.value);
      closeCustomerNameModal();
    }

    function skipCustomerName(){
      closeCustomerNameModal();
    }

    function refreshDisplayNameListener(){
      if(displayNameRef){ displayNameRef.off(); }
      displayNameRef = db.ref(displayCurrentNamePath());
      displayNameRef.on('value', snapshot=>{
        const remoteName = snapshot.val();
        applyCustomerName(remoteName || '', { skipRemote:true });
      });
    }

    /* ==========================
       Payment Flow (Cash / Zelle)
       ========================== */
    function processPayment(method){
      if(orderList.length===0){ alert('Add at least one item.'); return; }

      if(method==='Zelle' && !activeZelleAccount){
        alert('Select a Zelle account before recording a Zelle payment.');
        return;
      }

      orderNumber = Number(orderNumber)+1; // keep original per-day sequence
      const orderItemsSnapshot = buildCurrentOrderItemsSnapshot();
      const feeSnapshot = getZelleFeeSnapshot();
      const subtotalValueNumber = round2(total);
      const baseTotalCents = Math.max(0, Math.round(subtotalValueNumber * 100));
      const shouldApplyFee = method==='Zelle' && feeSnapshot.enabled;
      const appliedFeeCents = shouldApplyFee ? feeSnapshot.amountCents : 0;
      const finalTotalCents = baseTotalCents + appliedFeeCents;
      const finalTotalValue = (finalTotalCents/100).toFixed(2);
      const subtotalString = subtotalValueNumber.toFixed(2);

      const orderDetails = {
        orderNumber,
        items: orderItemsSnapshot,
        total: finalTotalValue,
        method,
        passFee: false, // columns remain in Order Log; always false here
        fee: '0.00',    // not used for Zelle/Cash; keeps CSV shape intact
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        overwritten: isTotalOverwritten,
        day: DAY
      };
      orderDetails.name = currentCustomerName || null;
      orderDetails.subtotal = subtotalString;
      orderDetails.zelleFeeEnabled = shouldApplyFee;
      orderDetails.zelleFeeCents = appliedFeeCents;
      if(method==='Zelle'){
        orderDetails.zelleStatus = 'PENDING';
        orderDetails.zelleAccount = activeZelleAccount;
      }
      saveOrderToFirebase(orderDetails);

      // Update Display device
      const currentOrderPayload = {
        items: orderItemsSnapshot,
        total: finalTotalValue,
        subtotal: subtotalString,
        paymentMethod: method,
        orderNumber,
        nextOrderNumber: getNextOrderNumber(),
        name: currentCustomerName || null,
        zelleFeeEnabled: shouldApplyFee,
        zelleFeeCents: appliedFeeCents
      };
      if(method==='Zelle') currentOrderPayload.zelleAccount = activeZelleAccount;
      db.ref('currentOrder').set(currentOrderPayload);

      // Operator still presses "Next Customer" when ready (manual step kept)
      refreshOrderMetaUI();
    }

    /* ==========================
       Edit Total
       ========================== */
    function openEditTotalModal(){
      document.getElementById('new-total-price').value = total.toFixed(2);
      document.getElementById('edit-total-modal').style.display='block';
    }
    function closeEditTotalModal(){ document.getElementById('edit-total-modal').style.display='none'; }
    function updateTotalPrice(){
      const newTotal = parseFloat(document.getElementById('new-total-price').value);
      if(!isNaN(newTotal) && newTotal>=0){
        total = round2(newTotal);
        updateOrderSummary();
        isTotalOverwritten = true;
        closeEditTotalModal();
      }else{
        alert('Please enter a valid amount.');
      }
    }

    /* ==========================
       Save / Load Orders
       ========================== */
    function ordersPath(){ return `orders/${SEASON}/${DAY}`; }

    function saveOrderToFirebase(orderDetails){
      const ref = db.ref(ordersPath()).push();
      ref.set(orderDetails);
    }

    function deleteOrder(orderKey){
      if(!orderKey) return;
      if(confirm('Are you sure you want to delete this order?')){
        const ref = db.ref(`${ordersPath()}/${orderKey}`);
        ref.remove().then(()=>{
          delete orderHistory[orderKey];
          const row = document.querySelector(`#order-log tr[data-order-key="${orderKey}"]`);
          if(row && row.parentNode){ row.parentNode.removeChild(row); }
          const remainingNumbers = Object.values(orderHistory)
            .map(o=>Number(o.orderNumber))
            .filter(n=>!isNaN(n));
          orderNumber = remainingNumbers.length ? Math.max(...remainingNumbers) : 0;
          refreshOrderMetaUI();
        }).catch(err=>{
          console.error('Error deleting order:', err);
          alert('An error occurred while deleting the order.');
        });
      }
    }

    function loadOrdersFromFirebase(){
      if(ordersRef) ordersRef.off();
      ordersRef = db.ref(ordersPath());
      ordersRef.on('value',(snapshot)=>{
        const orders = snapshot.val();
        orderHistory = {};
        const tbody = document.getElementById('order-log');
        tbody.innerHTML = '';
        if(orders){
          // Build dynamic item columns header (only once)
          buildDynamicHeader();

          Object.keys(orders).forEach(key=>{
            const order = orders[key];
            logOrder(key, order);
          });
          const numbers = Object.values(orders).map(o=>Number(o.orderNumber)).filter(n=>!isNaN(n));
          orderNumber = numbers.length>0 ? Math.max(...numbers) : 0;
        }else{
          orderNumber = 0;
        }
        refreshOrderMetaUI();
      });
    }

    function buildDynamicHeader(){
      // Rebuild the header cells for item codes based on current menu
      const theadRow = document.querySelector('#order-tracking thead tr');
      const codes = currentMenu().map(i=>i.code);
      theadRow.innerHTML = `
        <th>Order #</th>
        <th>Time</th>
        <th>Name</th>
        ${codes.map(c=>`<th>${c}</th>`).join('')}
        <th>Total</th>
        <th>Payment Method</th>
        <th>Pass Fee</th>
        <th>Fee</th>
        <th>Delete</th>
      `;
    }

    function logOrder(orderKey, order){
      const tbody = document.getElementById('order-log');
      const tr = document.createElement('tr');
      tr.setAttribute('data-order-key', orderKey);

      if(order.overwritten){ tr.classList.add('order-overwritten'); }

      const timeString = new Date(order.timestamp || Date.now()).toLocaleTimeString();

      const itemQuantities = {};
      currentMenu().forEach(i => itemQuantities[i.code] = '');

      if(order.items){
        order.items.forEach(it=>{
          const code = it.code || itemCodeMap[it.name];
          if(code) itemQuantities[code] = it.quantity;
        });
      }

      const codes = currentMenu().map(i=>i.code);
      const displayName = escapeHTML(order && order.name ? order.name : '');
      tr.innerHTML = `
        <td>${order.orderNumber ?? ''}</td>
        <td>${timeString}</td>
        <td>${displayName}</td>
        ${codes.map(c=>`<td>${itemQuantities[c] ?? ''}</td>`).join('')}
        <td>$${(order.total ?? '0.00')}</td>
        <td>${order.method ?? ''}</td>
        <td>${order.passFee ? 'Yes' : 'No'}</td>
        <td>${order.fee ? ('$'+order.fee) : ''}</td>
        <td><button class="delete-order-button" onclick="deleteOrder('${orderKey}')">&times;</button></td>
      `;
      tbody.appendChild(tr);
      orderHistory[orderKey] = order;
    }

    function downloadCSV(){
      let csv = "data:text/csv;charset=utf-8,";
      const codes = currentMenu().map(i=>i.code);
      csv += "Order #,Time,Name," + codes.join(',') + ",Total,Payment Method,Pass Fee,Fee,Overwritten\n";
      Object.values(orderHistory).forEach(o=>{
        const timeString = new Date(o.timestamp || Date.now()).toLocaleString();
        const qty = {};
        currentMenu().forEach(i=>qty[i.code]='');
        if(o.items){ o.items.forEach(it=>{ const c = it.code || itemCodeMap[it.name]; if(c) qty[c]=it.quantity; }); }
        const nameValue = o.name ? String(o.name).replace(/"/g,'""') : '';

        const row = [
          o.orderNumber ?? '',
          `"${timeString}"`,
          `"${nameValue}"`,
          ...codes.map(c=>qty[c] ?? ''),
          o.total ?? '',
          o.method ?? '',
          o.passFee ? 'Yes' : 'No',
          o.fee ?? '',
          o.overwritten ? 'Yes' : 'No'
        ];
        csv += row.join(',') + "\n";
      });
      const link = document.createElement('a');
      link.setAttribute('href', encodeURI(csv));
      link.setAttribute('download', `order_log_${SEASON}_${DAY}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function clearAllOrders(){
      if(confirm('Are you sure you want to clear all orders for this day? This cannot be undone.')){
        db.ref(ordersPath()).remove().then(()=>{
          alert('All orders have been cleared for ' + DAY + '.');
          orderHistory = {};
          orderNumber = 0;
          document.getElementById('order-log').innerHTML='';
          refreshOrderMetaUI();
        }).catch(err=>{
          console.error('Error clearing orders:', err);
          alert('An error occurred while clearing orders.');
        });
      }
    }

    /* ==========================
       Zelle Confirmations (per-day)
       ========================== */
    function zellePathDay(){ return `orders/${SEASON}/${DAY}`; } // orders carry zelleStatus
    function zelleControlPath(){ return `zelle/${SEASON}/${DAY}`; }
    function zelleConfigPath(){ return `zelle/${SEASON}/config/accounts`; }
    function zelleCurrentAccountPath(){ return `${zelleControlPath()}/currentAccount`; }
    function zelleFeeConfigPath(){ return `${zelleControlPath()}/config/fee`; }

    function defaultZelleFeeConfig(){ return { enabled:false, amountCents:0 }; }

    function sanitizeZelleFeeConfig(raw){
      const base = defaultZelleFeeConfig();
      if(raw && typeof raw === 'object'){
        base.enabled = Boolean(raw.enabled);
        const amt = Number(raw.amountCents);
        if(Number.isFinite(amt) && amt>=0){
          const normalized = Math.round(amt);
          base.amountCents = Math.min(2000, Math.max(0, normalized));
        }
      }
      return base;
    }

    function applyZelleFeeConfig(raw){
      zelleFeeConfig = sanitizeZelleFeeConfig(raw);
      updateZelleFeeForm(zelleFeeConfig);
    }

    function getZelleFeeSnapshot(){
      return sanitizeZelleFeeConfig(zelleFeeConfig);
    }

    function updateZelleFeeForm(config){
      const toggle = document.getElementById('zelle-fee-toggle');
      const amount = document.getElementById('zelle-fee-amount');
      if(toggle) toggle.checked = Boolean(config && config.enabled);
      if(amount){
        const dollars = Number(config && config.amountCents ? config.amountCents : 0)/100;
        amount.value = dollars.toFixed(2);
      }
      handleZelleFeeToggleChange();
    }

    function handleZelleFeeToggleChange(){
      const toggle = document.getElementById('zelle-fee-toggle');
      const amount = document.getElementById('zelle-fee-amount');
      if(!toggle || !amount) return;
      amount.disabled = !toggle.checked;
    }

    function refreshZelleFeeListener(){
      if(!db) return;
      if(zelleFeeRef) zelleFeeRef.off();
      zelleFeeRef = db.ref(zelleFeeConfigPath());
      applyZelleFeeConfig(null);
      zelleFeeRef.on('value', snapshot=>{
        applyZelleFeeConfig(snapshot.val());
      }, error=>{
        console.error('Unable to load Zelle fee config', error);
        applyZelleFeeConfig(null);
        showPriceToast("Couldn't load Zelle fee; using $0.00");
      });
    }

    function saveZelleFeeSettings(){
      const toggle = document.getElementById('zelle-fee-toggle');
      const amountInput = document.getElementById('zelle-fee-amount');
      if(!toggle || !amountInput) return;
      const enabled = Boolean(toggle.checked);
      let amountValue = parseFloat(amountInput.value);
      if(isNaN(amountValue)) amountValue = 0;
      amountValue = Math.max(0, Math.min(20, amountValue));
      let amountCents = Math.round(amountValue * 100);
      amountCents = Math.max(0, Math.min(2000, amountCents));
      amountValue = amountCents/100;
      amountInput.value = amountValue.toFixed(2);
      const payload = { enabled, amountCents };
      db.ref(zelleFeeConfigPath()).set(payload)
        .then(()=>{
          zelleFeeConfig = sanitizeZelleFeeConfig(payload);
          showPriceToast('Zelle fee saved.');
        })
        .catch(err=>{
          console.error('Unable to save Zelle fee', err);
          const message = err && err.message ? err.message : 'Please try again.';
          alert('Unable to save Zelle fee: ' + message);
        });
    }
    function zelleSwitchLogPath(){ return `${zelleControlPath()}/switchLog`; }

    const ZELLE_ACCOUNT_CODES = ['AR','SKD','SC','PD'];
    const ZELLE_ACCOUNT_PLACEHOLDERS = {
      AR:{qr:'https://i.postimg.cc/3WyQRYtg/ar-test.jpg', label:'AR'},
      PD:{qr:'https://i.postimg.cc/c6Vyt2zP/pd-test.jpg', label:'PD'},
      SC:{qr:'https://i.postimg.cc/jLPVHv02/sc-test.jpg', label:'SC'},
      SKD:{qr:'https://i.postimg.cc/18QkJ6sH/skd-test.jpg', label:'SKD'}
    };
    const DEFAULT_ZELLE_ACCOUNT = 'AR';

    function firstAvailableZelleAccount(){
      return ZELLE_ACCOUNT_CODES.find(code=>getZelleAccountInfo(code)) || null;
    }

    function getZelleAccountInfo(account){
      if(!account) return null;
      const infoFromConfig = (zelleAccountConfig && zelleAccountConfig[account]) ? zelleAccountConfig[account] : null;
      return infoFromConfig || ZELLE_ACCOUNT_PLACEHOLDERS[account] || null;
    }

    function renderZelleAccountButtons(){
      const container = document.getElementById('zelle-account-buttons');
      if(!container) return;
      container.innerHTML = '';
      ZELLE_ACCOUNT_CODES.forEach(account=>{
        const btn = document.createElement('button');
        btn.type='button';
        btn.className='zelle-account-button';
        btn.setAttribute('data-zelle-account-button', account);
        btn.onclick = ()=>changeZelleAccount(account);
        container.appendChild(btn);
      });
      updateZelleAccountDisplay();
    }

    function updateZelleAccountDisplay(){
      const labelEl = document.getElementById('current-zelle-account');
      if(labelEl) labelEl.innerText = activeZelleAccount || '—';
      const detailEl = document.getElementById('current-zelle-account-detail');
      if(detailEl){
        const info = getZelleAccountInfo(activeZelleAccount) || {};
        const parts = [];
        if(info.label && info.label!==activeZelleAccount) parts.push(info.label);
        if(info.handle) parts.push(info.handle);
        if(parts.length){
          detailEl.innerText = parts.join(' • ');
          detailEl.style.display='inline';
        }else{
          detailEl.innerText='';
          detailEl.style.display='none';
        }
      }
      updateZelleAccountButtonsState();
      updateZelleAccountTotalsDisplay();
    }

    function updateZelleAccountButtonsState(){
      document.querySelectorAll('[data-zelle-account-button]').forEach(btn=>{
        const acct = btn.getAttribute('data-zelle-account-button');
        const info = getZelleAccountInfo(acct) || {};
        const isActive = acct===activeZelleAccount;
        const labelText = info.label && info.label!==acct ? info.label : '';
        const actionText = isActive ? 'Current' : 'Change';
        btn.innerHTML = `
          <span class="account-code">${acct}</span>
          ${labelText ? `<span class="account-label">${labelText}</span>` : ''}
          <span class="account-action">${actionText}</span>
        `;
        btn.classList.toggle('active', isActive);
        btn.disabled = isActive;
      });
    }

    function updateZelleAccountTotalsDisplay(totals){
      if(totals) latestZelleAccountTotals = totals;
      const source = latestZelleAccountTotals || {};
      const container = document.getElementById('zelle-account-totals');
      if(!container) return;
      container.innerHTML='';
      ZELLE_ACCOUNT_CODES.forEach(account=>{
        const info = getZelleAccountInfo(account) || {};
        const totalsForAccount = source[account] || { count:0, sum:0 };
        const count = totalsForAccount.count || 0;
        const sumRounded = round2(Number(totalsForAccount.sum || 0));
        const label = info.label && info.label!==account ? `${account} — ${info.label}` : account;
        const card = document.createElement('div');
        card.className = 'account-total-card' + (account===activeZelleAccount ? ' active' : '');
        card.innerHTML = `
          <strong>${label}</strong>
          <span>${count} order${count===1?'':'s'}</span>
          <span>$${sumRounded.toFixed(2)}</span>
        `;
        container.appendChild(card);
      });
    }

    function ensureZelleConfigSeeded(){
      db.ref(zelleConfigPath()).once('value').then(snap=>{
        if(!snap.exists()){
          db.ref(zelleConfigPath()).set(ZELLE_ACCOUNT_PLACEHOLDERS).catch(err=>{
            console.error('Error seeding Zelle config', err);
          });
        }
      }).catch(err=>{
        console.error('Error checking Zelle config', err);
      });
    }

    function persistZelleAccount(nextAccount, shouldLog){
      if(!nextAccount) return;
      const prev = activeZelleAccount;
      activeZelleAccount = nextAccount;
      updateZelleAccountDisplay();
      db.ref(zelleCurrentAccountPath()).set(nextAccount);
      if(shouldLog){
        db.ref(zelleSwitchLogPath()).push({
          from: prev || null,
          to: nextAccount,
          ts: firebase.database.ServerValue.TIMESTAMP
        });
      }
    }

    function changeZelleAccount(nextAccount){
      if(!nextAccount || nextAccount===activeZelleAccount) return;
      persistZelleAccount(nextAccount, true);
    }

    function loadZelleConfig(){
      if(zelleConfigRef) zelleConfigRef.off();
      zelleConfigRef = db.ref(zelleConfigPath());
      zelleConfigRef.on('value',(snap)=>{
        zelleAccountConfig = snap.val() || {};
        renderZelleAccountButtons();
        const fallback = firstAvailableZelleAccount() || DEFAULT_ZELLE_ACCOUNT;
        if(!activeZelleAccount && fallback){
          persistZelleAccount(fallback, false);
        }else{
          updateZelleAccountDisplay();
        }
      });
    }

    function refreshZelleCurrentAccountListener(){
      if(zelleCurrentAccountRef) zelleCurrentAccountRef.off();
      zelleCurrentAccountRef = db.ref(zelleCurrentAccountPath());
      zelleCurrentAccountRef.on('value',(snap)=>{
        const value = snap.val();
        if(value){
          activeZelleAccount = value;
          updateZelleAccountDisplay();
        }else{
          const fallback = firstAvailableZelleAccount() || DEFAULT_ZELLE_ACCOUNT;
          if(fallback) persistZelleAccount(fallback, false);
          else {
            activeZelleAccount = null;
            updateZelleAccountDisplay();
          }
        }
      });
    }

    let zelleRef = null;
    let zelleSwitchLogRef = null;

    function attachZelleListener(){
      if(zelleRef) zelleRef.off();
      const tbody = document.getElementById('zelle-body');
      tbody.innerHTML = '';

      zelleRef = db.ref(zellePathDay());
      zelleRef.on('value', (snap)=>{
        const orders = snap.val() || {};
        const zelleOrders = Object.entries(orders)
          .map(([key, o])=>({key, ...o}))
          .filter(o=>o.method==='Zelle');

        tbody.innerHTML='';
        if(zelleOrders.length===0){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="6" style="text-align:center;color:#666;">No Zelle orders yet.</td>`;
          tbody.appendChild(tr);
          updateZelleAccountTotalsDisplay({});
          return;
        }

        zelleOrders.sort((a,b)=>(a.orderNumber||0)-(b.orderNumber||0));

        const totals = {};
        ZELLE_ACCOUNT_CODES.forEach(code=>{ totals[code] = { count:0, sum:0 }; });

        zelleOrders.forEach(o=>{
          const tr = document.createElement('tr');
          const timeString = new Date(o.timestamp || Date.now()).toLocaleString();
          const status = o.zelleStatus || 'PENDING';
          const normalizedAccount = ZELLE_ACCOUNT_CODES.includes(o.zelleAccount) ? o.zelleAccount : null;
          if(normalizedAccount){
            totals[normalizedAccount].count += 1;
            totals[normalizedAccount].sum += Number(o.total || 0);
          }
          const accountDisplay = normalizedAccount || (o.zelleAccount || '—');
          tr.innerHTML = `
            <td>${timeString}</td>
            <td>${o.orderNumber || ''}</td>
            <td>$${(o.total||'0.00')}</td>
            <td>${accountDisplay}</td>
            <td>${status}</td>
            <td>
              <button class="btn-small btn-ok" onclick="markZelleStatus('${o.key}','CONFIRMED')">Confirm</button>
              <button class="btn-small btn-warn" onclick="markZelleStatus('${o.key}','MISSING')">Missing</button>
              <button class="btn-small btn-muted" onclick="markZelleStatus('${o.key}','PENDING')">Reset</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        updateZelleAccountTotalsDisplay(totals);
      });
    }

    function attachZelleSwitchLogListener(){
      if(zelleSwitchLogRef) zelleSwitchLogRef.off();
      const listEl = document.getElementById('zelle-switch-log');
      const clearBtn = document.getElementById('switch-log-clear-button');
      if(clearBtn) clearBtn.style.display='none';
      if(listEl) listEl.innerHTML = '<div class="switch-log-empty">No switches yet.</div>';
      if(!listEl) return;
      zelleSwitchLogRef = db.ref(zelleSwitchLogPath());
      zelleSwitchLogRef.on('value',(snap)=>{
        const list = document.getElementById('zelle-switch-log');
        const clear = document.getElementById('switch-log-clear-button');
        if(!list) return;
        const value = snap.val() || {};
        const entries = Object.keys(value).map(key=>({ key, ...(value[key]||{}) }));
        entries.sort((a,b)=>(b.ts||0)-(a.ts||0));
        list.innerHTML='';
        if(entries.length===0){
          list.innerHTML = '<div class="switch-log-empty">No switches yet.</div>';
          if(clear) clear.style.display='none';
          return;
        }
        if(clear) clear.style.display='inline-flex';
        entries.forEach(entry=>{
          const row = document.createElement('div');
          row.className = 'switch-log-row';
          const timeSpan = document.createElement('span');
          timeSpan.className = 'switch-log-time';
          timeSpan.textContent = entry.ts ? new Date(entry.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
          const arrowSpan = document.createElement('span');
          arrowSpan.className = 'switch-log-arrow';
          const from = entry.from || '—';
          const to = entry.to || '—';
          arrowSpan.textContent = `${from} → ${to}`;
          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.className = 'switch-log-delete';
          delBtn.textContent = '×';
          delBtn.addEventListener('click',(evt)=>{
            evt.stopPropagation();
            deleteZelleSwitchLogEntry(entry.key);
          });
          row.appendChild(timeSpan);
          row.appendChild(arrowSpan);
          row.appendChild(delBtn);
          list.appendChild(row);
        });
      });
    }

    function deleteZelleSwitchLogEntry(id){
      if(!id) return;
      db.ref(`${zelleSwitchLogPath()}/${id}`).remove().catch(err=>{
        console.error('Error deleting switch log entry', err);
        alert('Unable to delete log entry: ' + err.message);
      });
    }

    function clearZelleSwitchLog(){
      if(!confirm('Clear the entire switch log for this day?')) return;
      db.ref(zelleSwitchLogPath()).remove().catch(err=>{
        console.error('Error clearing switch log', err);
        alert('Unable to clear switch log: ' + err.message);
      });
    }

    function markZelleStatus(orderKey, status){
      db.ref(`${zellePathDay()}/${orderKey}`).update({ zelleStatus: status, zelleCheckedTs: firebase.database.ServerValue.TIMESTAMP });
    }

    function downloadZelleCSV(){
      db.ref(zellePathDay()).once('value').then(snap=>{
        const orders = snap.val() || {};
        const rows = Object.values(orders).filter(o=>o.method==='Zelle');
        let csv = "data:text/csv;charset=utf-8,Time,Order #,Total,Account,Status\n";
        rows.forEach(o=>{
          const t = new Date(o.timestamp || Date.now()).toLocaleString();
          const account = ZELLE_ACCOUNT_CODES.includes(o.zelleAccount) ? o.zelleAccount : (o.zelleAccount || '');
          csv += `"${t}",${o.orderNumber||''},${o.total||''},${account},${(o.zelleStatus||'PENDING')}\n`;
        });
        const link = document.createElement('a');
        link.setAttribute('href', encodeURI(csv));
        link.setAttribute('download', `zelle_${SEASON}_${DAY}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    }

    /* ==========================
       Out-of-Stock tracking + Stock Log helpers (fixed)
       ========================== */
    function stockPath(code){ return `stock/${SEASON}/${DAY}/${code}`; }
    function stockPathDay(){ return `stock/${SEASON}/${DAY}`; }

    // Keep a live listener for the Stock Log so the table stays in sync.
    // We also clean it up when switching days/tabs.
    let stockListenerRef = null;

    function toggleOOS(item){
      const code = item.code;
      const newVal = !oosMap[code];
      oosMap[code] = newVal;

      const ref = db.ref(stockPath(code)).push();
      ref.set({
        status: newVal ? 'OOS' : 'RESTOCKED',
        code,
        itemName: item.name,
        ts: firebase.database.ServerValue.TIMESTAMP
      });

      // Refresh the POS buttons immediately
      initializeMenuItems();
    }

    function loadOOSMap(){
      const path = stockPathDay();
      db.ref(path).once('value',(snap)=>{
        const node = snap.val() || {};
        currentMenu().forEach(item=>{ oosMap[item.code] = false; });
        Object.keys(node).forEach(code=>{
          const arr = Object.values(node[code]||{});
          if(arr.length){
            arr.sort((a,b)=>(a.ts||0)-(b.ts||0));
            const last = arr[arr.length-1];
            oosMap[code] = !!(last && last.status === 'OOS');
          } else {
            oosMap[code] = false;
          }
        });
        initializeMenuItems();
      });
    }

    /* ==========================
       Stock Log view (per-day, live)
       ========================== */
    function mapCodeToName(){
      const m = {};
      currentMenu().forEach(i=>{ m[i.code] = i.name; });
      return m;
    }

    function attachStockLogListener(){
      // Detach any previous listener (e.g., when switching days)
      if(stockListenerRef){ stockListenerRef.off(); stockListenerRef = null; }

      const tbody = document.getElementById('stock-log-body');
      if(!tbody) return;

      stockListenerRef = db.ref(stockPathDay());
      stockListenerRef.on('value', (snap)=>{
        const byCode = snap.val() || {};
        const rows = [];

        Object.keys(byCode).forEach(code=>{
          const entries = byCode[code] || {};
          Object.keys(entries).forEach(key=>{
            const e = entries[key] || {};
            rows.push({
              code: e.code || code,
              key,
              status: e.status || '',
              ts: e.ts || 0,
              itemName: e.itemName || e.item || ''
            });
          });
        });

        // Render
        tbody.innerHTML = '';
        if(rows.length === 0){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="5" style="text-align:center;color:#666;">No stock activity yet.</td>`;
          tbody.appendChild(tr);
          return;
        }

        rows.sort((a,b)=>(b.ts||0)-(a.ts||0));
        const codeNameMap = mapCodeToName();

        rows.forEach(row=>{
          const tr = document.createElement('tr');
          const timeString = row.ts ? new Date(row.ts).toLocaleString() : '';
          tr.innerHTML = `
            <td>${timeString}</td>
            <td>${row.code}</td>
            <td>${row.itemName || codeNameMap[row.code] || ''}</td>
            <td>${row.status}</td>
            <td><button class="delete-order-button" onclick="deleteStockEvent('${row.code}','${row.key}')">&times;</button></td>
          `;
          tbody.appendChild(tr);
        });
      });
    }

    // Keep the old name for compatibility with switchTab()
    function loadStockLogFromFirebase(){
      attachStockLogListener();
    }

    function deleteStockEvent(code, key){
      if(!confirm('Delete this stock entry? This may change the current OOS/RESTOCKED state if it was the latest entry.')) return;
      db.ref(`${stockPathDay()}/${code}/${key}`).remove().then(()=>{
        // No manual refresh needed; live listener will redraw.
        loadOOSMap();
      }).catch(err=>{
        console.error('Error deleting stock entry:', err);
        alert('An error occurred while deleting this entry.');
      });
    }

    function downloadStockCSV(){
      db.ref(stockPathDay()).once('value',(snap)=>{
        const byCode = snap.val() || {};
        const codeNameMap = mapCodeToName();
        const rows = [];

        Object.keys(byCode).forEach(code=>{
          const entries = byCode[code] || {};
          Object.keys(entries).forEach(key=>{
            const e = entries[key] || {};
            rows.push([
              new Date(e.ts||Date.now()).toLocaleString(),
              e.code || code,
              e.itemName || e.item || codeNameMap[e.code || code] || '',
              e.status || ''
            ]);
          });
        });

        rows.sort((a,b)=> new Date(b[0]) - new Date(a[0]) );

        let csv = "data:text/csv;charset=utf-8,Time,Code,Item,Status\n";
        rows.forEach(r=>{
          csv += r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',') + "\n";
        });

        const link = document.createElement('a');
        link.setAttribute('href', encodeURI(csv));
        link.setAttribute('download', `stock_log_${SEASON}_${DAY}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    }

    function clearAllStockLog(){
      if(!confirm('Clear the entire stock log for this day? This cannot be undone.')) return;
      db.ref(stockPathDay()).remove().then(()=>{
        alert('Stock log cleared for ' + DAY + '.');
        // Live listener will show the empty state automatically
        loadOOSMap();
      }).catch(err=>{
        console.error('Error clearing stock log:', err);
        alert('An error occurred while clearing the stock log.');
      });
    }

    /* ==========================
       POS UI helpers
       ========================== */
    function searchItems(){
      const q = (document.getElementById('search-input').value||'').toLowerCase();
      document.querySelectorAll('.item-box').forEach(box=>{
        const name = box.querySelector('strong').innerText.toLowerCase();
        box.style.display = name.includes(q) ? 'flex' : 'none';
      });
    }

    function initializeMenuItems(){
      rebuildItemCodeMap();
      const grid = document.getElementById('item-grid');
      grid.innerHTML = '';
      currentMenu().forEach(item=>{
        const effectivePrice = getEffectivePriceFor(item);
        const effectiveTicketColorLabel = getEffectiveTicketColorLabel(item);
        const card = document.createElement('div');
        card.className='item-box';
        if(oosMap[item.code]) card.classList.add('is-oos');
        card.onclick = ()=>{
          if(!oosMap[item.code]){
            addItem(Object.assign({}, item, {
              price: effectivePrice,
              ticketColor: effectiveTicketColorLabel
            }));
          }
        };

        card.innerHTML = `
          <strong>${item.name} ${oosMap[item.code] ? '<span class="oos-tag">OOS</span>' : ''}</strong>
          <span class="price">$${effectivePrice.toFixed(2)}</span>
          <img src="${item.image}" alt="${item.name}">
        `;
        const actions = document.createElement('div');
        actions.className='item-actions';
        const editBtn = document.createElement('button');
        editBtn.type='button';
        editBtn.className='edit-price-btn';
        editBtn.innerHTML='✏️ Edit';
        editBtn.setAttribute('aria-label', `Edit price for ${item.name}`);
        editBtn.onclick = (e)=>{ e.stopPropagation(); openEditPriceModal(item); };
        actions.appendChild(editBtn);
        const oosBtn = document.createElement('button');
        oosBtn.className='oos-btn';
        oosBtn.textContent = oosMap[item.code] ? 'RESTOCK' : 'OOS';
        oosBtn.onclick = (e)=>{ e.stopPropagation(); toggleOOS(item); };
        actions.appendChild(oosBtn);
        card.appendChild(actions);
        grid.appendChild(card);
      });
    }

    function getPriceModalFocusableElements(){
      const modal = document.getElementById('edit-price-modal');
      if(!modal) return [];
      return Array.from(modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))
        .filter(el=>!el.hasAttribute('disabled') && el.offsetParent !== null);
    }

    function handleEditPriceModalKeydown(event){
      if(event.key === 'Escape'){
        event.preventDefault();
        closeEditPriceModal();
        return;
      }
      if(event.key === 'Tab'){
        const focusable = getPriceModalFocusableElements();
        if(focusable.length===0) return;
        const first = focusable[0];
        const last = focusable[focusable.length-1];
        if(event.shiftKey){
          if(document.activeElement === first){
            event.preventDefault();
            last.focus();
          }
        }else if(document.activeElement === last){
          event.preventDefault();
          first.focus();
        }
      }
    }

    function openEditPriceModal(item){
      if(!item) return;
      currentPriceEdit = { code:item.code, name:item.name, defaultPrice:parseFloat(item.price)||0 };
      const modal = document.getElementById('edit-price-modal');
      const title = document.getElementById('edit-price-title');
      const input = document.getElementById('edit-price-input');
      const resetBtn = document.getElementById('reset-price-button');
      const ticketSelect = document.getElementById('edit-ticket-color-select');
      if(title) title.innerText = `Edit Price — ${item.name}`;
      if(input){
        const price = getEffectivePriceFor(item);
        input.value = price.toFixed(2);
      }
      if(ticketSelect){
        let ticketValue = getOverrideTicketColorValue(item.code);
        if(ticketValue === null){
          ticketValue = getItemDefaultTicketColorValue(item);
        }
        ticketSelect.value = ticketValue || 'na';
      }
      if(resetBtn){
        resetBtn.style.display = hasMenuOverride(item.code) ? 'inline-block' : 'none';
      }
      lastFocusBeforePriceModal = document.activeElement;
      if(modal){
        modal.style.display='block';
        modal.removeEventListener('keydown', handleEditPriceModalKeydown);
        modal.addEventListener('keydown', handleEditPriceModalKeydown);
      }
      setTimeout(()=>{
        if(input) input.focus();
      }, 0);
    }

    function closeEditPriceModal(){
      const modal = document.getElementById('edit-price-modal');
      if(modal){
        modal.style.display='none';
        modal.removeEventListener('keydown', handleEditPriceModalKeydown);
      }
      currentPriceEdit = null;
      const input = document.getElementById('edit-price-input');
      if(input) input.value = '';
      const ticketSelect = document.getElementById('edit-ticket-color-select');
      if(ticketSelect) ticketSelect.value = 'na';
      if(lastFocusBeforePriceModal && typeof lastFocusBeforePriceModal.focus === 'function'){
        lastFocusBeforePriceModal.focus();
      }
      lastFocusBeforePriceModal = null;
    }

    function savePriceOverride(){
      if(!currentPriceEdit) return;
      const input = document.getElementById('edit-price-input');
      if(!input) return;
      const value = parseFloat(input.value);
      if(isNaN(value) || value < 0){
        alert('Please enter a valid price.');
        return;
      }
      const code = currentPriceEdit.code;
      const ticketSelect = document.getElementById('edit-ticket-color-select');
      const ticketColorValue = ticketSelect ? normalizeTicketColorValue(ticketSelect.value) : 'na';
      const payload = {
        price: round2(value),
        ticketColor: ticketColorValue || 'na'
      };
      db.ref(menuOverrideItemPath(code)).update(payload)
        .then(()=>{
          showPriceToast('Item updated.');
          closeEditPriceModal();
          updateOrderSummary();
          syncTicketCounters();
        })
        .catch(err=>{
          console.error('Unable to update item override', err);
          const message = err && err.message ? err.message : 'Please try again.';
          alert('Unable to Update Item: ' + message);
        });
    }

    function resetPriceOverride(){
      if(!currentPriceEdit) return;
      const code = currentPriceEdit.code;
      db.ref(menuOverrideItemPath(code)).remove()
        .then(()=>{
          showPriceToast('Item reset to default.');
          closeEditPriceModal();
          updateOrderSummary();
          syncTicketCounters();
        })
        .catch(err=>{
          console.error('Unable to reset item override', err);
          const message = err && err.message ? err.message : 'Please try again.';
          alert('Unable to reset item: ' + message);
        });
    }

    function showPriceToast(message){
      const toast = document.getElementById('price-toast');
      if(!toast) return;
      toast.textContent = message;
      toast.classList.add('show');
      if(priceToastTimeout) clearTimeout(priceToastTimeout);
      priceToastTimeout = setTimeout(()=>{
        toast.classList.remove('show');
      }, 2400);
    }

    function clearOrder(){
      total=0;
      orderList=[]; updateOrderSummary();
      syncTicketCounters();
      isTotalOverwritten=false;
      applyCustomerName('', { skipBroadcast:true });
      db.ref('currentOrder').remove();
    }

    /* ==========================
       Tabs + Day Subtabs
       ========================== */
    function switchTab(tab){
      const posView = document.querySelector('.container');
      const orderTrackingView = document.getElementById('order-tracking');
      const zelleView = document.getElementById('zelle-confirmations');
      const stockLogView = document.getElementById('stock-log');
      const analyticsView = document.getElementById('analytics');

      // reset all
      posView.style.display='none';
      orderTrackingView.style.display='none';
      if(zelleView) zelleView.style.display='none';
      analyticsView.style.display='none';
      if(stockLogView) stockLogView.style.display='none';

      document.getElementById('pos-tab-button').classList.remove('active');
      document.getElementById('order-tracking-tab-button').classList.remove('active');
      document.getElementById('zelle-tab-button').classList.remove('active');
      if(document.getElementById('stock-tab-button')) document.getElementById('stock-tab-button').classList.remove('active');
      document.getElementById('analytics-tab-button').classList.remove('active');

      if(tab==='POS'){
        posView.style.display='flex';
        document.getElementById('pos-tab-button').classList.add('active');
      }else if(tab==='Order Tracking'){
        orderTrackingView.style.display='block';
        document.getElementById('order-tracking-tab-button').classList.add('active');
        loadOrdersFromFirebase();
      }else if(tab==='Zelle'){
        if(zelleView){
          zelleView.style.display='block';
          document.getElementById('zelle-tab-button').classList.add('active');
          updateZelleAccountDisplay();
          attachZelleListener();
          attachZelleSwitchLogListener();
        }
      }else if(tab==='Stock Log'){
        if(stockLogView){
          stockLogView.style.display='block';
          document.getElementById('stock-tab-button').classList.add('active');
          loadStockLogFromFirebase();
        }
      }else{
        analyticsView.style.display='block';
        document.getElementById('analytics-tab-button').classList.add('active');
        generateAnalytics();
      }
    }

    function setDay(next){
      if(DAY===next) return;
      DAY = next;

      // Toggle active states in top bar
      document.getElementById('btn-day-sat').classList.toggle('active', DAY==='SAT');
      document.getElementById('btn-day-sun').classList.toggle('active', DAY==='SUN');

      // Toggle active states in subtabs, if present
      const otSat = document.getElementById('ot-sat'); if(otSat) otSat.classList.toggle('active', DAY==='SAT');
      const otSun = document.getElementById('ot-sun'); if(otSun) otSun.classList.toggle('active', DAY==='SUN');
      const anSat = document.getElementById('an-sat'); if(anSat) anSat.classList.toggle('active', DAY==='SAT');
      const anSun = document.getElementById('an-sun'); if(anSun) anSun.classList.toggle('active', DAY==='SUN');
      const slSat = document.getElementById('sl-sat'); if(slSat) slSat.classList.toggle('active', DAY==='SAT');
      const slSun = document.getElementById('sl-sun'); if(slSun) slSun.classList.toggle('active', DAY==='SUN');
      const zeSat = document.getElementById('ze-sat'); if(zeSat) zeSat.classList.toggle('active', DAY==='SAT');
      const zeSun = document.getElementById('ze-sun'); if(zeSun) zeSun.classList.toggle('active', DAY==='SUN');

      refreshMenuOverridesListener();
      refreshDisplayNameListener();
      orderNumber = 0;
      applyCustomerName('', { skipBroadcast:true });
      refreshOrderMetaUI();

      latestZelleAccountTotals = {};
      updateZelleAccountTotalsDisplay({});
      refreshZelleCurrentAccountListener();
      refreshZelleFeeListener();

      // Immediately rebuild the item grid for the new day
      initializeMenuItems();

      // Then load OOS map to update badges/buttons from Firebase
      loadOOSMap();

      // Refresh other views if currently visible
      if(document.getElementById('order-tracking').style.display==='block'){
        buildDynamicHeader();
        loadOrdersFromFirebase();
      }
      if(document.getElementById('zelle-confirmations') && document.getElementById('zelle-confirmations').style.display==='block'){
        attachZelleListener();
        attachZelleSwitchLogListener();
      }
      if(document.getElementById('analytics').style.display==='block'){ generateAnalytics(); }
      if(document.getElementById('stock-log') && document.getElementById('stock-log').style.display==='block'){ loadStockLogFromFirebase(); }
    }

    function switchDaySubtab(next, where){
      if(DAY===next) return;
      DAY = next;

      refreshMenuOverridesListener();
      refreshDisplayNameListener();
      orderNumber = 0;
      applyCustomerName('', { skipBroadcast:true });
      refreshOrderMetaUI();
      refreshZelleCurrentAccountListener();
      refreshZelleFeeListener();

      // Mark the active subtab
      if(where==='ot'){
        document.getElementById('ot-sat').classList.toggle('active', DAY==='SAT');
        document.getElementById('ot-sun').classList.toggle('active', DAY==='SUN');
        buildDynamicHeader();
        loadOrdersFromFirebase();
      }else if(where==='an'){
        document.getElementById('an-sat').classList.toggle('active', DAY==='SAT');
        document.getElementById('an-sun').classList.toggle('active', DAY==='SUN'); generateAnalytics();
      }else if(where==='sl'){
        document.getElementById('sl-sat').classList.toggle('active', DAY==='SAT');
        document.getElementById('sl-sun').classList.toggle('active', DAY==='SUN');
        loadStockLogFromFirebase();
      }else if(where==='ze'){
        document.getElementById('ze-sat').classList.toggle('active', DAY==='SAT');
        document.getElementById('ze-sun').classList.toggle('active', DAY==='SUN');
        latestZelleAccountTotals = {};
        updateZelleAccountTotalsDisplay({});
        refreshZelleCurrentAccountListener();
        attachZelleListener();
        attachZelleSwitchLogListener();
      }

      // Sync top bar buttons
      document.getElementById('btn-day-sat').classList.toggle('active', DAY==='SAT');
      document.getElementById('btn-day-sun').classList.toggle('active', DAY==='SUN');

      // Rebuild POS grid and refresh OOS state
      initializeMenuItems();
      loadOOSMap();
    }

    /* ==========================
       Analytics (per-day)
       ========================== */
    function generateAnalytics(){
      db.ref(ordersPath()).once('value',(snapshot)=>{
        const orders = snapshot.val() || {};
        const list = Object.values(orders);
        const grand = list.reduce((s,o)=>s + parseFloat(o.total||0), 0);
        document.getElementById('grand-total-sales').innerText = grand.toFixed(2);

        // Draw charts
        createSalesOverTimeChart(list);
        createBestSellingItemsChart(list);
        createPaymentMethodsChart(list);
        createOrdersOverTimeChart(list);
        createHourlySalesChart(list);
      });
    }

    // Reusable chart killer (avoid stacking multiple instances)
    const chartStore = {};
    function killChart(id){ if(chartStore[id]){ chartStore[id].destroy(); chartStore[id]=null; } }

    function createSalesOverTimeChart(orderList){
      const salesData = {};
      orderList.forEach(o=>{
        const date = new Date(o.timestamp || Date.now()).toLocaleDateString();
        const tot = parseFloat(o.total||0);
        salesData[date] = (salesData[date]||0) + tot;
      });
      const labels = Object.keys(salesData);
      const data = Object.values(salesData);

      const ctx = document.getElementById('sales-over-time-chart').getContext('2d');
      killChart('sales'); chartStore['sales'] = new Chart(ctx,{
        type:'line',
        data:{ labels, datasets:[{label:'Total Sales ($)', data, backgroundColor:'rgba(184,16,13,.2)', borderColor:'rgba(184,16,13,1)', borderWidth:2, fill:true}]},
        options:{ scales:{ x:{ title:{display:true,text:'Date'}}, y:{ title:{display:true,text:'Sales ($)'}, beginAtZero:true } } }
      });
    }

    function createBestSellingItemsChart(orderList){
      const itemsSold = {};
      orderList.forEach(o=>{
        (o.items||[]).forEach(it=>{
          const q = parseInt(it.quantity||0);
          itemsSold[it.name] = (itemsSold[it.name]||0) + q;
        });
      });
      const sorted = Object.entries(itemsSold).sort((a,b)=>b[1]-a[1]).slice(0,5);
      const labels = sorted.map(x=>x[0]);
      const data = sorted.map(x=>x[1]);

      const ctx = document.getElementById('best-selling-items-chart').getContext('2d');
      killChart('bestsell'); chartStore['bestsell'] = new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{label:'Units Sold', data, backgroundColor:'rgba(184,16,13,.6)', borderColor:'rgba(184,16,13,1)', borderWidth:1}]},
        options:{ scales:{ x:{ title:{display:true,text:'Items'}}, y:{ title:{display:true,text:'Units'}, beginAtZero:true } } }
      });
    }

    function createPaymentMethodsChart(orderList){
      const methods = {};
      orderList.forEach(o=>{
        const m = o.method || 'Unknown';
        methods[m] = (methods[m]||0)+1;
      });
      const labels = Object.keys(methods);
      const data = Object.values(methods);

      const ctx = document.getElementById('payment-methods-chart').getContext('2d');
      killChart('pay'); chartStore['pay'] = new Chart(ctx,{
        type:'pie',
        data:{ labels, datasets:[{label:'Payment Methods', data,
          backgroundColor:[
            'rgba(184,16,13,.6)','rgba(16,184,13,.6)','rgba(13,16,184,.6)','rgba(184,184,13,.6)','rgba(184,13,184,.6)'],
          borderColor:[
            'rgba(184,16,13,1)','rgba(16,184,13,1)','rgba(13,16,184,1)','rgba(184,184,13,1)','rgba(184,13,184,1)'],
          borderWidth:1}]},
        options:{responsive:true}
      });
    }

    function createOrdersOverTimeChart(orderList){
      const count = {};
      orderList.forEach(o=>{
        const d = new Date(o.timestamp || Date.now()).toLocaleDateString();
        count[d] = (count[d]||0)+1;
      });
      const labels = Object.keys(count);
      const data = Object.values(count);

      const ctx = document.getElementById('orders-over-time-chart').getContext('2d');
      killChart('orders'); chartStore['orders'] = new Chart(ctx,{
        type:'line',
        data:{ labels, datasets:[{label:'Number of Orders', data, backgroundColor:'rgba(16,184,13,.2)', borderColor:'rgba(16,184,13,1)', borderWidth:2, fill:true}]},
        options:{ scales:{ x:{ title:{display:true,text:'Date'}}, y:{ title:{display:true,text:'Orders'}, beginAtZero:true } } }
      });
    }

    function createHourlySalesChart(orderList){
      const hourly = {}; for(let i=0;i<24;i++) hourly[i]=0;
      orderList.forEach(o=>{
        const h = new Date(o.timestamp || Date.now()).getHours();
        hourly[h] += parseFloat(o.total||0);
      });
      const labels = Object.keys(hourly).map(h=>`${h}:00`);
      const data = Object.values(hourly);
      const ctx = document.getElementById('hourly-sales-chart').getContext('2d');
      killChart('hourly'); chartStore['hourly'] = new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{label:'Sales ($)', data, backgroundColor:'rgba(13,16,184,.6)', borderColor:'rgba(13,16,184,1)', borderWidth:1}]},
        options:{ scales:{ x:{ title:{display:true,text:'Hour'}}, y:{ title:{display:true,text:'Sales ($)'}, beginAtZero:true } } }
      });
    }

    /* ==========================
       Day Init + App Init
       ========================== */
    const editPriceModalEl = document.getElementById('edit-price-modal');
    if(editPriceModalEl){
      editPriceModalEl.addEventListener('click', event=>{
        if(event.target === editPriceModalEl) closeEditPriceModal();
      });
    }
    customerNameModalEl = document.getElementById('customer-name-modal');
    if(customerNameModalEl){
      customerNameModalEl.addEventListener('click', event=>{
        if(event.target === customerNameModalEl) closeCustomerNameModal();
      });
    }
    function initApp(){
      refreshMenuOverridesListener();
      refreshDisplayNameListener();
      initializeMenuItems();
      syncTicketCounters();
      refreshOrderMetaUI();
      setMode('POS');
      ensureZelleConfigSeeded();
      renderZelleAccountButtons();
      loadZelleConfig();
      refreshZelleCurrentAccountListener();
      refreshZelleFeeListener();
      loadOOSMap();
      loadOrdersFromFirebase();
    }
    initApp();

    /* ==========================
       Utilities
       ========================== */
    function escapeHTML(value){
      if(value === null || value === undefined) return '';
      return String(value)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function round2(x){ return Math.round((x + Number.EPSILON) * 100)/100; }
  </script>
</body>
</html>




